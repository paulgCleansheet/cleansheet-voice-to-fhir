<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-to-FHIR Demo | Cleansheet Medical</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Questrial&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            /* Colors */
            --color-primary-blue: #0066CC;
            --color-accent-blue: #004C99;
            --color-highlight: #11304f;
            --color-dark: #1a1a1a;
            --color-text: #333333;
            --color-text-secondary: #666666;
            --color-text-muted: #999999;
            --color-bg: #f5f5f7;
            --color-bg-light: #f8f8f8;
            --color-border: #e5e5e7;
            --color-white: #ffffff;

            /* Status Colors */
            --color-success: #16a34a;
            --color-success-bg: #dcfce7;
            --color-warning: #f59e0b;
            --color-warning-bg: #fef3c7;
            --color-error: #dc2626;
            --color-error-bg: #fef2f2;
            --color-info: #1565c0;
            --color-info-bg: #e3f2fd;

            /* Typography */
            --font-ui: 'Questrial', sans-serif;
            --font-body: 'Barlow', sans-serif;

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            font-weight: 300;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-ui);
            font-weight: 400;
        }

        /* Header */
        .header {
            background: var(--color-dark);
            color: var(--color-white);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 0.875rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-text-muted);
        }

        .status-dot.connected {
            background: var(--color-success);
        }

        .status-dot.error {
            background: var(--color-error);
        }

        /* Main Layout - 2 Column */
        .main-container {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            height: calc(100vh - 60px);
        }

        /* Left Column - Stacked Panels */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            min-height: 0;
            overflow: hidden;
        }

        .left-column .panel {
            flex: 0 0 auto;
        }

        .left-column .input-panel {
            flex: 0 0 auto;
        }

        .left-column .queue-panel {
            flex: 0 0 auto;
            min-height: 80px;
            overflow: hidden;
        }

        .left-column .queue-panel:not(.collapsed) {
            flex: 1 1 auto;
            max-height: 55%;
        }

        /* When EHR is collapsed, queue can take full remaining space */
        .left-column:has(.ehr-panel.collapsed) .queue-panel:not(.collapsed) {
            max-height: none;
        }

        .left-column .ehr-panel {
            flex: 0 0 auto;
            min-height: 100px;
            overflow: hidden;
        }

        .left-column .ehr-panel:not(.collapsed) {
            flex: 1 1 auto;
        }

        /* Collapsible Panels */
        .panel-header .collapse-toggle {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 2px 4px;
            display: flex;
            align-items: center;
            opacity: 0.6;
            transition: opacity 0.15s, transform 0.2s;
            flex-shrink: 0;
        }

        .input-panel .panel-header .collapse-toggle,
        .ehr-panel .panel-header .collapse-toggle {
            margin-left: auto;
        }

        .panel-header .collapse-toggle:hover {
            opacity: 1;
        }

        .panel.collapsed .collapse-toggle {
            transform: rotate(-90deg);
        }

        .panel.collapsed .panel-body,
        .panel.collapsed .panel-footer {
            display: none;
        }

        .panel.collapsed {
            flex: 0 0 auto !important;
            min-height: auto !important;
            max-height: none !important;
        }

        /* Panel Base */
        .panel {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: var(--color-dark);
            color: var(--color-white);
            padding: var(--spacing-sm) var(--spacing-md);
            font-family: var(--font-ui);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .panel-body {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
        }

        /* Input Panel - Compact */
        .input-panel .panel-body {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
        }

        .input-panel .panel-header {
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        /* Workflow Pills */
        .workflow-pills {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
        }

        .workflow-pill {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-family: var(--font-ui);
            background: var(--color-white);
            cursor: pointer;
            transition: all 0.15s;
            text-transform: capitalize;
        }

        .workflow-pill:hover {
            border-color: var(--color-primary-blue);
            background: var(--color-bg-light);
        }

        .workflow-pill.active {
            background: var(--color-primary-blue);
            color: var(--color-white);
            border-color: var(--color-primary-blue);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .form-group label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-select, .form-input {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 0.875rem;
            background: var(--color-white);
            cursor: pointer;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--color-primary-blue);
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
        }

        /* Record Button - Compact */
        .record-section {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs) 0;
        }

        .record-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--color-border);
            background: var(--color-white);
            color: var(--color-error);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .record-btn:hover {
            border-color: var(--color-error);
            transform: scale(1.05);
        }

        .record-btn.recording {
            border-color: var(--color-error);
            background: var(--color-error-bg);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        }

        .record-time {
            font-family: var(--font-ui);
            font-size: 1rem;
            color: var(--color-text-secondary);
            min-width: 45px;
        }

        /* Audio Visualizer - Compact */
        .audio-visualizer {
            flex: 1;
            height: 32px;
            background: var(--color-bg-light);
            border-radius: var(--radius-sm);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .visualizer-bar {
            width: 3px;
            height: 3px;
            background: var(--color-primary-blue);
            border-radius: 2px;
            transition: height 0.05s ease;
        }

        /* Upload Button - Compact */
        .upload-section {
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .upload-section:hover {
            border-color: var(--color-primary-blue);
            background: var(--color-bg-light);
        }

        .upload-section input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 1.25rem;
            color: var(--color-text-secondary);
        }

        .upload-text {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        /* Audio Preview */
        .audio-preview {
            display: none;
            flex-direction: column;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
        }

        .audio-preview.visible {
            display: flex;
        }

        .audio-preview audio {
            width: 100%;
            height: 36px;
        }

        .audio-filename {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        /* Add to Queue Button */
        .btn-primary {
            background: var(--color-primary-blue);
            color: var(--color-white);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-family: var(--font-ui);
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: background 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--color-accent-blue);
        }

        .btn-primary:disabled {
            background: var(--color-border);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--color-white);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-family: var(--font-ui);
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--color-bg-light);
            border-color: var(--color-text-secondary);
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--color-bg-light);
            color: var(--color-text);
        }

        /* Queue Panel - Compact */
        .queue-panel .panel-header {
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        .queue-panel .panel-body {
            padding: var(--spacing-sm);
            overflow-y: auto;
            flex: 1;
        }

        .queue-panel .panel-footer {
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        .queue-header-extra {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-left: auto;
            font-size: 0.75rem;
        }

        .progress-bar-container {
            width: 60px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--color-success);
            transition: width 0.3s ease;
        }

        .processing-toggle {
            font-size: 0.7rem;
            padding: var(--spacing-xs) 0;
            margin-bottom: var(--spacing-xs);
        }

        .queue-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--color-bg-light);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            transition: background-color 0.15s, border-color 0.15s;
            border: 1px solid transparent;
        }

        .queue-item.done {
            cursor: pointer;
        }

        .queue-item.done:hover {
            background: var(--color-success-bg, #dcfce7);
            border-color: var(--color-success);
        }

        .queue-item.selected {
            background: var(--color-primary-bg, #e0f2fe);
            border-color: var(--color-primary-blue);
        }

        .queue-item-status {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .queue-item-status.pending { color: var(--color-text-muted); }
        .queue-item-status.processing { color: var(--color-info); }
        .queue-item-status.done { color: var(--color-success); }
        .queue-item-status.error { color: var(--color-error); }

        .queue-item-info {
            flex: 1;
            min-width: 0;
            line-height: 1.3;
        }

        .queue-item-workflow {
            font-weight: 500;
            color: var(--color-text);
        }

        .queue-item-meta {
            font-size: 0.65rem;
            color: var(--color-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-actions {
            display: flex;
            gap: 2px;
        }

        .queue-item-actions .btn-icon {
            padding: 2px;
            font-size: 0.75rem;
        }

        /* Mock EHR Panel - Compact */
        .ehr-panel .panel-header {
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        .ehr-panel .panel-body {
            padding: var(--spacing-sm);
        }

        .ehr-panel .panel-footer {
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        .mock-ehr-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .mock-ehr-item {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
        }

        .mock-ehr-empty {
            text-align: center;
            padding: var(--spacing-md);
            color: var(--color-text-muted);
            font-size: 0.75rem;
        }

        .mock-ehr-empty i {
            font-size: 1.5rem;
            margin-bottom: var(--spacing-xs);
            display: block;
        }

        .queue-empty {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--color-text-muted);
        }

        /* Processing Toggle */
        .processing-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: var(--color-border);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .toggle-switch.active {
            background: var(--color-primary-blue);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: var(--color-white);
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        /* Review Panel */
        .review-tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border);
        }

        .review-tab {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: none;
            font-family: var(--font-ui);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .review-tab:hover {
            background: var(--color-bg-light);
        }

        .review-tab.active {
            color: var(--color-primary-blue);
            border-bottom-color: var(--color-primary-blue);
        }

        .review-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        .review-content.active {
            display: block;
        }

        /* Clinical Notes Tab */
        .note-section {
            margin-bottom: var(--spacing-md);
        }

        .note-section-header {
            font-family: var(--font-ui);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-primary-blue);
            margin-bottom: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .note-section-header .section-title {
            flex: 1;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .field-rerecord-btn {
            width: 24px;
            height: 24px;
            padding: 0;
            border: none;
            border-radius: 50%;
            background: var(--color-bg-light);
            color: var(--color-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            opacity: 0.6;
        }

        .field-rerecord-btn:hover {
            background: var(--color-primary-blue);
            color: white;
            opacity: 1;
        }

        .field-rerecord-btn.recording {
            background: var(--color-error);
            color: white;
            opacity: 1;
            animation: pulse-record 1s infinite;
        }

        .field-rerecord-btn.transcribing {
            background: var(--color-warning);
            color: white;
            opacity: 1;
            pointer-events: none;
        }

        .field-rerecord-btn.transcribing i {
            animation: spin 1s linear infinite;
        }

        @keyframes pulse-record {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .note-section-content.recording-active {
            border-color: var(--color-error);
            background: #fff5f5;
        }

        .note-section-content.transcribing {
            border-color: var(--color-warning);
            background: #fffbeb;
        }

        .note-section-content {
            padding: var(--spacing-sm);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            min-height: 60px;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .note-section-content:focus {
            outline: none;
            border-color: var(--color-primary-blue);
            background: var(--color-white);
        }

        .transcript-panel {
            background: var(--color-highlight);
            color: var(--color-white);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
        }

        .transcript-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            cursor: pointer;
            user-select: none;
        }

        .transcript-header .toggle-icon {
            transition: transform 0.2s ease;
        }

        .transcript-panel.collapsed .transcript-header .toggle-icon {
            transform: rotate(-90deg);
        }

        .transcript-panel.collapsed .transcript-text {
            display: none;
        }

        .transcript-header-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .transcript-text {
            font-size: 0.875rem;
            line-height: 1.6;
            max-height: 150px;
            overflow-y: auto;
        }

        .transcript-text .section-marker {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 4px 2px;
        }

        .transcript-text .clinical-term {
            color: #90caf9;
            font-weight: 500;
        }

        .transcript-text .measurement {
            color: #a5d6a7;
            font-family: 'Consolas', 'Monaco', monospace;
            font-weight: 500;
        }

        /* EHR Data Tab - 3 Column Grid */
        #ehrCategories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            align-items: start;
        }

        @media (max-width: 1400px) {
            #ehrCategories {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            #ehrCategories {
                grid-template-columns: 1fr;
            }
        }

        .ehr-category {
            margin-bottom: 0;
        }

        .ehr-category-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--color-dark);
            color: var(--color-white);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            font-family: var(--font-ui);
            font-size: 0.875rem;
        }

        .ehr-category-count {
            margin-left: auto;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .ehr-items {
            border: 1px solid var(--color-border);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .ehr-item {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }

        .ehr-item:last-child {
            border-bottom: none;
        }

        .ehr-item-content {
            flex: 1;
        }

        .ehr-item-name {
            font-weight: 500;
            color: var(--color-text);
        }

        .ehr-item-detail {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        .ehr-item-code {
            font-size: 0.75rem;
            color: var(--color-primary-blue);
            font-family: monospace;
        }

        .ehr-item-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .ehr-item.approved {
            background: var(--color-success-bg);
        }

        .ehr-item.rejected {
            background: var(--color-error-bg);
            opacity: 0.6;
        }

        .ehr-item-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .ehr-measurement {
            font-family: 'Consolas', 'Monaco', monospace;
            font-weight: 600;
            color: var(--color-text);
        }

        .ehr-unit {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        .ehr-icd10-code {
            display: inline-block;
            background: var(--color-primary-blue);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .ehr-status-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .ehr-status-badge.active {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .ehr-status-badge.resolved {
            background: var(--color-bg-light);
            color: var(--color-text-secondary);
        }

        .ehr-status-badge.chronic {
            background: #e3f2fd;
            color: #1565c0;
        }

        .ehr-severity-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .ehr-severity-badge.mild {
            background: #fff3e0;
            color: #e65100;
        }

        .ehr-severity-badge.moderate {
            background: #ffecb3;
            color: #ff6f00;
        }

        .ehr-severity-badge.severe {
            background: var(--color-error-bg);
            color: var(--color-error);
        }

        .ehr-interpretation-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .ehr-interpretation-badge.normal {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .ehr-interpretation-badge.abnormal,
        .ehr-interpretation-badge.high,
        .ehr-interpretation-badge.low {
            background: #fff3e0;
            color: #e65100;
        }

        .ehr-interpretation-badge.critical {
            background: var(--color-error-bg);
            color: var(--color-error);
        }

        .ehr-age-onset {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-style: italic;
        }

        /* Data Action Bar */
        .data-action-bar {
            display: flex;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) 0;
            margin-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--color-border);
        }

        .data-action-bar .btn-secondary {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
        }

        /* Add EHR Item Modal */
        .input-method-toggle {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--color-bg-light);
            padding: 4px;
            border-radius: var(--radius-md);
        }

        .input-method-btn {
            flex: 1;
            padding: var(--spacing-sm);
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            transition: all 0.15s ease;
        }

        .input-method-btn:hover {
            color: var(--color-text);
        }

        .input-method-btn.active {
            background: var(--color-white);
            color: var(--color-primary-blue);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Pill Selector (touch-friendly type selection) */
        .pill-selector {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
        }

        .pill-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            background: var(--color-white);
            color: var(--color-text-secondary);
            border-radius: 20px;
            font-size: 0.85rem;
            font-family: var(--font-ui);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .pill-btn:hover {
            border-color: var(--color-primary-blue);
            color: var(--color-text);
        }

        .pill-btn.active {
            background: var(--color-primary-blue);
            border-color: var(--color-primary-blue);
            color: var(--color-white);
        }

        .pill-btn i {
            font-size: 1rem;
        }

        .add-ehr-voice-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-sm);
        }

        .voice-input-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
        }

        .voice-input-status i {
            font-size: 1.25rem;
        }

        .record-btn-small {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: var(--color-primary-blue);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.15s ease;
        }

        .record-btn-small:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        .record-btn-small.recording {
            background: var(--color-error);
            animation: pulse-record 1s infinite;
        }

        .record-btn-small.transcribing {
            background: var(--color-warning);
            pointer-events: none;
        }

        .record-btn-small.transcribing i {
            animation: spin 1s linear infinite;
        }

        .voice-input-result {
            width: 100%;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
        }

        .voice-result-text {
            flex: 1;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--color-text);
        }

        .add-ehr-text-input {
            margin-top: var(--spacing-sm);
        }

        .add-ehr-text-input .form-group {
            margin-bottom: var(--spacing-sm);
        }

        .add-ehr-text-input label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .add-ehr-text-input input,
        .add-ehr-text-input select {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        .add-ehr-text-input input:focus,
        .add-ehr-text-input select:focus {
            outline: none;
            border-color: var(--color-primary-blue);
        }

        .form-row {
            display: flex;
            gap: var(--spacing-sm);
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Orders Tab - 3 Column Grid */
        #ordersList {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            align-items: start;
        }

        @media (max-width: 1400px) {
            #ordersList {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            #ordersList {
                grid-template-columns: 1fr;
            }
        }

        .order-card {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            margin-bottom: 0;
            overflow: hidden;
        }

        .order-card-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-light);
            border-bottom: 1px solid var(--color-border);
        }

        .order-type-badge {
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .order-type-badge.medication {
            background: var(--color-info-bg);
            color: var(--color-info);
        }

        .order-type-badge.lab {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .order-type-badge.consult {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .order-type-badge.procedure {
            background: var(--color-error-bg);
            color: var(--color-error);
        }

        .order-card-body {
            padding: var(--spacing-md);
        }

        .order-detail {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            font-size: 0.875rem;
        }

        .order-detail-label {
            color: var(--color-text-secondary);
            min-width: 80px;
        }

        .order-card-actions {
            display: flex;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-light);
            border-top: 1px solid var(--color-border);
        }

        .order-card.approved {
            border-color: var(--color-success);
        }

        .order-card.approved .order-card-header {
            background: var(--color-success-bg);
        }

        .order-card.rejected {
            border-color: var(--color-error);
            opacity: 0.6;
        }

        .order-card.rejected .order-card-header {
            background: var(--color-error-bg);
        }

        /* Unmatched medication orders (RxNorm not verified) */
        .order-card.unmatched {
            border-color: var(--color-warning);
        }

        .order-card.unmatched .order-card-header {
            background: var(--color-warning-bg);
        }

        .rxnorm-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
        }

        .rxnorm-status.verified {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .rxnorm-status.unverified {
            background: var(--color-warning-bg);
            color: #b45309;
        }

        .unmatched-alert {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--color-warning-bg);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.8rem;
            color: #b45309;
        }

        .unmatched-alert i {
            font-size: 1rem;
        }

        /* Linked diagnosis chip on order cards */
        .linked-diagnosis {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--color-info-bg);
            color: var(--color-info);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            margin-top: var(--spacing-xs);
        }

        .linked-diagnosis code {
            font-family: monospace;
            font-weight: 500;
        }

        /* Diagnosis Link Section in Order Cards */
        .diagnosis-link-section {
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--color-border);
        }

        .diagnosis-link-section .btn-link {
            background: none;
            border: none;
            color: var(--color-primary-blue);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0;
            margin-left: var(--spacing-sm);
        }

        .diagnosis-link-section .btn-link:hover {
            text-decoration: underline;
        }

        .diagnosis-link-section.unlinked {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .unlinked-warning {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--color-text-muted);
            font-size: 0.8rem;
        }

        .unlinked-warning i {
            color: #b45309;
        }

        /* Diagnosis Options List in Modal */
        .diagnosis-options-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            max-height: 300px;
            overflow-y: auto;
        }

        .diagnosis-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-light);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-align: left;
            width: 100%;
            transition: all 0.15s ease;
        }

        .diagnosis-option:hover {
            background: var(--color-primary-blue);
            color: white;
            border-color: var(--color-primary-blue);
        }

        .diagnosis-option:hover .icd10-code {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .diagnosis-option:hover .condition-name {
            color: white;
        }

        .diagnosis-option:hover .status-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .diagnosis-option:hover .icd10-code.empty {
            color: rgba(255,255,255,0.7);
        }

        .diagnosis-option .icd10-code {
            font-family: monospace;
            font-size: 0.75rem;
            padding: 2px 6px;
            background: var(--color-bg-white);
            border-radius: var(--radius-xs);
            min-width: 60px;
            text-align: center;
            color: var(--color-text);
        }

        .diagnosis-option .icd10-code.empty {
            color: var(--color-text-muted);
        }

        .diagnosis-option .condition-name {
            flex: 1;
            color: var(--color-text);
        }

        .diagnosis-option .status-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: var(--radius-xs);
            background: var(--color-bg-white);
            color: var(--color-text-muted);
        }

        .diagnosis-option .status-badge.resolved {
            color: var(--color-success);
        }

        .diagnosis-option:hover .status-badge.resolved {
            color: #86efac;
        }

        .diagnosis-option.create-new {
            background: transparent;
            border-style: dashed;
            color: var(--color-primary-blue);
        }

        .diagnosis-option.create-new:hover {
            background: var(--color-primary-bg, #e0f2fe);
            color: var(--color-primary-blue);
            border-color: var(--color-primary-blue);
        }

        .diagnosis-option.create-new i {
            font-size: 1.25rem;
        }

        .diagnosis-drop-zone {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg-light);
            transition: all 0.2s ease;
        }

        .diagnosis-drop-zone.drag-over {
            border-color: var(--color-primary-blue);
            background: rgba(0, 102, 204, 0.05);
        }

        .diagnosis-drop-zone-header {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .condition-drop-target {
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .condition-drop-target:hover,
        .condition-drop-target.drag-over {
            border-color: var(--color-primary-blue);
            background: var(--color-info-bg);
        }

        .condition-drop-target code {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        .drag-hint {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* Autocomplete Component */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .autocomplete-list.visible {
            display: block;
        }

        .autocomplete-item {
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-sm);
            font-size: 0.875rem;
            transition: background 0.15s ease;
        }

        .autocomplete-item:hover,
        .autocomplete-item.highlighted {
            background: var(--color-bg-light);
        }

        .autocomplete-item-name {
            flex: 1;
        }

        .autocomplete-item-code {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--color-text-muted);
            padding: 2px 6px;
            background: var(--color-bg-light);
            border-radius: var(--radius-sm);
        }

        .autocomplete-item-class {
            font-size: 0.7rem;
            color: var(--color-text-muted);
        }

        .autocomplete-no-results {
            padding: var(--spacing-md);
            text-align: center;
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }

        /* Mock EHR Panel */
        .mock-ehr-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .mock-ehr-item {
            padding: var(--spacing-sm);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--color-success);
        }

        .mock-ehr-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-xs);
        }

        .mock-ehr-item-workflow {
            font-weight: 500;
            font-size: 0.875rem;
        }

        .mock-ehr-item-time {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        .mock-ehr-item-stats {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        .mock-ehr-empty {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--color-text-muted);
        }

        .panel-footer {
            padding: var(--spacing-sm) var(--spacing-md);
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Review Pool Header */
        .review-pool-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .review-item-select {
            flex: 1;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            color: var(--color-text-muted);
            text-align: center;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        /* Spinning animation for processing */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        /* Metrics Display */
        .metrics-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
        }

        .metric-label {
            color: var(--color-text-secondary);
        }

        .metric-value {
            font-weight: 500;
            font-family: monospace;
        }

        /* Notification toast */
        .toast {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--color-dark);
            color: var(--color-white);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--color-success);
        }

        .toast.error {
            background: var(--color-error);
        }

        .toast.info {
            background: var(--color-info);
        }

        /* Settings Modal */
        .settings-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.3);
            color: var(--color-white);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-family: var(--font-ui);
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            transition: all 0.2s ease;
        }

        .settings-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }

        .settings-btn.configured {
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 24px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.2s ease;
        }

        .modal-overlay.visible .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h2 {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-body {
            padding: var(--spacing-md);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            border-top: 1px solid var(--color-border);
        }

        /* Ground Truth Modal Styles */
        .ground-truth-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
        }

        .ground-truth-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .ground-truth-item:last-child {
            border-bottom: none;
        }

        .ground-truth-item:hover {
            background: var(--color-bg-light);
        }

        .ground-truth-item-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--color-primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .ground-truth-item-info {
            flex: 1;
            min-width: 0;
        }

        .ground-truth-item-title {
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: 2px;
        }

        .ground-truth-item-meta {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            display: flex;
            gap: var(--spacing-md);
        }

        .ground-truth-item-stats {
            display: flex;
            gap: var(--spacing-sm);
            flex-shrink: 0;
        }

        .ground-truth-stat {
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--color-bg-light);
            color: var(--color-text-secondary);
        }

        .ground-truth-stat.conditions {
            background: var(--color-info-bg);
            color: var(--color-info);
        }

        .ground-truth-stat.medications {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .ground-truth-stat.vitals {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .ground-truth-stat.orders {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xl);
            color: var(--color-text-secondary);
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* About Modal / Interactive Pipeline Styles */
        .about-modal {
            max-width: 1000px;
            width: 90vw;
            max-height: 90vh;
        }

        .about-modal .modal-header h2 {
            font-size: 1.5rem;
        }

        .about-modal .modal-body {
            padding: var(--spacing-lg);
        }

        .pipeline-container {
            position: relative;
        }

        /* Philosophy Header */
        .pipeline-philosophy {
            text-align: center;
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--spacing-lg);
        }

        .pipeline-philosophy h3 {
            font-size: 1.5rem;
            margin: 0 0 var(--spacing-sm);
            color: var(--color-text);
        }

        .pipeline-philosophy p {
            font-size: 1.1rem;
            color: var(--color-text-secondary);
            margin: 0 0 var(--spacing-md);
            line-height: 1.6;
        }

        .philosophy-legend {
            display: flex;
            justify-content: center;
            gap: var(--spacing-lg);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 1rem;
            color: var(--color-text-secondary);
        }

        .philosophy-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .philosophy-icon.ai {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
        }

        .philosophy-icon.deterministic {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .philosophy-icon.human {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        /* Pipeline Flow */
        .pipeline-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-lg) 0;
            overflow-x: auto;
        }

        .pipeline-endpoint {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: var(--spacing-md);
            color: var(--color-text-secondary);
        }

        .pipeline-endpoint i {
            font-size: 2rem;
        }

        .pipeline-endpoint span {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .pipeline-endpoint.start i {
            color: var(--color-primary-blue);
        }

        .pipeline-endpoint.end i {
            color: var(--color-success);
        }

        .pipeline-arrow {
            color: var(--color-border);
            font-size: 1.25rem;
        }

        /* Pipeline Nodes */
        .pipeline-node {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--color-bg-light);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .pipeline-node:hover {
            border-color: var(--color-primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .pipeline-node.active {
            border-color: var(--color-primary-blue);
            background: white;
        }

        .node-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.7rem;
            color: white;
        }

        .node-badge.ai {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        }

        .node-badge.deterministic {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .node-badge.human {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .node-icon {
            font-size: 2rem;
            color: var(--color-text);
        }

        .node-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .node-hint {
            font-size: 0.7rem;
            color: var(--color-text-secondary);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .pipeline-node:hover .node-hint {
            opacity: 1;
        }

        /* Pipeline Popup */
        .pipeline-popup {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 600px;
            z-index: 10;
            animation: popupFadeIn 0.2s ease;
            align-items: center;
            gap: var(--spacing-md);
        }

        .pipeline-popup.visible {
            display: flex;
        }

        @keyframes popupFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .popup-nav {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: white;
            color: var(--color-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .popup-nav:hover:not(:disabled) {
            background: var(--color-primary-blue);
            color: white;
            transform: scale(1.1);
        }

        .popup-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .popup-main {
            flex: 1;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
        }

        .popup-header h4 {
            margin: 0;
            font-size: 1.15rem;
            color: var(--color-text);
        }

        .popup-content {
            padding: var(--spacing-lg);
            font-size: 0.95rem;
            max-height: 340px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .popup-content p {
            margin: 0 0 var(--spacing-sm);
            color: var(--color-text-secondary);
        }

        .popup-content strong {
            color: var(--color-text);
        }

        .popup-footer {
            padding: var(--spacing-sm) var(--spacing-lg);
            border-top: 1px solid var(--color-border);
            text-align: center;
        }

        .popup-counter {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }

        /* Popup Content Grids */
        .popup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .popup-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: var(--spacing-md);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            gap: 6px;
        }

        .popup-card i {
            font-size: 1.5rem;
            color: var(--color-primary-blue);
        }

        .popup-card strong {
            font-size: 0.9rem;
        }

        .popup-card span {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        .popup-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .popup-list-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .popup-list-item i {
            color: var(--color-primary-blue);
            font-size: 1.1rem;
        }

        .popup-badges {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .popup-badge {
            padding: 4px 10px;
            background: var(--color-highlight);
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* About Footer */
        .about-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            padding-top: var(--spacing-md);
        }

        .footer-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 0.95rem;
            color: var(--color-text-secondary);
        }

        .footer-info a {
            color: var(--color-primary-blue);
            font-size: 1.25rem;
        }

        .footer-info a:hover {
            color: var(--color-accent-blue);
        }

        .kaggle-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, #20beff, #0066cc);
            color: white;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
        }

        .kaggle-badge i {
            font-size: 1.15rem;
        }

        /* Slideshow Navigation (kept for API guide) */
        .slideshow-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            padding: var(--spacing-sm) 0;
            border-top: 1px solid var(--color-border);
        }

        .slide-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--color-border);
            background: white;
            color: var(--color-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.15s ease;
        }

        .slide-nav-btn:hover:not(:disabled) {
            background: var(--color-primary-blue);
            border-color: var(--color-primary-blue);
            color: white;
        }

        .slide-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .slide-dots {
            display: flex;
            gap: var(--spacing-xs);
        }

        .slide-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-border);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .slide-dot:hover {
            background: var(--color-text-secondary);
        }

        .slide-dot.active {
            background: var(--color-primary-blue);
            width: 24px;
            border-radius: 4px;
        }

        .slide-counter {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin-right: auto;
        }

        /* API Guide Modal Styles */
        .api-guide-modal {
            max-width: 700px;
            max-height: 90vh;
        }

        .api-slideshow {
            min-height: 460px;
        }

        .api-slide {
            display: none;
            animation: fadeIn 0.3s ease;
            padding: var(--spacing-sm) 0;
        }

        .api-slide.active {
            display: block;
        }

        .api-overview-grid {
            display: flex;
            justify-content: center;
            gap: var(--spacing-lg);
            margin: var(--spacing-md) 0;
        }

        .api-stat {
            text-align: center;
        }

        .api-stat .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary-blue);
        }

        .api-stat .stat-label {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        .api-base-url {
            text-align: center;
            padding: var(--spacing-sm);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
        }

        .api-base-url code {
            font-size: 0.8rem;
            color: var(--color-text);
        }

        .api-endpoints-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .api-endpoint {
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
        }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
        }

        .http-method {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .http-method.get {
            background: #10b981;
            color: white;
        }

        .http-method.post {
            background: #3b82f6;
            color: white;
        }

        .endpoint-header code {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .api-endpoint > p {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin: 0 0 var(--spacing-xs);
        }

        .endpoint-response {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        .endpoint-response pre {
            background: var(--color-bg);
            padding: var(--spacing-xs);
            border-radius: 4px;
            font-size: 0.7rem;
            margin-top: var(--spacing-xs);
            overflow-x: auto;
        }

        .endpoint-params {
            font-size: 0.75rem;
        }

        .endpoint-params strong {
            display: block;
            color: var(--color-text);
            margin-top: var(--spacing-xs);
        }

        .endpoint-params ul {
            margin: var(--spacing-xs) 0 0 var(--spacing-md);
            padding: 0;
        }

        .endpoint-params li {
            color: var(--color-text-secondary);
            margin-bottom: 2px;
        }

        .endpoint-params code {
            background: var(--color-bg);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .endpoint-params pre {
            background: var(--color-bg);
            padding: var(--spacing-xs);
            border-radius: 4px;
            font-size: 0.65rem;
            margin: var(--spacing-xs) 0;
            overflow-x: auto;
        }

        .severity-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 4px;
        }

        .severity-badge.critical {
            background: #fef2f2;
            color: #dc2626;
        }

        .severity-badge.warning {
            background: #fef3c7;
            color: #d97706;
        }

        .severity-badge.info {
            background: #e0f2fe;
            color: #0284c7;
        }

        .api-response-example {
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
        }

        .api-response-example pre {
            font-size: 0.65rem;
            line-height: 1.4;
            margin: 0;
            overflow-x: auto;
        }

        .quickstart-steps {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            text-align: left;
        }

        .quickstart-step {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
            background: var(--color-bg-light);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
        }

        .quickstart-step .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .quickstart-step strong {
            display: block;
            font-size: 0.8rem;
            color: var(--color-text);
            margin-bottom: 2px;
        }

        .quickstart-step code {
            display: block;
            font-size: 0.7rem;
            color: var(--color-text-secondary);
            background: var(--color-bg);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .quickstart-note {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: #e0f2fe;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            color: #0369a1;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-xs);
            text-align: left;
        }

        .quickstart-note i {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .quickstart-note code {
            background: rgba(255,255,255,0.5);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.65rem;
        }

        .setting-group {
            margin-bottom: var(--spacing-md);
        }

        .setting-group:last-child {
            margin-bottom: 0;
        }

        .setting-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            color: var(--color-text);
        }

        .setting-description {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .setting-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 0.875rem;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--color-primary-blue);
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
        }

        .setting-input.error {
            border-color: var(--color-error);
        }

        .token-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.75rem;
            margin-top: var(--spacing-xs);
        }

        .token-status.valid {
            color: var(--color-success);
        }

        .token-status.invalid {
            color: var(--color-error);
        }

        .token-status.checking {
            color: var(--color-text-secondary);
        }

        .endpoint-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.75rem;
            margin-top: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }

        .endpoint-status.running {
            color: var(--color-success);
            background: var(--color-success-bg);
        }

        .endpoint-status.paused {
            color: var(--color-warning);
            background: var(--color-warning-bg);
        }

        .endpoint-status.error {
            color: var(--color-error);
            background: var(--color-error-bg);
        }

        .endpoint-status.checking {
            color: var(--color-text-secondary);
            background: var(--color-bg-light);
        }

        .header-endpoint-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.75rem;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.1);
        }

        .header-endpoint-status.running {
            background: rgba(22, 163, 74, 0.2);
            color: #4ade80;
        }

        .header-endpoint-status.paused {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .header-endpoint-status.offline {
            background: rgba(220, 38, 38, 0.2);
            color: #f87171;
        }

        /* Responsive - Left column stays fixed, right column squeezes */
        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 320px 1fr;
            }
        }

        @media (max-width: 1000px) {
            .main-container {
                grid-template-columns: 300px 1fr;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm);
            }
        }

        @media (max-width: 800px) {
            .main-container {
                grid-template-columns: 280px 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>
            <i class="ph ph-microphone"></i>
            Voice-to-FHIR Demo
        </h1>
        <div class="header-status">
            <div class="header-endpoint-status" id="headerEndpointStatus" style="display: none;">
                <i class="ph ph-cloud"></i>
                <span id="headerEndpointText">MedGemma</span>
            </div>
            <button class="settings-btn" id="exportBtn" title="Export all data">
                <i class="ph ph-export"></i>
                Export
            </button>
            <button class="settings-btn" id="importBtn" title="Import saved data">
                <i class="ph ph-download-simple"></i>
                Import
            </button>
            <input type="file" id="importFileInput" accept=".json" style="display: none;">
            <button class="settings-btn" id="groundTruthBtn" title="Load ground truth demo data">
                <i class="ph ph-database"></i>
                Ground Truth
            </button>
            <button class="settings-btn" id="aboutBtn">
                <i class="ph ph-info"></i>
                About
            </button>
            <button class="settings-btn" id="architectureBtn" onclick="window.open('../doc/reference-architecture.html', '_blank')">
                <i class="ph ph-blueprint"></i>
                Architecture
            </button>
            <button class="settings-btn" id="apiGuideBtn" onclick="window.open('../doc/api.html', '_blank')">
                <i class="ph ph-code"></i>
                API
            </button>
            <button class="settings-btn" id="settingsBtn">
                <i class="ph ph-gear"></i>
                Settings
            </button>
            <div class="status-indicator">
                <span class="status-dot" id="apiStatus"></span>
                <span id="apiStatusText">Connecting...</span>
            </div>
        </div>
    </header>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="ph ph-gear"></i> Settings</h2>
                <button class="btn-icon" id="closeSettingsBtn">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label class="setting-label">HuggingFace API Token</label>
                    <div class="setting-description">
                        Required for MedGemma extraction. Get your token from
                        <a href="https://huggingface.co/settings/tokens" target="_blank">huggingface.co/settings/tokens</a>
                    </div>
                    <input type="password" class="setting-input" id="hfTokenInput"
                           placeholder="hf_xxxxxxxxxxxxxxxxxxxx">
                    <div class="token-status" id="tokenStatus"></div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">API Endpoint</label>
                    <div class="setting-description">
                        Voice-to-FHIR server URL (default: http://localhost:8001)
                    </div>
                    <input type="text" class="setting-input" id="apiUrlInput"
                           placeholder="http://localhost:8001">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Transcription Backend</label>
                    <div class="setting-description">
                        Choose between local MedASR or cloud Whisper
                    </div>
                    <select class="form-select" id="transcriptionBackendSelect" style="width: 100%;">
                        <option value="local">MedASR (Local) - Recommended</option>
                        <option value="whisper">Whisper (Cloud)</option>
                        <option value="dedicated">Dedicated Endpoint</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">MedGemma Endpoint URL</label>
                    <div class="setting-description">
                        Custom HuggingFace Inference Endpoint for MedGemma
                    </div>
                    <input type="text" class="setting-input" id="medgemmaEndpointInput"
                           placeholder="https://xxxxx.us-east-1.aws.endpoints.huggingface.cloud">
                    <div class="endpoint-status" id="endpointStatus"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="clearSettingsBtn">
                    <i class="ph ph-trash"></i> Clear All
                </button>
                <button class="btn-primary" id="saveSettingsBtn">
                    <i class="ph ph-check"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- About Modal (Interactive Pipeline) -->
    <!-- Ground Truth Modal -->
    <div class="modal-overlay" id="groundTruthModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2><i class="ph ph-database"></i> Load Ground Truth</h2>
                <button class="btn-icon" onclick="closeGroundTruthModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--color-text-secondary);">
                    Select a pre-validated recording to load into the review panel. Ground truth data has been SME-reviewed and can be used for demonstration or accuracy comparison.
                </p>
                <div id="groundTruthList" class="ground-truth-list">
                    <div class="loading-spinner">
                        <i class="ph ph-spinner spinning"></i>
                        Loading ground truth data...
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-top: 1px solid var(--color-border);">
                <div class="ground-truth-stats" id="groundTruthStats" style="color: var(--color-text-secondary); font-size: 13px;"></div>
                <button class="btn btn-secondary" onclick="closeGroundTruthModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="aboutModal">
        <div class="modal about-modal">
            <div class="modal-header">
                <h2><i class="ph ph-flow-arrow"></i> Voice-to-FHIR Pipeline</h2>
                <button class="btn-icon" onclick="closeAboutModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body pipeline-container">
                <!-- Philosophy Header -->
                <div class="pipeline-philosophy">
                    <h3>Best Tool for Each Task</h3>
                    <p>We choose the <strong>best method available</strong> for each step - not dogmatically aligning to AI or deterministic approaches.</p>
                    <div class="philosophy-legend">
                        <div class="legend-item">
                            <div class="philosophy-icon ai">AI</div>
                            <span>AI excels</span>
                        </div>
                        <div class="legend-item">
                            <div class="philosophy-icon deterministic">D</div>
                            <span>Deterministic wins</span>
                        </div>
                        <div class="legend-item">
                            <div class="philosophy-icon human">H</div>
                            <span>Humans essential</span>
                        </div>
                    </div>
                </div>

                <!-- Interactive Pipeline -->
                <div class="pipeline-flow">
                    <!-- Voice Input -->
                    <div class="pipeline-endpoint start">
                        <i class="ph ph-microphone"></i>
                        <span>Voice</span>
                    </div>
                    <div class="pipeline-arrow"><i class="ph ph-arrow-right"></i></div>

                    <!-- MedASR Node -->
                    <div class="pipeline-node" data-node="medasr" onclick="showPipelinePopup('medasr')">
                        <div class="node-badge ai">AI</div>
                        <div class="node-icon"><i class="ph ph-waveform"></i></div>
                        <div class="node-label">MedASR</div>
                        <div class="node-hint">Click for details</div>
                    </div>
                    <div class="pipeline-arrow"><i class="ph ph-arrow-right"></i></div>

                    <!-- MedGemma Node -->
                    <div class="pipeline-node" data-node="medgemma" onclick="showPipelinePopup('medgemma')">
                        <div class="node-badge ai">AI</div>
                        <div class="node-icon"><i class="ph ph-brain"></i></div>
                        <div class="node-label">MedGemma</div>
                        <div class="node-hint">Click for details</div>
                    </div>
                    <div class="pipeline-arrow"><i class="ph ph-arrow-right"></i></div>

                    <!-- Deterministic Node -->
                    <div class="pipeline-node" data-node="deterministic" onclick="showPipelinePopup('deterministic')">
                        <div class="node-badge deterministic">D</div>
                        <div class="node-icon"><i class="ph ph-code"></i></div>
                        <div class="node-label">Enhancement</div>
                        <div class="node-hint">Click for details</div>
                    </div>
                    <div class="pipeline-arrow"><i class="ph ph-arrow-right"></i></div>

                    <!-- Clinician Review Node -->
                    <div class="pipeline-node" data-node="clinician" onclick="showPipelinePopup('clinician')">
                        <div class="node-badge human">H</div>
                        <div class="node-icon"><i class="ph ph-user-check"></i></div>
                        <div class="node-label">Review</div>
                        <div class="node-hint">Click for details</div>
                    </div>
                    <div class="pipeline-arrow"><i class="ph ph-arrow-right"></i></div>

                    <!-- FHIR Node -->
                    <div class="pipeline-node" data-node="fhir" onclick="showPipelinePopup('fhir')">
                        <div class="node-badge deterministic">D</div>
                        <div class="node-icon"><i class="ph ph-plugs-connected"></i></div>
                        <div class="node-label">FHIR R4</div>
                        <div class="node-hint">Click for details</div>
                    </div>
                    <div class="pipeline-arrow"><i class="ph ph-arrow-right"></i></div>

                    <!-- EHR Output -->
                    <div class="pipeline-endpoint end">
                        <i class="ph ph-hospital"></i>
                        <span>EHR</span>
                    </div>
                </div>

                <!-- Pipeline Popup (hidden by default) -->
                <div class="pipeline-popup" id="pipelinePopup">
                    <button class="popup-nav popup-nav-prev" id="popupPrevBtn" onclick="prevPipelineNode()">
                        <i class="ph ph-caret-left"></i>
                    </button>
                    <div class="popup-main">
                        <div class="popup-header">
                            <h4 id="popupTitle">Title</h4>
                            <button class="btn-icon" onclick="closePipelinePopup()">
                                <i class="ph ph-x"></i>
                            </button>
                        </div>
                        <div class="popup-content" id="popupContent">
                            <!-- Content populated dynamically -->
                        </div>
                        <div class="popup-footer">
                            <span class="popup-counter" id="popupCounter">1 / 5</span>
                        </div>
                    </div>
                    <button class="popup-nav popup-nav-next" id="popupNextBtn" onclick="nextPipelineNode()">
                        <i class="ph ph-caret-right"></i>
                    </button>
                </div>
            </div>

            <div class="modal-footer about-footer">
                <div class="footer-info">
                    <span>Part of <strong>Cleansheet Medical</strong></span>
                    <a href="https://cleansheet.info" target="_blank"><i class="ph ph-globe"></i></a>
                    <a href="https://github.com/CleansheetLLC" target="_blank"><i class="ph ph-github-logo"></i></a>
                </div>
                <div class="kaggle-badge">
                    <i class="ph ph-trophy"></i>
                    <span>MedGemma Impact Challenge</span>
                </div>
                <button class="btn-primary" onclick="closeAboutModal()">
                    <i class="ph ph-check"></i> Got It
                </button>
            </div>
        </div>
    </div>

    <!-- API Guide Modal (Slideshow) -->
    <div class="modal-overlay" id="apiGuideModal">
        <div class="modal api-guide-modal">
            <div class="modal-header">
                <h2><i class="ph ph-code"></i> API Reference</h2>
                <button class="btn-icon" onclick="closeApiGuideModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body slideshow-container api-slideshow">
                <!-- Slide 1: Overview -->
                <div class="api-slide active" data-api-slide="1">
                    <div class="slide-icon">
                        <i class="ph ph-plugs-connected"></i>
                    </div>
                    <h3>Voice-to-FHIR REST API</h3>
                    <p class="slide-subtitle">FastAPI Server for Clinical Documentation</p>
                    <div class="slide-content">
                        <p>The Voice-to-FHIR API provides REST endpoints for processing clinical voice recordings into structured FHIR R4 bundles.</p>
                        <div class="api-overview-grid">
                            <div class="api-stat">
                                <span class="stat-number">5</span>
                                <span class="stat-label">Endpoints</span>
                            </div>
                            <div class="api-stat">
                                <span class="stat-number">15</span>
                                <span class="stat-label">Workflows</span>
                            </div>
                            <div class="api-stat">
                                <span class="stat-number">FHIR R4</span>
                                <span class="stat-label">Output Format</span>
                            </div>
                        </div>
                        <div class="api-base-url">
                            <code>Base URL: http://localhost:8001/api/v1</code>
                        </div>
                    </div>
                </div>

                <!-- Slide 2: Health & Workflows -->
                <div class="api-slide" data-api-slide="2">
                    <h3>Health & Workflows</h3>
                    <p class="slide-subtitle">System Status and Available Workflows</p>
                    <div class="slide-content api-endpoints-list">
                        <div class="api-endpoint">
                            <div class="endpoint-header">
                                <span class="http-method get">GET</span>
                                <code>/health</code>
                            </div>
                            <p>Check API server status and pipeline readiness.</p>
                            <div class="endpoint-response">
                                <strong>Response:</strong>
                                <pre>{"status": "ok", "version": "0.1.0", "pipeline_ready": true}</pre>
                            </div>
                        </div>
                        <div class="api-endpoint">
                            <div class="endpoint-header">
                                <span class="http-method get">GET</span>
                                <code>/workflows</code>
                            </div>
                            <p>List available clinical workflows for extraction.</p>
                            <div class="endpoint-response">
                                <strong>Workflows:</strong> general, soap, hp, emergency, intake, followup, procedure, discharge, radiology, lab_review, respiratory, icu, cardiology, pediatrics, neurology
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slide 3: Process Audio -->
                <div class="api-slide" data-api-slide="3">
                    <h3>Process Audio</h3>
                    <p class="slide-subtitle">Full Pipeline: Audio  Transcript  FHIR</p>
                    <div class="slide-content">
                        <div class="api-endpoint">
                            <div class="endpoint-header">
                                <span class="http-method post">POST</span>
                                <code>/process-audio</code>
                            </div>
                            <p>Process an audio file through the complete voice-to-FHIR pipeline.</p>
                            <div class="endpoint-params">
                                <strong>Form Data:</strong>
                                <ul>
                                    <li><code>file</code> - Audio file (WAV, MP3, WEBM)</li>
                                    <li><code>workflow</code> - Clinical workflow (default: "general")</li>
                                </ul>
                                <strong>Headers:</strong>
                                <ul>
                                    <li><code>X-HF-Token</code> - HuggingFace API token</li>
                                    <li><code>X-MedASR-Endpoint</code> - Custom MedASR URL</li>
                                    <li><code>X-MedGemma-Endpoint</code> - Custom MedGemma URL</li>
                                    <li><code>X-Transcription-Backend</code> - whisper | dedicated | local</li>
                                    <li><code>X-Extraction-Backend</code> - dedicated | local | serverless</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slide 4: Process Chunk -->
                <div class="api-slide" data-api-slide="4">
                    <h3>Process Chunk</h3>
                    <p class="slide-subtitle">Streaming Mode: VAD-Based Audio Chunks</p>
                    <div class="slide-content">
                        <div class="api-endpoint">
                            <div class="endpoint-header">
                                <span class="http-method post">POST</span>
                                <code>/process-chunk</code>
                            </div>
                            <p>Process a single audio chunk from streaming recording with voice activity detection.</p>
                            <div class="endpoint-params">
                                <strong>Form Data:</strong>
                                <ul>
                                    <li><code>file</code> - Audio chunk</li>
                                    <li><code>chunk_id</code> - Unique chunk identifier</li>
                                    <li><code>context</code> - Previous transcript for continuity</li>
                                    <li><code>workflow</code> - Clinical workflow</li>
                                    <li><code>is_final</code> - True if last chunk</li>
                                </ul>
                                <strong>Special Header:</strong>
                                <ul>
                                    <li><code>X-Skip-Extraction: true</code> - Transcription only (no entity extraction)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slide 5: Process Transcript -->
                <div class="api-slide" data-api-slide="5">
                    <h3>Process Transcript</h3>
                    <p class="slide-subtitle">Skip ASR: Text  Extraction  FHIR</p>
                    <div class="slide-content">
                        <div class="api-endpoint">
                            <div class="endpoint-header">
                                <span class="http-method post">POST</span>
                                <code>/process-transcript</code>
                            </div>
                            <p>Process pre-transcribed text directly. Useful for testing extraction without audio.</p>
                            <div class="endpoint-params">
                                <strong>JSON Body:</strong>
                                <pre>{
  "transcript": "Clinical note text...",
  "workflow": "general"
}</pre>
                                <strong>Headers:</strong>
                                <ul>
                                    <li><code>X-HF-Token</code> - HuggingFace API token</li>
                                    <li><code>X-MedGemma-Endpoint</code> - Custom MedGemma URL</li>
                                    <li><code>X-Extraction-Backend</code> - dedicated | local | serverless</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slide 6: Response Format -->
                <div class="api-slide" data-api-slide="6">
                    <h3>Response Format</h3>
                    <p class="slide-subtitle">Structured Output with Metrics</p>
                    <div class="slide-content">
                        <div class="api-response-example">
                            <pre>{
  "success": true,
  "transcript": "Patient presents with...",
  "entities": {
    "chief_complaint": "chest pain",
    "conditions": [...],
    "medications": [...],
    "vitals": [...],
    "allergies": [...]
  },
  "fhir_bundle": { /* FHIR R4 Bundle */ },
  "metrics": {
    "conversion_ms": 150,
    "transcription_ms": 2340,
    "extraction_ms": 1850,
    "fhir_transform_ms": 45,
    "total_ms": 4385
  }
}</pre>
                        </div>
                    </div>
                </div>

                <!-- Slide 7: Quick Start -->
                <div class="api-slide" data-api-slide="7">
                    <div class="slide-icon final">
                        <i class="ph ph-rocket-launch"></i>
                    </div>
                    <h3>Quick Start</h3>
                    <div class="slide-content final-slide">
                        <div class="quickstart-steps">
                            <div class="quickstart-step">
                                <span class="step-num">1</span>
                                <div>
                                    <strong>Install dependencies</strong>
                                    <code>pip install fastapi uvicorn python-multipart</code>
                                </div>
                            </div>
                            <div class="quickstart-step">
                                <span class="step-num">2</span>
                                <div>
                                    <strong>Set HuggingFace token</strong>
                                    <code>export HF_TOKEN=hf_xxx...</code>
                                </div>
                            </div>
                            <div class="quickstart-step">
                                <span class="step-num">3</span>
                                <div>
                                    <strong>Configure MedASR endpoint</strong>
                                    <code>export MEDASR_ENDPOINT_URL=http://localhost:5000/transcribe</code>
                                </div>
                            </div>
                            <div class="quickstart-step">
                                <span class="step-num">4</span>
                                <div>
                                    <strong>Configure MedGemma endpoint</strong>
                                    <code>export MEDGEMMA_ENDPOINT_URL=https://your-endpoint.aws.endpoints.huggingface.cloud</code>
                                </div>
                            </div>
                            <div class="quickstart-step">
                                <span class="step-num">5</span>
                                <div>
                                    <strong>Start the server</strong>
                                    <code>uvicorn server:app --port 8001</code>
                                </div>
                            </div>
                        </div>
                        <p class="quickstart-note">
                            <i class="ph ph-info"></i>
                            MedASR runs locally for voice biometric privacy. MedGemma requires a HuggingFace Inference Endpoint for <code>google/medgemma-4b-it</code>. Docs: <code>/docs</code>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Slideshow Navigation -->
            <div class="slideshow-nav">
                <button class="slide-nav-btn" id="prevApiSlideBtn" onclick="prevApiSlide()">
                    <i class="ph ph-caret-left"></i>
                </button>
                <div class="slide-dots" id="apiSlideDots">
                    <!-- Dots generated dynamically -->
                </div>
                <button class="slide-nav-btn" id="nextApiSlideBtn" onclick="nextApiSlide()">
                    <i class="ph ph-caret-right"></i>
                </button>
            </div>

            <div class="modal-footer">
                <div class="slide-counter">
                    <span id="currentApiSlideNum">1</span> / <span id="totalApiSlideNum">7</span>
                </div>
                <button class="btn-primary" onclick="closeApiGuideModal()">
                    <i class="ph ph-check"></i> Got It
                </button>
            </div>
        </div>
    </div>

    <!-- Add EHR Item Modal -->
    <div class="modal-overlay" id="addEhrItemModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="ph ph-plus-circle"></i> Add EHR Item</h2>
                <button class="btn-icon" onclick="closeAddEhrItemModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label class="setting-label">Item Type</label>
                    <div class="pill-selector" id="addEhrItemTypePills">
                        <button class="pill-btn active" data-value="conditions" onclick="setAddEhrItemType('conditions')">
                            <i class="ph ph-stethoscope"></i> Condition
                        </button>
                        <button class="pill-btn" data-value="medications" onclick="setAddEhrItemType('medications')">
                            <i class="ph ph-pill"></i> Medication
                        </button>
                        <button class="pill-btn" data-value="allergies" onclick="setAddEhrItemType('allergies')">
                            <i class="ph ph-warning"></i> Allergy
                        </button>
                        <button class="pill-btn" data-value="vitals" onclick="setAddEhrItemType('vitals')">
                            <i class="ph ph-heartbeat"></i> Vital
                        </button>
                        <button class="pill-btn" data-value="labResults" onclick="setAddEhrItemType('labResults')">
                            <i class="ph ph-test-tube"></i> Lab
                        </button>
                        <button class="pill-btn" data-value="procedures" onclick="setAddEhrItemType('procedures')">
                            <i class="ph ph-scissors"></i> Procedure
                        </button>
                        <button class="pill-btn" data-value="familyHistory" onclick="setAddEhrItemType('familyHistory')">
                            <i class="ph ph-users"></i> Family Hx
                        </button>
                    </div>
                    <input type="hidden" id="addEhrItemType" value="conditions">
                </div>

                <div class="setting-group">
                    <label class="setting-label">Input Method</label>
                    <div class="input-method-toggle">
                        <button class="input-method-btn active" data-method="voice" onclick="setAddEhrInputMethod('voice')">
                            <i class="ph ph-microphone"></i> Voice
                        </button>
                        <button class="input-method-btn" data-method="text" onclick="setAddEhrInputMethod('text')">
                            <i class="ph ph-keyboard"></i> Type
                        </button>
                    </div>
                </div>

                <!-- Voice Input -->
                <div class="add-ehr-voice-input" id="addEhrVoiceInput">
                    <div class="voice-input-status" id="addEhrVoiceStatus">
                        <i class="ph ph-microphone"></i>
                        <span>Click to start recording</span>
                    </div>
                    <button class="record-btn-small" id="addEhrRecordBtn" onclick="toggleAddEhrRecording()">
                        <i class="ph ph-microphone"></i>
                    </button>
                    <div class="voice-input-result" id="addEhrVoiceResult" style="display: none;">
                        <div class="voice-result-text" id="addEhrVoiceText"></div>
                        <button class="btn-icon" onclick="clearAddEhrVoiceResult()" title="Clear">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                </div>

                <!-- Text Input Fields (dynamic based on type) -->
                <div class="add-ehr-text-input" id="addEhrTextInput" style="display: none;">
                    <!-- Fields populated dynamically based on item type -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAddEhrItemModal()">Cancel</button>
                <button class="btn-primary" id="addEhrItemSubmitBtn" onclick="submitAddEhrItem()">
                    <i class="ph ph-plus"></i> Add Item
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Condition Modal -->
    <div class="modal-overlay" id="editConditionModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2><i class="ph ph-pencil"></i> Edit Condition</h2>
                <button class="btn-icon" onclick="closeEditConditionModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editConditionId">
                <div class="setting-group">
                    <label class="setting-label">Condition Name</label>
                    <input type="text" class="form-input" id="editConditionName" placeholder="e.g., Type 2 Diabetes Mellitus">
                </div>
                <div class="setting-group">
                    <label class="setting-label">ICD-10 Code</label>
                    <input type="text" class="form-input" id="editConditionIcd10" placeholder="e.g., E11.9">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Status</label>
                    <select class="form-select" id="editConditionStatus" style="width: 100%;">
                        <option value="active">Active</option>
                        <option value="resolved">Resolved</option>
                        <option value="chronic">Chronic</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeEditConditionModal()">Cancel</button>
                <button class="btn-primary" onclick="saveConditionEdit()">
                    <i class="ph ph-check"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal-overlay" id="editOrderModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="ph ph-pencil"></i> Edit Order</h2>
                <button class="btn-icon" onclick="closeEditOrderModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editOrderId">
                <input type="hidden" id="editOrderType">

                <!-- Order Name (all types) -->
                <div class="setting-group">
                    <label class="setting-label">Name</label>
                    <input type="text" class="form-input" id="editOrderName" placeholder="Order name">
                </div>

                <!-- Medication-specific fields -->
                <div id="editOrderMedicationFields">
                    <div class="setting-group">
                        <label class="setting-label">Dosage</label>
                        <input type="text" class="form-input" id="editOrderDosage" placeholder="e.g., 500 mg twice daily">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Frequency</label>
                        <select class="form-select" id="editOrderFrequency" style="width: 100%;">
                            <option value="">Select frequency...</option>
                            <option value="once daily">Once daily</option>
                            <option value="twice daily">Twice daily</option>
                            <option value="three times daily">Three times daily</option>
                            <option value="four times daily">Four times daily</option>
                            <option value="every 4 hours">Every 4 hours</option>
                            <option value="every 6 hours">Every 6 hours</option>
                            <option value="every 8 hours">Every 8 hours</option>
                            <option value="every 12 hours">Every 12 hours</option>
                            <option value="as needed">As needed (PRN)</option>
                            <option value="at bedtime">At bedtime</option>
                            <option value="with meals">With meals</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Instructions</label>
                        <input type="text" class="form-input" id="editOrderInstructions" placeholder="e.g., Take with food">
                    </div>
                </div>

                <!-- Consult-specific fields -->
                <div id="editOrderConsultFields" style="display: none;">
                    <div class="setting-group">
                        <label class="setting-label">Reason for Referral</label>
                        <textarea class="form-input" id="editOrderReason" rows="3" placeholder="Reason for consultation"></textarea>
                    </div>
                </div>

                <!-- Linked Diagnosis Display -->
                <div class="setting-group" id="editOrderDiagnosisGroup">
                    <label class="setting-label">Linked Diagnosis</label>
                    <div id="editOrderLinkedDiagnosis" style="padding: var(--spacing-sm); background: var(--color-bg-light); border-radius: var(--radius-sm); font-size: 0.875rem;">
                        <span style="color: var(--color-text-muted);">No diagnosis linked</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeEditOrderModal()">Cancel</button>
                <button class="btn-primary" onclick="saveOrderEdit()">
                    <i class="ph ph-check"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- Diagnosis Link Modal -->
    <div class="modal-overlay" id="diagnosisLinkModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2><i class="ph ph-link"></i> Link to Diagnosis</h2>
                <button class="btn-icon" onclick="closeDiagnosisLinkModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-md);">
                    Select an existing diagnosis or create a new one:
                </p>
                <div id="diagnosisLinkConditions" class="diagnosis-options-list">
                    <!-- Populated dynamically -->
                </div>

                <!-- New Diagnosis Form (hidden by default) -->
                <div id="newDiagnosisForm" style="display: none; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border);">
                    <div class="setting-group">
                        <label class="setting-label">Diagnosis Name</label>
                        <input type="text" class="form-input" id="newDiagnosisName" placeholder="e.g., Essential Hypertension" data-autocomplete="conditions">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">ICD-10 Code (optional)</label>
                        <input type="text" class="form-input" id="newDiagnosisIcd10" placeholder="e.g., I10">
                    </div>
                    <div style="text-align: right; margin-top: var(--spacing-sm);">
                        <button class="btn-primary" onclick="createAndLinkDiagnosis()">
                            <i class="ph ph-plus"></i> Create & Link
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDiagnosisLinkModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div class="modal-overlay" id="addOrderModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="ph ph-prescription"></i> Add Order</h2>
                <button class="btn-icon" onclick="closeAddOrderModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label class="setting-label">Order Type</label>
                    <div class="pill-selector" id="addOrderTypePills">
                        <button class="pill-btn active" data-value="medications" onclick="setAddOrderType('medications')">
                            <i class="ph ph-pill"></i> Medication
                        </button>
                        <button class="pill-btn" data-value="labs" onclick="setAddOrderType('labs')">
                            <i class="ph ph-test-tube"></i> Lab
                        </button>
                        <button class="pill-btn" data-value="consults" onclick="setAddOrderType('consults')">
                            <i class="ph ph-user-circle"></i> Consult
                        </button>
                        <button class="pill-btn" data-value="procedures" onclick="setAddOrderType('procedures')">
                            <i class="ph ph-scissors"></i> Procedure
                        </button>
                    </div>
                    <input type="hidden" id="addOrderType" value="medications">
                </div>

                <div class="setting-group">
                    <label class="setting-label">Input Method</label>
                    <div class="input-method-toggle">
                        <button class="input-method-btn active" data-method="voice" onclick="setAddOrderInputMethod('voice')">
                            <i class="ph ph-microphone"></i> Voice
                        </button>
                        <button class="input-method-btn" data-method="text" onclick="setAddOrderInputMethod('text')">
                            <i class="ph ph-keyboard"></i> Type
                        </button>
                    </div>
                </div>

                <!-- Voice Input -->
                <div class="add-ehr-voice-input" id="addOrderVoiceInput">
                    <div class="voice-input-status" id="addOrderVoiceStatus">
                        <i class="ph ph-microphone"></i>
                        <span>Click to start recording</span>
                    </div>
                    <button class="record-btn-small" id="addOrderRecordBtn" onclick="toggleAddOrderRecording()">
                        <i class="ph ph-microphone"></i>
                    </button>
                    <div class="voice-input-result" id="addOrderVoiceResult" style="display: none;">
                        <div class="voice-result-text" id="addOrderVoiceText"></div>
                        <button class="btn-icon" onclick="clearAddOrderVoiceResult()" title="Clear">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                </div>

                <!-- Text Input Fields (dynamic based on type) -->
                <div class="add-ehr-text-input" id="addOrderTextInput" style="display: none;">
                    <!-- Fields populated dynamically based on order type -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAddOrderModal()">Cancel</button>
                <button class="btn-primary" id="addOrderSubmitBtn" onclick="submitAddOrder()">
                    <i class="ph ph-plus"></i> Add Order
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Left Column: Input + Queue + Mock EHR -->
        <div class="left-column">
        <!-- Input Panel -->
        <section class="panel input-panel">
            <div class="panel-header">
                <i class="ph ph-plus-circle"></i>
                Input
                <button class="collapse-toggle" onclick="togglePanel(this)" title="Collapse/Expand">
                    <i class="ph ph-caret-down"></i>
                </button>
            </div>
            <div class="panel-body">
                <!-- Note Type Selector - Compact -->
                <div class="form-group" style="flex-direction: row; align-items: center; gap: var(--spacing-sm);">
                    <label style="margin: 0; white-space: nowrap;">Type:</label>
                    <select class="form-select" id="workflowSelect" style="flex: 1; padding: var(--spacing-xs) var(--spacing-sm); font-size: 0.75rem;">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <!-- Record + Upload Row -->
                <div class="record-section">
                    <button class="record-btn" id="recordBtn" title="Click to record">
                        <i class="ph ph-microphone"></i>
                    </button>
                    <div class="record-time" id="recordTime">00:00</div>
                    <div class="audio-visualizer" id="audioVisualizer"></div>
                </div>

                <!-- Upload Section - Inline -->
                <div class="upload-section" id="uploadSection">
                    <input type="file" id="fileInput" accept=".wav,.weba,.webm,.mp3,.ogg,.m4a">
                    <div class="upload-icon"><i class="ph ph-upload-simple"></i></div>
                    <div class="upload-text">Drop file or click</div>
                </div>

                <!-- Audio Preview - Compact -->
                <div class="audio-preview" id="audioPreview">
                    <div class="audio-filename" id="audioFilename"></div>
                    <audio controls id="audioPlayer" style="height: 28px;"></audio>
                    <div style="display: flex; gap: var(--spacing-xs);">
                        <button class="btn-secondary" id="downloadAudioBtn"><i class="ph ph-download-simple"></i></button>
                        <button class="btn-secondary" id="clearAudioBtn"><i class="ph ph-x"></i></button>
                    </div>
                </div>

                <!-- Add to Queue -->
                <button class="btn-primary" id="addToQueueBtn" disabled style="padding: var(--spacing-xs) var(--spacing-sm); font-size: 0.75rem;">
                    <i class="ph ph-plus"></i> Add to Queue
                </button>

                <!-- Batch Upload - Compact -->
                <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span style="font-size: 0.65rem; color: var(--color-text-muted);">or</span>
                    <input type="file" id="batchFileInput" accept=".wav,.weba,.webm,.mp3,.ogg,.m4a" multiple style="display: none;">
                    <button class="btn-secondary" id="batchUploadBtn" style="flex: 1; font-size: 0.7rem;">
                        <i class="ph ph-folder-open"></i> Batch Upload
                    </button>
                </div>
                <div class="batch-info" id="batchInfo" style="display: none; font-size: 0.65rem; color: var(--color-text-secondary);"></div>
            </div>
        </section>

        <!-- Processing Queue Panel -->
        <section class="panel queue-panel">
            <div class="panel-header">
                <i class="ph ph-queue"></i>
                Queue
                <div class="queue-header-extra">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="queueProgress" style="width: 0%"></div>
                    </div>
                    <span id="queueCount">0/0</span>
                </div>
                <button class="collapse-toggle" onclick="togglePanel(this)" title="Collapse/Expand">
                    <i class="ph ph-caret-down"></i>
                </button>
            </div>
            <div class="panel-body">
                <!-- Processing Toggle -->
                <div class="processing-toggle">
                    <span>Sequential</span>
                    <div class="toggle-switch" id="parallelToggle" title="Toggle parallel processing"></div>
                    <span>Parallel</span>
                </div>

                <!-- Queue List -->
                <div class="queue-list" id="queueList">
                    <div class="queue-empty">
                        <i class="ph ph-hourglass"></i>
                        <p>No items in queue</p>
                    </div>
                </div>
            </div>
            <div class="panel-footer">
                <button class="btn-secondary" id="processQueueBtn" disabled>
                    <i class="ph ph-play"></i> Process All
                </button>
                <button class="btn-secondary" id="clearQueueBtn">
                    <i class="ph ph-trash"></i> Clear
                </button>
            </div>
        </section>

        <!-- Mock EHR Panel -->
        <section class="panel ehr-panel">
            <div class="panel-header">
                <i class="ph ph-hospital"></i>
                Mock EHR
                <button class="collapse-toggle" onclick="togglePanel(this)" title="Collapse/Expand">
                    <i class="ph ph-caret-down"></i>
                </button>
            </div>
            <div class="panel-body">
                <div class="mock-ehr-list" id="mockEhrList">
                    <div class="mock-ehr-empty" id="mockEhrEmpty">
                        <i class="ph ph-hospital"></i>
                        <p>No records submitted</p>
                    </div>
                </div>
            </div>
            <div class="panel-footer">
                <button class="btn-secondary" id="viewEhrBundleBtn" disabled>
                    <i class="ph ph-code"></i> View Bundle
                </button>
                <button class="btn-secondary" id="clearEhrBtn">
                    <i class="ph ph-trash"></i> Clear
                </button>
            </div>
        </section>
        </div><!-- /left-column -->

        <!-- Clinician Review Panel -->
        <section class="panel review-panel">
            <div class="panel-header">
                <i class="ph ph-clipboard-text"></i>
                Clinician Review
            </div>

            <!-- Review Item Selector -->
            <div class="review-pool-selector" id="reviewPoolSelector" style="display: none;">
                <label style="font-size: 0.75rem; color: var(--color-text-secondary);">Reviewing:</label>
                <select class="review-item-select" id="reviewItemSelect"></select>
            </div>

            <!-- Tabs -->
            <div class="review-tabs">
                <button class="review-tab active" data-tab="notes">
                    <i class="ph ph-note"></i> Clinical Notes
                </button>
                <button class="review-tab" data-tab="ehr">
                    <i class="ph ph-database"></i> EHR Data
                </button>
                <button class="review-tab" data-tab="orders">
                    <i class="ph ph-prescription"></i> Orders
                </button>
            </div>

            <!-- Tab Content: Clinical Notes -->
            <div class="review-content active" id="notesContent">
                <div class="empty-state" id="notesEmpty">
                    <i class="ph ph-note-blank"></i>
                    <p>Process audio to generate clinical notes</p>
                </div>
                <div class="transcript-panel collapsed" id="transcriptPanel" style="display: none;">
                    <div class="transcript-header" onclick="toggleTranscriptPanel('transcriptPanel')">
                        <i class="ph ph-caret-down toggle-icon"></i>
                        <span>Original Transcript</span>
                        <div class="transcript-header-actions" onclick="event.stopPropagation()">
                            <button class="btn-icon" id="playTranscriptAudio" title="Play original audio" style="opacity: 0.6;">
                                <i class="ph ph-speaker-high"></i>
                            </button>
                        </div>
                    </div>
                    <audio id="transcriptAudioPlayer" style="display: none;"></audio>
                    <div class="transcript-text" id="transcriptText"></div>
                </div>
                <div id="notesSections"></div>
            </div>

            <!-- Tab Content: EHR Data -->
            <div class="review-content" id="ehrContent">
                <div class="empty-state" id="ehrEmpty">
                    <i class="ph ph-database"></i>
                    <p>Process audio to extract structured EHR data</p>
                </div>
                <div class="transcript-panel collapsed" id="ehrTranscriptPanel" style="display: none;">
                    <div class="transcript-header" onclick="toggleTranscriptPanel('ehrTranscriptPanel')">
                        <i class="ph ph-caret-down toggle-icon"></i>
                        <span>Original Transcript</span>
                        <div class="transcript-header-actions" onclick="event.stopPropagation()">
                            <button class="btn-icon" id="playEhrTranscriptAudio" title="Play original audio" style="opacity: 0.6;">
                                <i class="ph ph-speaker-high"></i>
                            </button>
                        </div>
                    </div>
                    <audio id="ehrTranscriptAudioPlayer" style="display: none;"></audio>
                    <div class="transcript-text" id="ehrTranscriptText"></div>
                </div>
                <div class="data-action-bar" id="ehrActionBar" style="display: none;">
                    <button class="btn-secondary" onclick="approveAllEhrItems()">
                        <i class="ph ph-checks"></i> Approve All
                    </button>
                    <button class="btn-secondary" onclick="openAddEhrItemModal()">
                        <i class="ph ph-plus"></i> Add Item
                    </button>
                </div>
                <div id="ehrCategories"></div>
            </div>

            <!-- Tab Content: Orders -->
            <div class="review-content" id="ordersContent">
                <div class="empty-state" id="ordersEmpty">
                    <i class="ph ph-prescription"></i>
                    <p>Process audio to extract clinician orders</p>
                </div>
                <div class="transcript-panel collapsed" id="ordersTranscriptPanel" style="display: none;">
                    <div class="transcript-header" onclick="toggleTranscriptPanel('ordersTranscriptPanel')">
                        <i class="ph ph-caret-down toggle-icon"></i>
                        <span>Original Transcript</span>
                        <div class="transcript-header-actions" onclick="event.stopPropagation()">
                            <button class="btn-icon" id="playOrdersTranscriptAudio" title="Play original audio" style="opacity: 0.6;">
                                <i class="ph ph-speaker-high"></i>
                            </button>
                        </div>
                    </div>
                    <audio id="ordersTranscriptAudioPlayer" style="display: none;"></audio>
                    <div class="transcript-text" id="ordersTranscriptText"></div>
                </div>
                <div class="data-action-bar" id="ordersActionBar" style="display: none;">
                    <button class="btn-secondary" onclick="approveAllOrders()">
                        <i class="ph ph-checks"></i> Approve All
                    </button>
                    <button class="btn-secondary" onclick="openAddOrderModal()">
                        <i class="ph ph-plus"></i> Add Order
                    </button>
                </div>
                <div id="ordersList"></div>

                <!-- Drop Zone for Order-Diagnosis Linking -->
                <div class="diagnosis-drop-zone" id="diagnosisDropZone" style="display: none;">
                    <div class="diagnosis-drop-zone-header">
                        <i class="ph ph-link"></i>
                        <span>Drop medication here to link to a diagnosis</span>
                    </div>
                    <div id="conditionDropTargets"></div>
                    <div class="drag-hint">
                        <i class="ph ph-info"></i>
                        <span>Drag unverified medications to link them to patient diagnoses</span>
                    </div>
                </div>
            </div>

            <div class="panel-footer" style="gap: var(--spacing-sm);">
                <button class="btn-secondary" id="exportResultsBtn" disabled title="Export all results as single JSON">
                    <i class="ph ph-export"></i>
                    Bulk
                </button>
                <button class="btn-secondary" id="exportIndividualBtn" disabled title="Export each result as separate .actual.json file (for comparison with expected)">
                    <i class="ph ph-files"></i>
                    Individual
                </button>
                <button class="btn-primary" id="submitToEhrBtn" disabled style="flex: 1;">
                    <i class="ph ph-check-circle"></i>
                    Submit Approved to Mock EHR
                </button>
            </div>
        </section>
    </main>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================================================
        // Configuration
        // ============================================================================
        const DEFAULT_API_URL = 'http://localhost:8001';
        const DEFAULT_MEDGEMMA_ENDPOINT = 'https://cp2wjw95vpf9604w.us-east-1.aws.endpoints.huggingface.cloud';
        const MAX_PARALLEL = 3;

        // ============================================================================
        // Settings Management
        // ============================================================================
        const settings = {
            apiUrl: localStorage.getItem('v2f_apiUrl') || DEFAULT_API_URL,
            hfToken: localStorage.getItem('v2f_hfToken') || '',
            transcriptionBackend: localStorage.getItem('v2f_transcriptionBackend') || 'local',
            medgemmaEndpoint: localStorage.getItem('v2f_medgemmaEndpoint') || DEFAULT_MEDGEMMA_ENDPOINT
        };

        function saveSettings() {
            localStorage.setItem('v2f_apiUrl', settings.apiUrl);
            localStorage.setItem('v2f_hfToken', settings.hfToken);
            localStorage.setItem('v2f_transcriptionBackend', settings.transcriptionBackend);
            localStorage.setItem('v2f_medgemmaEndpoint', settings.medgemmaEndpoint);
        }

        function clearSettings() {
            localStorage.removeItem('v2f_apiUrl');
            localStorage.removeItem('v2f_hfToken');
            localStorage.removeItem('v2f_transcriptionBackend');
            localStorage.removeItem('v2f_medgemmaEndpoint');
            settings.apiUrl = DEFAULT_API_URL;
            settings.hfToken = '';
            settings.transcriptionBackend = 'local';
            settings.medgemmaEndpoint = DEFAULT_MEDGEMMA_ENDPOINT;
        }

        function getApiUrl() {
            return settings.apiUrl || DEFAULT_API_URL;
        }

        // ============================================================================
        // State Management
        // ============================================================================
        const state = {
            workflows: [],
            currentAudioBlob: null,
            currentFilename: null,
            isRecording: false,
            recordingStartTime: null,
            mediaRecorder: null,
            audioChunks: [],
            audioContext: null,
            analyser: null,
            queue: [], // { id, audioBlob, filename, workflow, workflowName, status, result, metrics }
            parallelMode: false,
            isProcessing: false,
            reviewPool: [], // Processed items ready for review
            currentReviewIndex: -1,
            mockEHR: []
        };

        // ============================================================================
        // DOM Elements
        // ============================================================================
        const elements = {
            apiStatus: document.getElementById('apiStatus'),
            apiStatusText: document.getElementById('apiStatusText'),
            workflowSelect: document.getElementById('workflowSelect'),
            recordBtn: document.getElementById('recordBtn'),
            recordTime: document.getElementById('recordTime'),
            audioVisualizer: document.getElementById('audioVisualizer'),
            uploadSection: document.getElementById('uploadSection'),
            fileInput: document.getElementById('fileInput'),
            audioPreview: document.getElementById('audioPreview'),
            audioFilename: document.getElementById('audioFilename'),
            audioPlayer: document.getElementById('audioPlayer'),
            downloadAudioBtn: document.getElementById('downloadAudioBtn'),
            clearAudioBtn: document.getElementById('clearAudioBtn'),
            addToQueueBtn: document.getElementById('addToQueueBtn'),
            parallelToggle: document.getElementById('parallelToggle'),
            queueList: document.getElementById('queueList'),
            queueProgress: document.getElementById('queueProgress'),
            queueCount: document.getElementById('queueCount'),
            processQueueBtn: document.getElementById('processQueueBtn'),
            clearQueueBtn: document.getElementById('clearQueueBtn'),
            reviewPoolSelector: document.getElementById('reviewPoolSelector'),
            reviewItemSelect: document.getElementById('reviewItemSelect'),
            notesContent: document.getElementById('notesContent'),
            notesEmpty: document.getElementById('notesEmpty'),
            notesSections: document.getElementById('notesSections'),
            transcriptPanel: document.getElementById('transcriptPanel'),
            transcriptText: document.getElementById('transcriptText'),
            ehrContent: document.getElementById('ehrContent'),
            ehrEmpty: document.getElementById('ehrEmpty'),
            ehrCategories: document.getElementById('ehrCategories'),
            ehrTranscriptPanel: document.getElementById('ehrTranscriptPanel'),
            ehrTranscriptText: document.getElementById('ehrTranscriptText'),
            ordersContent: document.getElementById('ordersContent'),
            ordersEmpty: document.getElementById('ordersEmpty'),
            ordersList: document.getElementById('ordersList'),
            ordersTranscriptPanel: document.getElementById('ordersTranscriptPanel'),
            ordersTranscriptText: document.getElementById('ordersTranscriptText'),
            submitToEhrBtn: document.getElementById('submitToEhrBtn'),
            mockEhrList: document.getElementById('mockEhrList'),
            mockEhrEmpty: document.getElementById('mockEhrEmpty'),
            viewEhrBundleBtn: document.getElementById('viewEhrBundleBtn'),
            clearEhrBtn: document.getElementById('clearEhrBtn'),
            toast: document.getElementById('toast'),
            // Settings elements
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            hfTokenInput: document.getElementById('hfTokenInput'),
            tokenStatus: document.getElementById('tokenStatus'),
            apiUrlInput: document.getElementById('apiUrlInput'),
            transcriptionBackendSelect: document.getElementById('transcriptionBackendSelect'),
            medgemmaEndpointInput: document.getElementById('medgemmaEndpointInput'),
            endpointStatus: document.getElementById('endpointStatus'),
            headerEndpointStatus: document.getElementById('headerEndpointStatus'),
            headerEndpointText: document.getElementById('headerEndpointText'),
            clearSettingsBtn: document.getElementById('clearSettingsBtn'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn')
        };

        // ============================================================================
        // Utility Functions
        // ============================================================================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function togglePanel(btn) {
            const panel = btn.closest('.panel');
            panel.classList.toggle('collapsed');
            // Save state to localStorage
            const panelClass = [...panel.classList].find(c => c.endsWith('-panel'));
            if (panelClass) {
                localStorage.setItem(`v2f_${panelClass}_collapsed`, panel.classList.contains('collapsed'));
            }
        }

        // Restore collapsed states on load
        function restoreCollapsedStates() {
            ['input-panel', 'queue-panel', 'ehr-panel'].forEach(panelClass => {
                const collapsed = localStorage.getItem(`v2f_${panelClass}_collapsed`) === 'true';
                if (collapsed) {
                    const panel = document.querySelector(`.${panelClass}`);
                    if (panel) panel.classList.add('collapsed');
                }
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatMs(ms) {
            if (ms < 1000) return `${ms.toFixed(0)}ms`;
            return `${(ms / 1000).toFixed(1)}s`;
        }

        /**
         * Toggle transcript panel collapsed/expanded state
         */
        function toggleTranscriptPanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.toggle('collapsed');
            }
        }

        /**
         * Format transcript text with highlighted clinical markers and measurements
         * for better readability across all tabs.
         */
        function formatTranscript(text) {
            if (!text) return '';

            // Escape HTML first
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Highlight section markers like [SUBJECTIVE], [OBJECTIVE], [ASSESSMENT], [PLAN]
            // Pattern matches [MARKER] with optional spaces inside brackets
            formatted = formatted.replace(
                /\[\s*(SUBJECTIVE|OBJECTIVE|ASSESSMENT|PLAN|CHIEF COMPLAINT|CLINICAL HISTORY|HISTORY OF PRESENT ILLNESS|HPI|ROS|REVIEW OF SYSTEMS|PHYSICAL EXAM|EXAM|VITAL SIGNS|VITALS|LABS|LABORATORY|LAB RESULTS|MEDICATIONS|CURRENT MEDICATIONS|HOME MEDICATIONS|ALLERGIES|FAMILY HISTORY|SOCIAL HISTORY|PAST MEDICAL HISTORY|PMH|PAST SURGICAL HISTORY|PSH|FINDINGS?|IMPRESSION|COMPARISON|HOSPITAL COURSE|DISCHARGE DIAGNOSIS|ADMISSION DIAGNOSIS|DISCHARGE MEDICATIONS|DISCHARGE INSTRUCTIONS|FOLLOW-?UP|PROCEDURES?|CONSULTATIONS?|IMAGING|RADIOLOGY)\s*\]/gi,
                '<span class="section-marker">[$1]</span>'
            );

            // Highlight measurements (numbers with units)
            formatted = formatted.replace(
                /(\d+\.?\d*)\s*(mg|mcg|mL|L|g|kg|lbs?|pounds?|mmHg|bpm|%|?[FC]|breaths?\/min|pack-years?|years?|months?|days?|weeks?|hours?|minutes?)/gi,
                '<span class="measurement">$1 $2</span>'
            );

            // Highlight blood pressure format
            formatted = formatted.replace(
                /(\d{2,3})\s*\/\s*(\d{2,3})(?=\s|,|\.|\]|$)/g,
                '<span class="measurement">$1/$2</span>'
            );

            // Highlight common clinical terms
            const clinicalTerms = [
                'denies', 'reports', 'presents with', 'admitted with', 'admitted for',
                'positive', 'negative', 'normal', 'abnormal', 'elevated', 'decreased',
                'improved', 'stable', 'worsening', 'resolved', 'chronic', 'acute',
                'bilateral', 'unilateral', 'mild', 'moderate', 'severe'
            ];
            clinicalTerms.forEach(term => {
                const regex = new RegExp(`\\b(${term})\\b`, 'gi');
                formatted = formatted.replace(regex, '<span class="clinical-term">$1</span>');
            });

            return formatted;
        }

        function showToast(message, type = 'info') {
            elements.toast.textContent = message;
            elements.toast.className = `toast ${type} visible`;
            // Longer duration for errors so user can read them
            const duration = type === 'error' ? 8000 : 5000;
            setTimeout(() => {
                elements.toast.classList.remove('visible');
            }, duration);
        }

        // ============================================================================
        // Export/Import Functions
        // ============================================================================
        const EXPORT_VERSION = '1.0';

        // Convert Blob to base64 string
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                if (!blob) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Convert base64 string back to Blob
        function base64ToBlob(base64) {
            if (!base64) return null;
            const [header, data] = base64.split(',');
            const mimeMatch = header.match(/:(.*?);/);
            const mime = mimeMatch ? mimeMatch[1] : 'audio/webm';
            const binary = atob(data);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                array[i] = binary.charCodeAt(i);
            }
            return new Blob([array], { type: mime });
        }

        async function exportState() {
            try {
                showToast('Preparing export...', 'info');

                // Serialize queue items (convert blobs to base64)
                const serializedQueue = await Promise.all(state.queue.map(async item => ({
                    ...item,
                    audioBlob: await blobToBase64(item.audioBlob)
                })));

                // Serialize review pool (convert blobs to base64)
                const serializedReviewPool = await Promise.all(state.reviewPool.map(async item => ({
                    ...item,
                    audioBlob: await blobToBase64(item.audioBlob)
                })));

                const exportData = {
                    version: EXPORT_VERSION,
                    exportedAt: new Date().toISOString(),
                    state: {
                        workflows: state.workflows,
                        queue: serializedQueue,
                        reviewPool: serializedReviewPool,
                        currentReviewIndex: state.currentReviewIndex,
                        mockEHR: state.mockEHR,
                        parallelMode: state.parallelMode
                    },
                    settings: {
                        apiUrl: settings.apiUrl,
                        hfToken: settings.hfToken ? '[REDACTED]' : null,
                        transcriptionBackend: settings.transcriptionBackend,
                        medgemmaEndpoint: settings.medgemmaEndpoint
                    }
                };

                const json = JSON.stringify(exportData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `voice-to-fhir-state-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast(`Exported ${state.queue.length} queue items, ${state.reviewPool.length} reviews, ${state.mockEHR.length} EHR records`, 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showToast('Export failed: ' + error.message, 'error');
            }
        }

        async function importState(file) {
            try {
                showToast('Reading import file...', 'info');

                const text = await file.text();
                const importData = JSON.parse(text);

                // Version check
                if (!importData.version) {
                    throw new Error('Invalid export file: missing version');
                }

                const [major] = importData.version.split('.');
                const [currentMajor] = EXPORT_VERSION.split('.');
                if (major !== currentMajor) {
                    throw new Error(`Incompatible version: file is v${importData.version}, expected v${EXPORT_VERSION}`);
                }

                if (!importData.state) {
                    throw new Error('Invalid export file: missing state data');
                }

                const imported = importData.state;

                // Restore workflows
                if (imported.workflows) {
                    state.workflows = imported.workflows;
                    populateWorkflowSelect();
                }

                // Restore queue (convert base64 back to blobs)
                if (imported.queue) {
                    state.queue = imported.queue.map(item => ({
                        ...item,
                        audioBlob: base64ToBlob(item.audioBlob)
                    }));
                }

                // Restore review pool (convert base64 back to blobs)
                if (imported.reviewPool) {
                    state.reviewPool = imported.reviewPool.map(item => ({
                        ...item,
                        audioBlob: base64ToBlob(item.audioBlob)
                    }));
                }

                // Restore other state
                state.currentReviewIndex = imported.currentReviewIndex ?? -1;
                state.mockEHR = imported.mockEHR || [];
                state.parallelMode = imported.parallelMode || false;

                // Clear any current audio
                state.currentAudioBlob = null;
                state.currentFilename = null;

                // Update UI
                elements.parallelToggle.checked = state.parallelMode;
                renderQueue();
                updateReviewPoolUI();
                if (state.currentReviewIndex >= 0 && state.currentReviewIndex < state.reviewPool.length) {
                    renderCurrentReview();
                } else if (state.reviewPool.length > 0) {
                    state.currentReviewIndex = 0;
                    renderCurrentReview();
                } else {
                    elements.notesEmpty.style.display = 'block';
                    elements.notesSections.style.display = 'none';
                }
                renderMockEHR();
                clearCurrentAudio();

                const summary = [
                    imported.queue?.length ? `${imported.queue.length} queue items` : null,
                    imported.reviewPool?.length ? `${imported.reviewPool.length} reviews` : null,
                    imported.mockEHR?.length ? `${imported.mockEHR.length} EHR records` : null
                ].filter(Boolean).join(', ');

                showToast(`Imported: ${summary || 'empty state'}`, 'success');
            } catch (error) {
                console.error('Import failed:', error);
                showToast('Import failed: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // API Functions
        // ============================================================================
        function getApiHeaders() {
            const headers = {};
            if (settings.hfToken) {
                headers['X-HF-Token'] = settings.hfToken;
            }
            if (settings.transcriptionBackend) {
                headers['X-Transcription-Backend'] = settings.transcriptionBackend;
            }
            if (settings.medgemmaEndpoint) {
                headers['X-Extraction-Backend'] = 'dedicated';
                headers['X-MedGemma-Endpoint'] = settings.medgemmaEndpoint;
            }
            return headers;
        }

        async function checkApiHealth() {
            try {
                const response = await fetch(`${getApiUrl()}/api/v1/health`);
                const data = await response.json();
                elements.apiStatus.classList.add('connected');
                elements.apiStatus.classList.remove('error');
                elements.apiStatusText.textContent = `Connected (v${data.version})`;
                return true;
            } catch (error) {
                elements.apiStatus.classList.add('error');
                elements.apiStatus.classList.remove('connected');
                elements.apiStatusText.textContent = 'Disconnected';
                return false;
            }
        }

        function populateWorkflowSelect() {
            if (state.workflows && state.workflows.length > 0) {
                elements.workflowSelect.innerHTML = state.workflows.map(w =>
                    `<option value="${w.id}" title="${w.description}">${w.name}</option>`
                ).join('');
            } else {
                elements.workflowSelect.innerHTML = '<option value="general">General Encounter</option>';
            }
        }

        async function loadWorkflows() {
            try {
                const response = await fetch(`${getApiUrl()}/api/v1/workflows`);
                const data = await response.json();
                state.workflows = data.workflows;
                populateWorkflowSelect();
            } catch (error) {
                console.error('Failed to load workflows:', error);
                populateWorkflowSelect();
            }
        }

        async function processAudio(audioBlob, workflow) {
            const formData = new FormData();
            formData.append('file', audioBlob, 'recording.webm');
            formData.append('workflow', workflow);

            const response = await fetch(`${getApiUrl()}/api/v1/process-audio`, {
                method: 'POST',
                headers: getApiHeaders(),
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Processing failed');
            }

            return await response.json();
        }

        async function validateHfToken(token) {
            if (!token || !token.startsWith('hf_')) {
                return { valid: false, message: 'Token should start with hf_' };
            }

            // Try a simple validation by checking the API with the token
            try {
                const response = await fetch(`${getApiUrl()}/api/v1/health`, {
                    headers: { 'X-HF-Token': token }
                });
                if (response.ok) {
                    return { valid: true, message: 'Token configured' };
                }
                return { valid: false, message: 'Could not validate token' };
            } catch (error) {
                return { valid: true, message: 'Token saved (server offline)' };
            }
        }

        async function checkEndpointStatus(endpointUrl) {
            if (!endpointUrl) {
                return { status: 'offline', message: 'No endpoint configured' };
            }

            try {
                // HuggingFace Inference Endpoints return status via a health check
                // We'll try to hit the endpoint with an empty request to check status
                const response = await fetch(endpointUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${settings.hfToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ inputs: '' })
                });

                if (response.ok) {
                    return { status: 'running', message: 'Running' };
                } else if (response.status === 503) {
                    // 503 typically means the endpoint is paused/scaling
                    const data = await response.json().catch(() => ({}));
                    if (data.error && data.error.includes('is currently loading')) {
                        return { status: 'paused', message: 'Loading...' };
                    }
                    return { status: 'paused', message: 'Paused (503)' };
                } else if (response.status === 401 || response.status === 403) {
                    return { status: 'error', message: 'Auth error - check token' };
                } else if (response.status === 400 || response.status === 404 || response.status === 422) {
                    // 400/404/422 with our test request means the endpoint IS running
                    // It's just rejecting our health check format - that's fine
                    return { status: 'running', message: 'Running' };
                } else {
                    return { status: 'error', message: `Error (${response.status})` };
                }
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    return { status: 'offline', message: 'Unreachable' };
                }
                return { status: 'error', message: error.message };
            }
        }

        function updateEndpointStatusUI(result) {
            // Update modal status
            elements.endpointStatus.className = `endpoint-status ${result.status}`;
            const icon = result.status === 'running' ? 'check-circle' :
                        result.status === 'paused' ? 'pause-circle' :
                        result.status === 'error' ? 'x-circle' : 'cloud-slash';
            elements.endpointStatus.innerHTML = `<i class="ph ph-${icon}"></i> ${result.message}`;

            // Update header status
            if (settings.medgemmaEndpoint) {
                elements.headerEndpointStatus.style.display = 'flex';
                elements.headerEndpointStatus.className = `header-endpoint-status ${result.status === 'running' ? 'running' : result.status === 'paused' ? 'paused' : 'offline'}`;
                elements.headerEndpointText.textContent = `MedGemma: ${result.message}`;
            } else {
                elements.headerEndpointStatus.style.display = 'none';
            }
        }

        // ============================================================================
        // Audio Recording
        // ============================================================================
        function initVisualizer() {
            const barCount = 32;
            elements.audioVisualizer.innerHTML = '';
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                elements.audioVisualizer.appendChild(bar);
            }
        }

        function updateVisualizer() {
            if (!state.analyser) return;

            const bars = elements.audioVisualizer.querySelectorAll('.visualizer-bar');
            const dataArray = new Uint8Array(state.analyser.frequencyBinCount);
            state.analyser.getByteFrequencyData(dataArray);

            const step = Math.floor(dataArray.length / bars.length);
            bars.forEach((bar, i) => {
                const value = dataArray[i * step];
                const height = Math.max(4, (value / 255) * 36);
                bar.style.height = `${height}px`;
            });

            if (state.isRecording) {
                requestAnimationFrame(updateVisualizer);
            }
        }

        function updateRecordTime() {
            if (!state.isRecording || !state.recordingStartTime) return;

            const elapsed = (Date.now() - state.recordingStartTime) / 1000;
            elements.recordTime.textContent = formatTime(elapsed);

            if (state.isRecording) {
                requestAnimationFrame(updateRecordTime);
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Setup audio context for visualization
                state.audioContext = new AudioContext();
                state.analyser = state.audioContext.createAnalyser();
                state.analyser.fftSize = 256;
                const source = state.audioContext.createMediaStreamSource(stream);
                source.connect(state.analyser);

                // Setup media recorder
                state.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                state.audioChunks = [];

                state.mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        state.audioChunks.push(e.data);
                    }
                };

                state.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                    setCurrentAudio(audioBlob, 'recording.webm');

                    // Cleanup
                    stream.getTracks().forEach(track => track.stop());
                    if (state.audioContext) {
                        state.audioContext.close();
                        state.audioContext = null;
                    }
                };

                state.mediaRecorder.start(100);
                state.isRecording = true;
                state.recordingStartTime = Date.now();

                elements.recordBtn.classList.add('recording');
                elements.recordBtn.innerHTML = '<i class="ph ph-stop"></i>';

                updateVisualizer();
                updateRecordTime();

            } catch (error) {
                console.error('Failed to start recording:', error);
                showToast('Microphone access denied', 'error');
            }
        }

        function stopRecording() {
            if (state.mediaRecorder && state.isRecording) {
                state.mediaRecorder.stop();
                state.isRecording = false;
                state.recordingStartTime = null;

                elements.recordBtn.classList.remove('recording');
                elements.recordBtn.innerHTML = '<i class="ph ph-microphone"></i>';

                // Reset visualizer
                const bars = elements.audioVisualizer.querySelectorAll('.visualizer-bar');
                bars.forEach(bar => bar.style.height = '4px');
            }
        }

        // ============================================================================
        // Field-Level Re-Recording (Voice correction for individual note sections)
        // ============================================================================
        const fieldRecordingState = {
            activeField: null,
            mediaRecorder: null,
            audioChunks: [],
            stream: null
        };

        async function toggleFieldRecording(fieldKey, button) {
            if (fieldRecordingState.activeField === fieldKey) {
                // Stop recording
                await stopFieldRecording(fieldKey, button);
            } else if (fieldRecordingState.activeField) {
                // Another field is recording - stop it first
                const activeBtn = document.querySelector(`.field-rerecord-btn[data-field="${fieldRecordingState.activeField}"]`);
                await stopFieldRecording(fieldRecordingState.activeField, activeBtn);
                // Start new recording
                await startFieldRecording(fieldKey, button);
            } else {
                // Start new recording
                await startFieldRecording(fieldKey, button);
            }
        }

        async function startFieldRecording(fieldKey, button) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                fieldRecordingState.stream = stream;
                fieldRecordingState.activeField = fieldKey;
                fieldRecordingState.audioChunks = [];

                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                fieldRecordingState.mediaRecorder = mediaRecorder;

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        fieldRecordingState.audioChunks.push(e.data);
                    }
                };

                mediaRecorder.start(100);

                // Update UI
                button.classList.add('recording');
                button.innerHTML = '<i class="ph ph-stop"></i>';
                button.title = 'Stop recording';

                const contentEl = document.querySelector(`.note-section-content[data-section="${fieldKey}"]`);
                if (contentEl) {
                    contentEl.classList.add('recording-active');
                }

                showToast(`Recording ${fieldKey.replace(/([A-Z])/g, ' $1').trim()}...`, 'info');

            } catch (error) {
                console.error('Failed to start field recording:', error);
                showToast('Microphone access denied', 'error');
            }
        }

        async function stopFieldRecording(fieldKey, button) {
            if (!fieldRecordingState.mediaRecorder) return;

            return new Promise((resolve) => {
                fieldRecordingState.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(fieldRecordingState.audioChunks, { type: 'audio/webm' });

                    // Cleanup
                    if (fieldRecordingState.stream) {
                        fieldRecordingState.stream.getTracks().forEach(track => track.stop());
                    }

                    // Update UI to transcribing state
                    button.classList.remove('recording');
                    button.classList.add('transcribing');
                    button.innerHTML = '<i class="ph ph-spinner"></i>';
                    button.title = 'Transcribing...';

                    const contentEl = document.querySelector(`.note-section-content[data-section="${fieldKey}"]`);
                    if (contentEl) {
                        contentEl.classList.remove('recording-active');
                        contentEl.classList.add('transcribing');
                    }

                    // Send to MedASR for transcription
                    try {
                        const transcript = await transcribeFieldAudio(audioBlob, fieldKey);
                        if (transcript && contentEl) {
                            // Update the field content with the transcript
                            contentEl.textContent = transcript;
                            showToast('Field updated', 'success');
                        }
                    } catch (error) {
                        console.error('Field transcription failed:', error);
                        showToast(`Transcription failed: ${error.message}`, 'error');
                    }

                    // Reset UI
                    button.classList.remove('transcribing');
                    button.innerHTML = '<i class="ph ph-microphone"></i>';
                    button.title = 'Re-record this field';

                    if (contentEl) {
                        contentEl.classList.remove('transcribing');
                    }

                    // Reset state
                    fieldRecordingState.activeField = null;
                    fieldRecordingState.mediaRecorder = null;
                    fieldRecordingState.audioChunks = [];
                    fieldRecordingState.stream = null;

                    resolve();
                };

                fieldRecordingState.mediaRecorder.stop();
            });
        }

        async function transcribeFieldAudio(audioBlob, fieldKey) {
            const formData = new FormData();
            formData.append('file', audioBlob, 'field-recording.webm');
            formData.append('chunk_id', `field-${fieldKey}-${Date.now()}`);
            formData.append('workflow', 'general');
            formData.append('is_final', 'true');

            const headers = getApiHeaders();
            headers['X-Skip-Extraction'] = 'true';  // Transcription only

            const response = await fetch(`${getApiUrl()}/api/v1/process-chunk`, {
                method: 'POST',
                headers: headers,
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Transcription failed');
            }

            const result = await response.json();
            return result.transcript || '';
        }

        function setCurrentAudio(blob, filename) {
            state.currentAudioBlob = blob;
            state.currentFilename = filename;

            const url = URL.createObjectURL(blob);
            elements.audioPlayer.src = url;
            elements.audioFilename.textContent = filename;
            elements.audioPreview.classList.add('visible');

            updateAddToQueueButton();
        }

        function clearCurrentAudio() {
            if (elements.audioPlayer.src) {
                URL.revokeObjectURL(elements.audioPlayer.src);
            }
            state.currentAudioBlob = null;
            state.currentFilename = null;
            elements.audioPlayer.src = '';
            elements.audioPreview.classList.remove('visible');
            elements.recordTime.textContent = '00:00';

            updateAddToQueueButton();
        }

        function downloadCurrentAudio() {
            if (!state.currentAudioBlob) return;

            const url = URL.createObjectURL(state.currentAudioBlob);
            const a = document.createElement('a');
            a.href = url;

            // Generate filename with timestamp if it's a recording
            let filename = state.currentFilename;
            if (filename === 'recording.webm') {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                filename = `recording-${timestamp}.webm`;
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Recording downloaded', 'success');
        }

        function updateAddToQueueButton() {
            const hasAudio = state.currentAudioBlob !== null;
            const hasWorkflow = elements.workflowSelect.value !== '';
            elements.addToQueueBtn.disabled = !hasAudio || !hasWorkflow;
        }

        // ============================================================================
        // Queue Management
        // ============================================================================
        function addToQueue() {
            if (!state.currentAudioBlob) return;

            const workflow = elements.workflowSelect.value;
            const workflowName = elements.workflowSelect.options[elements.workflowSelect.selectedIndex].text;

            const item = {
                id: generateId(),
                audioBlob: state.currentAudioBlob,
                filename: state.currentFilename,
                workflow: workflow,
                workflowName: workflowName,
                status: 'pending',
                result: null,
                metrics: null
            };

            state.queue.push(item);
            clearCurrentAudio();
            renderQueue();
            showToast('Added to queue', 'success');
        }

        // Filename to workflow mapping for batch uploads
        function filenameToWorkflow(filename) {
            // Remove extension and convert to lowercase
            const baseName = filename.replace(/\.[^/.]+$/, '').toLowerCase();

            // Direct mappings for special cases
            const specialMappings = {
                'follow-up': 'followup',
                'cardiology-consult': 'cardiology',
                'lab-review': 'lab_review',
                'h-p': 'hp',
                'soap': 'soap'
            };

            // Check special mappings first
            if (specialMappings[baseName]) {
                return specialMappings[baseName];
            }

            // Try direct match with workflow IDs
            const workflowIds = state.workflows.map(w => w.id);
            if (workflowIds.includes(baseName)) {
                return baseName;
            }

            // Try matching with hyphens converted to underscores
            const underscored = baseName.replace(/-/g, '_');
            if (workflowIds.includes(underscored)) {
                return underscored;
            }

            // Try matching without hyphens
            const noHyphens = baseName.replace(/-/g, '');
            if (workflowIds.includes(noHyphens)) {
                return noHyphens;
            }

            // Try matching with suffix stripped (e.g., "-consult", "-note")
            const suffixStripped = baseName.replace(/-(consult|note|visit|report)$/, '');
            if (workflowIds.includes(suffixStripped)) {
                return suffixStripped;
            }

            // Default to general
            return 'general';
        }

        function getWorkflowName(workflowId) {
            const workflow = state.workflows.find(w => w.id === workflowId);
            return workflow ? workflow.name : 'General Encounter';
        }

        function batchAddToQueue(files) {
            const results = [];

            for (const file of files) {
                const workflowId = filenameToWorkflow(file.name);
                const workflowName = getWorkflowName(workflowId);

                const item = {
                    id: generateId(),
                    audioBlob: file,
                    filename: file.name,
                    workflow: workflowId,
                    workflowName: workflowName,
                    status: 'pending',
                    result: null,
                    metrics: null
                };

                state.queue.push(item);
                results.push({ filename: file.name, workflow: workflowName });
            }

            renderQueue();

            // Show summary
            const summary = results.map(r => `${r.filename}  ${r.workflow}`).join('\n');
            console.log('Batch upload:\n' + summary);
            showToast(`Added ${files.length} files to queue`, 'success');

            // Update batch info display
            const batchInfo = document.getElementById('batchInfo');
            if (batchInfo) {
                batchInfo.style.display = 'block';
                batchInfo.innerHTML = `<strong>Added ${files.length} files:</strong><br>` +
                    results.map(r => ` ${r.filename}  ${r.workflow}`).join('<br>');
                setTimeout(() => { batchInfo.style.display = 'none'; }, 5000);
            }
        }

        function removeFromQueue(id) {
            state.queue = state.queue.filter(item => item.id !== id);
            renderQueue();
        }

        function clearQueue() {
            state.queue = state.queue.filter(item => item.status === 'processing');
            renderQueue();
        }

        function renderQueue() {
            const pendingCount = state.queue.filter(i => i.status === 'pending').length;
            const processingCount = state.queue.filter(i => i.status === 'processing').length;
            const doneCount = state.queue.filter(i => i.status === 'done').length;
            const totalCount = state.queue.length;

            // Update progress
            const progress = totalCount > 0 ? (doneCount / totalCount) * 100 : 0;
            elements.queueProgress.style.width = `${progress}%`;
            elements.queueCount.textContent = `${doneCount}/${totalCount}`;

            // Update process button
            elements.processQueueBtn.disabled = pendingCount === 0 || state.isProcessing;

            if (state.queue.length === 0) {
                elements.queueList.innerHTML = `
                    <div class="queue-empty">
                        <i class="ph ph-hourglass"></i>
                        <p>No items in queue</p>
                    </div>
                `;
                return;
            }

            elements.queueList.innerHTML = state.queue.map(item => {
                const statusIcon = {
                    pending: '<i class="ph ph-hourglass"></i>',
                    processing: '<i class="ph ph-spinner spinning"></i>',
                    done: '<i class="ph ph-check-circle"></i>',
                    error: '<i class="ph ph-x-circle"></i>'
                }[item.status];

                const metricsHtml = item.metrics ? `
                    <div class="metrics-display">
                        <div class="metric-item">
                            <span class="metric-label">Transcription:</span>
                            <span class="metric-value">${formatMs(item.metrics.transcription_ms)}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Extraction:</span>
                            <span class="metric-value">${formatMs(item.metrics.extraction_ms)}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">FHIR:</span>
                            <span class="metric-value">${formatMs(item.metrics.fhir_transform_ms)}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Total:</span>
                            <span class="metric-value">${formatMs(item.metrics.total_ms)}</span>
                        </div>
                    </div>
                ` : '';

                // Check if this queue item is currently selected in review
                const reviewIndex = state.reviewPool.findIndex(r => r.id === item.id);
                const isSelected = reviewIndex !== -1 && reviewIndex === state.currentReviewIndex;
                const clickHandler = item.status === 'done' ? `onclick="selectReviewByQueueId('${item.id}')"` : '';

                return `
                    <div class="queue-item ${item.status}${isSelected ? ' selected' : ''}" data-id="${item.id}" ${clickHandler}>
                        <div class="queue-item-status ${item.status}">${statusIcon}</div>
                        <div class="queue-item-info">
                            <div class="queue-item-workflow">${item.workflowName}</div>
                            <div class="queue-item-meta">${item.filename}</div>
                            ${metricsHtml}
                        </div>
                        <div class="queue-item-actions">
                            ${item.status === 'error' ? `
                                <button class="btn-icon" onclick="event.stopPropagation(); retryQueueItem('${item.id}')" title="Retry">
                                    <i class="ph ph-arrow-clockwise"></i>
                                </button>
                            ` : ''}
                            ${item.status !== 'processing' ? `
                                <button class="btn-icon" onclick="event.stopPropagation(); removeFromQueue('${item.id}')" title="Remove">
                                    <i class="ph ph-x"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function processQueue() {
            const pending = state.queue.filter(item => item.status === 'pending');
            if (pending.length === 0) return;

            state.isProcessing = true;
            elements.processQueueBtn.disabled = true;

            try {
                if (state.parallelMode) {
                    // Process in parallel batches
                    while (state.queue.some(i => i.status === 'pending')) {
                        const batch = state.queue
                            .filter(i => i.status === 'pending')
                            .slice(0, MAX_PARALLEL);

                        await Promise.all(batch.map(item => processQueueItem(item)));
                    }
                } else {
                    // Process sequentially
                    for (const item of state.queue) {
                        if (item.status === 'pending') {
                            await processQueueItem(item);
                        }
                    }
                }
            } finally {
                state.isProcessing = false;
                renderQueue();
            }
        }

        async function processQueueItem(item) {
            item.status = 'processing';
            renderQueue();

            try {
                const result = await processAudio(item.audioBlob, item.workflow);

                if (result.success) {
                    item.status = 'done';
                    item.result = result;
                    item.metrics = result.metrics;

                    // Add to review pool
                    addToReviewPool(item);
                } else {
                    item.status = 'error';
                    item.error = result.error || 'Processing failed';
                    showToast(`Error: ${item.error}`, 'error');
                }
            } catch (error) {
                item.status = 'error';
                item.error = error.message;
                showToast(`Error: ${error.message}`, 'error');
            }

            renderQueue();
        }

        function retryQueueItem(id) {
            const item = state.queue.find(i => i.id === id);
            if (item) {
                item.status = 'pending';
                item.result = null;
                item.metrics = null;
                item.error = null;
                renderQueue();
            }
        }

        // ============================================================================
        // Review Pool
        // ============================================================================
        function addToReviewPool(item) {
            // Start with FHIR bundle extraction for detailed resource data
            const fhirData = extractDataFromBundle(item.result.fhir_bundle);

            // Merge with entities dict from server (has chief_complaint, family_history, social_history, ICD-10 codes)
            const entities = item.result.entities || {};
            const extractedData = {
                ...fhirData,
                chiefComplaint: entities.chief_complaint || null,
                // Use entities.conditions for ICD-10 codes (FHIR bundle has SNOMED)
                conditions: (entities.conditions || []).map((c, i) => ({
                    id: `cond-${i}`,
                    name: c.name,
                    icd10: c.icd10 || null,
                    status: c.status || 'active',
                    severity: c.severity || null,
                    isChiefComplaint: c.is_chief_complaint || false,
                    approved: null
                })),
                // Use entities.medications for dose/frequency (FHIR bundle doesn't preserve these)
                medications: (entities.medications || []).map((m, i) => ({
                    id: `med-${i}`,
                    name: m.name,
                    dose: m.dose || null,
                    frequency: m.frequency || null,
                    route: m.route || null,
                    rxnorm: m.rxnorm || null,
                    rxnorm_matched: m.rxnorm_matched,
                    isNewOrder: m.is_new_order || false,
                    approved: null
                })),
                // Use entities.medication_orders for RxNorm verification and linked diagnoses
                orders: {
                    medications: (entities.medication_orders || []).map((o, i) => ({
                        id: `med-order-${i}`,
                        name: o.name,
                        dosage: o.dose || o.dosage || null,
                        frequency: o.frequency || null,
                        route: o.route || null,
                        instructions: o.instructions || null,
                        rxnorm: o.rxnorm || null,
                        rxnorm_matched: o.rxnorm_matched,
                        linked_diagnosis: o.linked_diagnosis || null,
                        approved: null
                    })),
                    labs: (entities.lab_orders || fhirData.orders?.labs || []).map((l, i) => ({
                        id: `lab-order-${i}`,
                        name: l.name,
                        loinc: l.loinc || null,
                        linked_diagnosis: l.linked_diagnosis || null,
                        approved: null
                    })),
                    consults: (entities.referral_orders || fhirData.orders?.consults || []).map((c, i) => ({
                        id: `consult-order-${i}`,
                        specialty: c.specialty,
                        reason: c.reason || null,
                        linked_diagnosis: c.linked_diagnosis || null,
                        approved: null
                    })),
                    procedures: (entities.procedure_orders || fhirData.orders?.procedures || []).map((p, i) => ({
                        id: `proc-order-${i}`,
                        name: p.name,
                        linked_diagnosis: p.linked_diagnosis || null,
                        approved: null
                    })),
                    imaging: (entities.imaging_orders || fhirData.orders?.imaging || []).map((img, i) => ({
                        id: `img-order-${i}`,
                        name: img.name,
                        approved: null
                    }))
                },
                // Use entities.vitals for proper units
                vitals: (entities.vitals || []).map((v, i) => ({
                    id: `vital-${i}`,
                    type: v.type,
                    value: v.value,
                    unit: v.unit || null,
                    approved: null
                })),
                // Use entities.allergies
                allergies: (entities.allergies || []).map((a, i) => ({
                    id: `allergy-${i}`,
                    substance: a.substance,
                    reaction: a.reaction || null,
                    severity: a.severity || null,
                    approved: null
                })),
                // Use entities.lab_results (convert "null" strings to actual null)
                labResults: (entities.lab_results || []).map((l, i) => ({
                    id: `lab-${i}`,
                    name: l.name,
                    value: l.value,
                    unit: (l.unit && l.unit !== 'null') ? l.unit : null,
                    interpretation: (l.interpretation && l.interpretation !== 'null') ? l.interpretation : null,
                    approved: null
                })),
                // Use entities data for family/social history if available (more complete than FHIR extraction)
                familyHistory: (entities.family_history || []).map((fh, i) => ({
                    id: `fh-${i}`,
                    relationship: fh.relationship,
                    condition: fh.condition,
                    ageOfOnset: fh.age_of_onset,
                    deceased: fh.deceased,
                    approved: null
                })),
                socialHistory: entities.social_history || null,
                patient: entities.patient || fhirData.patient,
            };

            const reviewItem = {
                id: item.id,
                workflow: item.workflow,
                workflowName: item.workflowName,
                filename: item.filename,
                audioBlob: item.audioBlob,
                transcript: item.result.transcript,
                fhirBundle: item.result.fhir_bundle,
                metrics: item.metrics,
                status: item.status,
                extractedData: extractedData,
                approved: {}
            };

            state.reviewPool.push(reviewItem);
            updateReviewPoolUI();

            // Only auto-select if no item is currently selected (preserve user focus)
            if (state.currentReviewIndex < 0) {
                state.currentReviewIndex = state.reviewPool.length - 1;
                renderCurrentReview();
            }
        }

        function extractDataFromBundle(bundle) {
            const data = {
                patient: null,
                conditions: [],
                medications: [],
                allergies: [],
                vitals: [],
                labResults: [],
                procedures: [],
                familyHistory: [],
                socialHistory: null,
                orders: {
                    medications: [],
                    labs: [],
                    consults: [],
                    procedures: []
                }
            };

            if (!bundle || !bundle.entry) return data;

            for (const entry of bundle.entry) {
                const resource = entry.resource;
                if (!resource) continue;

                switch (resource.resourceType) {
                    case 'Patient':
                        data.patient = resource;
                        break;

                    case 'Condition':
                        data.conditions.push({
                            id: resource.id,
                            name: resource.code?.coding?.[0]?.display || resource.code?.text || 'Unknown',
                            code: resource.code?.coding?.[0]?.code,
                            system: resource.code?.coding?.[0]?.system,
                            status: resource.clinicalStatus?.coding?.[0]?.code || 'active',
                            onset: resource.onsetDateTime || resource.onsetString,
                            approved: null
                        });
                        break;

                    case 'MedicationStatement':
                        data.medications.push({
                            id: resource.id,
                            name: resource.medicationCodeableConcept?.coding?.[0]?.display ||
                                  resource.medicationCodeableConcept?.text || 'Unknown',
                            code: resource.medicationCodeableConcept?.coding?.[0]?.code,
                            dosage: resource.dosage?.[0]?.text || '',
                            status: resource.status,
                            approved: null
                        });
                        break;

                    case 'MedicationRequest':
                        data.orders.medications.push({
                            id: resource.id,
                            name: resource.medicationCodeableConcept?.coding?.[0]?.display ||
                                  resource.medicationCodeableConcept?.text || 'Unknown',
                            code: resource.medicationCodeableConcept?.coding?.[0]?.code,
                            dosage: resource.dosageInstruction?.[0]?.text || '',
                            intent: resource.intent,
                            approved: null
                        });
                        break;

                    case 'AllergyIntolerance':
                        data.allergies.push({
                            id: resource.id,
                            substance: resource.code?.coding?.[0]?.display || resource.code?.text || 'Unknown',
                            reaction: resource.reaction?.[0]?.manifestation?.[0]?.coding?.[0]?.display || '',
                            severity: resource.reaction?.[0]?.severity || 'unknown',
                            approved: null
                        });
                        break;

                    case 'Observation':
                        const category = resource.category?.[0]?.coding?.[0]?.code;
                        // For BP, unit is in components; for others in valueQuantity
                        const obsUnit = resource.valueQuantity?.unit ||
                                       resource.component?.[0]?.valueQuantity?.unit || '';
                        const obs = {
                            id: resource.id,
                            name: resource.code?.coding?.[0]?.display || resource.code?.text || 'Unknown',
                            code: resource.code?.coding?.[0]?.code,
                            value: resource.valueQuantity?.value ?? resource.valueString ?? '',
                            unit: obsUnit,
                            interpretation: resource.interpretation?.[0]?.coding?.[0]?.code,
                            approved: null
                        };

                        if (category === 'vital-signs') {
                            data.vitals.push(obs);
                        } else if (category === 'laboratory') {
                            data.labResults.push(obs);
                        } else if (category === 'social-history') {
                            data.socialHistory = obs;
                        }
                        break;

                    case 'Procedure':
                        data.procedures.push({
                            id: resource.id,
                            name: resource.code?.coding?.[0]?.display || resource.code?.text || 'Unknown',
                            code: resource.code?.coding?.[0]?.code,
                            date: resource.performedDateTime,
                            status: resource.status,
                            approved: null
                        });
                        break;

                    case 'FamilyMemberHistory':
                        data.familyHistory.push({
                            id: resource.id,
                            relationship: resource.relationship?.coding?.[0]?.display || 'Unknown',
                            condition: resource.condition?.[0]?.code?.coding?.[0]?.display || 'Unknown',
                            approved: null
                        });
                        break;

                    case 'ServiceRequest':
                        const serviceCategory = resource.category?.[0]?.coding?.[0]?.code;
                        const serviceItem = {
                            id: resource.id,
                            name: resource.code?.coding?.[0]?.display || resource.code?.text || 'Unknown',
                            code: resource.code?.coding?.[0]?.code,
                            intent: resource.intent,
                            reason: resource.reasonCode?.[0]?.text || null,
                            approved: null
                        };

                        if (serviceCategory === 'laboratory') {
                            data.orders.labs.push(serviceItem);
                        } else if (serviceCategory === 'consultation') {
                            data.orders.consults.push(serviceItem);
                        } else if (serviceCategory === 'imaging') {
                            // Put imaging in procedures for now (could add separate category)
                            serviceItem.type = 'imaging';
                            data.orders.procedures.push(serviceItem);
                        } else {
                            data.orders.procedures.push(serviceItem);
                        }
                        break;
                }
            }

            return data;
        }

        // Navigate to a review item by its queue ID
        function selectReviewByQueueId(queueId) {
            const reviewIndex = state.reviewPool.findIndex(item => item.id === queueId);
            if (reviewIndex !== -1) {
                state.currentReviewIndex = reviewIndex;
                renderCurrentReview();
                updateReviewPoolUI();
                renderQueue(); // Update queue to show selection
            }
        }

        function updateReviewPoolUI() {
            const exportBtn = document.getElementById('exportResultsBtn');
            const exportIndividualBtn = document.getElementById('exportIndividualBtn');

            if (state.reviewPool.length === 0) {
                elements.reviewPoolSelector.style.display = 'none';
                elements.submitToEhrBtn.disabled = true;
                if (exportBtn) exportBtn.disabled = true;
                if (exportIndividualBtn) exportIndividualBtn.disabled = true;
                return;
            }

            elements.reviewPoolSelector.style.display = 'flex';
            elements.reviewItemSelect.innerHTML = state.reviewPool.map((item, index) =>
                `<option value="${index}">${item.workflowName} - ${new Date().toLocaleTimeString()}</option>`
            ).join('');

            elements.reviewItemSelect.value = state.currentReviewIndex;
            elements.submitToEhrBtn.disabled = false;
            if (exportBtn) exportBtn.disabled = false;
            if (exportIndividualBtn) exportIndividualBtn.disabled = false;
        }

        function renderCurrentReview() {
            if (state.currentReviewIndex < 0 || state.currentReviewIndex >= state.reviewPool.length) {
                // Show empty states
                elements.notesEmpty.style.display = 'block';
                elements.notesSections.innerHTML = '';
                elements.transcriptPanel.style.display = 'none';
                elements.ehrEmpty.style.display = 'block';
                elements.ehrCategories.innerHTML = '';
                elements.ehrTranscriptPanel.style.display = 'none';
                document.getElementById('ehrActionBar').style.display = 'none';
                elements.ordersEmpty.style.display = 'block';
                elements.ordersList.innerHTML = '';
                elements.ordersTranscriptPanel.style.display = 'none';
                document.getElementById('ordersActionBar').style.display = 'none';
                return;
            }

            const item = state.reviewPool[state.currentReviewIndex];

            // Render Clinical Notes
            renderClinicalNotes(item);

            // Render EHR Data
            renderEhrData(item);

            // Render Orders
            renderOrders(item);
        }

        function renderClinicalNotes(item) {
            elements.notesEmpty.style.display = 'none';

            // Generate note sections based on workflow
            const sections = generateNoteSections(item.workflow, item.extractedData);

            elements.notesSections.innerHTML = sections.map(section => `
                <div class="note-section" data-section-key="${section.key}">
                    <div class="note-section-header">
                        <span class="section-title">
                            <i class="ph ph-${section.icon}"></i>
                            ${section.title}
                        </span>
                        <button class="field-rerecord-btn" data-field="${section.key}" title="Re-record this field">
                            <i class="ph ph-microphone"></i>
                        </button>
                    </div>
                    <div class="note-section-content" contenteditable="true" data-section="${section.key}">
                        ${section.content}
                    </div>
                </div>
            `).join('');

            // Attach event listeners for field re-record buttons
            elements.notesSections.querySelectorAll('.field-rerecord-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const fieldKey = btn.dataset.field;
                    toggleFieldRecording(fieldKey, btn);
                });
            });

            // Show transcript with formatting
            elements.transcriptPanel.style.display = 'block';
            elements.transcriptText.innerHTML = formatTranscript(item.transcript);

            // Set up audio playback for the original recording
            const audioPlayer = document.getElementById('transcriptAudioPlayer');
            const playBtn = document.getElementById('playTranscriptAudio');
            if (audioPlayer && item.audioBlob) {
                // Revoke previous object URL to avoid memory leaks
                if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
                    URL.revokeObjectURL(audioPlayer.src);
                }
                audioPlayer.src = URL.createObjectURL(item.audioBlob);
                playBtn.style.display = '';
            } else if (playBtn) {
                playBtn.style.display = 'none';
            }
        }

        function generateNoteSections(workflow, data) {
            const sections = [];

            // Chief Complaint / HPI - prefer direct chiefComplaint field, fallback to first condition
            const chiefComplaintText = data.chiefComplaint ||
                (data.conditions.length > 0 ? data.conditions[0].name : null);
            sections.push({
                key: 'chiefComplaint',
                title: 'Chief Complaint',
                icon: 'chat-circle-text',
                content: chiefComplaintText || 'No chief complaint documented'
            });

            // History of Present Illness
            sections.push({
                key: 'hpi',
                title: 'History of Present Illness',
                icon: 'clipboard-text',
                content: 'Patient presents with ' + (chiefComplaintText
                    ? chiefComplaintText.toLowerCase()
                    : 'symptoms as described')
            });

            // Vitals
            if (data.vitals.length > 0) {
                sections.push({
                    key: 'vitals',
                    title: 'Vital Signs',
                    icon: 'heartbeat',
                    content: data.vitals.map(v => `${v.type || v.name}: ${v.value} ${v.unit || ''}`).join('\n')
                });
            }

            // Medications
            if (data.medications.length > 0) {
                sections.push({
                    key: 'medications',
                    title: 'Current Medications',
                    icon: 'pill',
                    content: data.medications.map(m => `${m.name}${m.dosage ? ' - ' + m.dosage : ''}`).join('\n')
                });
            }

            // Allergies
            if (data.allergies.length > 0) {
                sections.push({
                    key: 'allergies',
                    title: 'Allergies',
                    icon: 'warning',
                    content: data.allergies.map(a => `${a.substance}${a.reaction ? ' - ' + a.reaction : ''}`).join('\n')
                });
            }

            // Assessment
            sections.push({
                key: 'assessment',
                title: 'Assessment',
                icon: 'stethoscope',
                content: data.conditions.length > 0
                    ? data.conditions.map((c, i) => `${i + 1}. ${c.name}${c.code ? ` (${c.code})` : ''}`).join('\n')
                    : 'Assessment pending'
            });

            // Plan
            const planItems = [];
            if (data.orders.medications.length > 0) {
                planItems.push('Medications: ' + data.orders.medications.map(m => m.name).join(', '));
            }
            if (data.orders.labs.length > 0) {
                planItems.push('Labs: ' + data.orders.labs.map(l => l.name).join(', '));
            }
            if (data.orders.consults.length > 0) {
                planItems.push('Consults: ' + data.orders.consults.map(c => c.name).join(', '));
            }

            sections.push({
                key: 'plan',
                title: 'Plan',
                icon: 'list-checks',
                content: planItems.length > 0 ? planItems.join('\n') : 'Continue current management'
            });

            return sections;
        }

        function renderEhrData(item) {
            elements.ehrEmpty.style.display = 'none';
            const data = item.extractedData;

            // Show transcript panel with formatting
            elements.ehrTranscriptPanel.style.display = 'block';
            elements.ehrTranscriptText.innerHTML = formatTranscript(item.transcript);

            // Show action bar
            document.getElementById('ehrActionBar').style.display = 'flex';

            // Set up audio playback
            const audioPlayer = document.getElementById('ehrTranscriptAudioPlayer');
            const playBtn = document.getElementById('playEhrTranscriptAudio');
            if (audioPlayer && item.audioBlob) {
                if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
                    URL.revokeObjectURL(audioPlayer.src);
                }
                audioPlayer.src = URL.createObjectURL(item.audioBlob);
                playBtn.style.display = '';
            } else if (playBtn) {
                playBtn.style.display = 'none';
            }

            const categories = [
                { key: 'vitals', title: 'Vital Signs', icon: 'heartbeat', items: data.vitals },
                { key: 'conditions', title: 'Conditions', icon: 'stethoscope', items: data.conditions },
                { key: 'medications', title: 'Medications', icon: 'pill', items: data.medications },
                { key: 'allergies', title: 'Allergies', icon: 'warning', items: data.allergies },
                { key: 'labResults', title: 'Lab Results', icon: 'test-tube', items: data.labResults },
                { key: 'procedures', title: 'Procedures', icon: 'scissors', items: data.procedures },
                { key: 'familyHistory', title: 'Family History', icon: 'users', items: data.familyHistory }
            ].filter(cat => cat.items.length > 0);

            elements.ehrCategories.innerHTML = categories.map(cat => `
                <div class="ehr-category">
                    <div class="ehr-category-header">
                        <i class="ph ph-${cat.icon}"></i>
                        ${cat.title}
                        <span class="ehr-category-count">${cat.items.length}</span>
                    </div>
                    <div class="ehr-items">
                        ${cat.items.map(item => renderEhrItem(cat.key, item)).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderEhrItem(category, item) {
            let details = '';
            let code = '';
            let badge = '';

            switch (category) {
                case 'vitals':
                    // Format vitals with monospace values
                    const vitalValue = item.value || '';
                    const vitalUnit = item.unit || '';
                    details = `<span class="ehr-measurement">${vitalValue}</span> <span class="ehr-unit">${vitalUnit}</span>`;
                    code = item.code || '';
                    break;
                case 'conditions':
                    // Show status as a badge
                    const status = item.status || 'active';
                    badge = `<span class="ehr-status-badge ${status}">${status}</span>`;
                    code = item.icd10 ? `<span class="ehr-icd10-code">${item.icd10}</span>` : '';
                    break;
                case 'medications':
                    details = item.dose ? `<span class="ehr-measurement">${item.dose}${item.frequency ? ' ' + item.frequency : ''}</span>` : '';
                    code = item.code || '';
                    // Add RxNorm verification badge
                    if (item.rxnorm_matched === true) {
                        badge = `<span class="rxnorm-status verified"><i class="ph ph-seal-check"></i> Verified</span>`;
                    } else if (item.rxnorm_matched === false) {
                        badge = `<span class="rxnorm-status unverified"><i class="ph ph-warning"></i> Unverified</span>`;
                    }
                    break;
                case 'allergies':
                    const reaction = item.reaction || 'Unknown reaction';
                    const severity = item.severity || 'unknown';
                    badge = `<span class="ehr-severity-badge ${severity}">${severity}</span>`;
                    details = reaction;
                    break;
                case 'labResults':
                    const labValue = item.value || '';
                    const labUnit = item.unit || '';
                    const interpretation = item.interpretation;
                    details = `<span class="ehr-measurement">${labValue}</span> <span class="ehr-unit">${labUnit}</span>`;
                    if (interpretation) {
                        badge = `<span class="ehr-interpretation-badge ${interpretation}">${interpretation}</span>`;
                    }
                    code = item.code || '';
                    break;
                case 'procedures':
                    details = item.date || item.status || '';
                    code = item.code || '';
                    break;
                case 'familyHistory':
                    details = item.condition || '';
                    if (item.ageOfOnset) {
                        details += ` <span class="ehr-age-onset">(onset: ${item.ageOfOnset})</span>`;
                    }
                    break;
            }

            const approvedClass = item.approved === true ? 'approved' : item.approved === false ? 'rejected' : '';
            const itemName = item.name || item.type || item.substance || item.relationship || 'Unknown';

            // Add edit button for conditions
            const editButton = category === 'conditions'
                ? `<button class="btn-icon" onclick="editCondition('${item.id}')" title="Edit">
                       <i class="ph ph-pencil"></i>
                   </button>`
                : '';

            return `
                <div class="ehr-item ${approvedClass}" data-category="${category}" data-id="${item.id}">
                    <div class="ehr-item-content">
                        <div class="ehr-item-header">
                            <span class="ehr-item-name">${itemName}</span>
                            ${badge}
                        </div>
                        ${details ? `<div class="ehr-item-detail">${details}</div>` : ''}
                        ${code ? `<div class="ehr-item-code">${code}</div>` : ''}
                    </div>
                    <div class="ehr-item-actions">
                        ${editButton}
                        <button class="btn-icon" onclick="approveEhrItem('${category}', '${item.id}')" title="Approve">
                            <i class="ph ph-check"></i>
                        </button>
                        <button class="btn-icon" onclick="rejectEhrItem('${category}', '${item.id}')" title="Reject">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderOrders(item) {
            const orders = item.extractedData.orders;
            const allOrders = [
                ...orders.medications.map(o => ({ ...o, type: 'medication' })),
                ...orders.labs.map(o => ({ ...o, type: 'lab' })),
                ...orders.consults.map(o => ({ ...o, type: 'consult' })),
                ...orders.procedures.map(o => ({ ...o, type: 'procedure' }))
            ];

            // Show transcript panel with formatting
            elements.ordersTranscriptPanel.style.display = 'block';
            elements.ordersTranscriptText.innerHTML = formatTranscript(item.transcript);

            // Show action bar if there are orders
            document.getElementById('ordersActionBar').style.display = allOrders.length > 0 ? 'flex' : 'none';

            // Set up audio playback
            const audioPlayer = document.getElementById('ordersTranscriptAudioPlayer');
            const playBtn = document.getElementById('playOrdersTranscriptAudio');
            if (audioPlayer && item.audioBlob) {
                if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
                    URL.revokeObjectURL(audioPlayer.src);
                }
                audioPlayer.src = URL.createObjectURL(item.audioBlob);
                playBtn.style.display = '';
            } else if (playBtn) {
                playBtn.style.display = 'none';
            }

            if (allOrders.length === 0) {
                elements.ordersEmpty.style.display = 'block';
                elements.ordersList.innerHTML = '';
                return;
            }

            elements.ordersEmpty.style.display = 'none';
            elements.ordersList.innerHTML = allOrders.map(order => {
                const approvedClass = order.approved === true ? 'approved' : order.approved === false ? 'rejected' : '';

                // Check if medication is unmatched in RxNorm database
                const isUnmatched = order.type === 'medication' && order.rxnorm_matched === false;
                const unmatchedClass = isUnmatched ? 'unmatched' : '';

                // Build verification badge for medications
                let verificationBadge = '';
                if (order.type === 'medication') {
                    if (order.rxnorm_matched === true) {
                        verificationBadge = `<span class="rxnorm-status verified"><i class="ph ph-seal-check"></i> Verified</span>`;
                    } else if (order.rxnorm_matched === false) {
                        verificationBadge = `<span class="rxnorm-status unverified"><i class="ph ph-warning"></i> Unverified</span>`;
                    }
                }

                // Build unmatched alert banner
                const unmatchedAlert = isUnmatched ? `
                    <div class="unmatched-alert">
                        <i class="ph ph-warning-circle"></i>
                        <span>Medication not found in RxNorm database. Please verify spelling or link to a known medication.</span>
                    </div>
                ` : '';

                // Build linked diagnosis display
                let linkedDiagnosis = '';
                if (order.linked_diagnosis) {
                    const diag = order.linked_diagnosis;
                    linkedDiagnosis = `
                        <div class="linked-diagnosis">
                            <i class="ph ph-link"></i>
                            <code>${diag.icd10 || ''}</code>
                            <span>${diag.display || ''}</span>
                        </div>
                    `;
                }

                // Build diagnosis link section (dropdown instead of drag-drop)
                // Apply to all order types - every order needs an indication
                let diagnosisLinkSection = '';
                if (order.type === 'medication' || order.type === 'lab' || order.type === 'consult' || order.type === 'procedure') {
                    if (order.linked_diagnosis) {
                        // Show existing link with option to change
                        diagnosisLinkSection = `
                            <div class="diagnosis-link-section">
                                ${linkedDiagnosis}
                                <button class="btn-link" onclick="showDiagnosisDropdown('${order.id}')">
                                    <i class="ph ph-swap"></i> Change
                                </button>
                            </div>
                        `;
                    } else {
                        // Show dropdown to link
                        diagnosisLinkSection = `
                            <div class="diagnosis-link-section unlinked">
                                <div class="unlinked-warning">
                                    <i class="ph ph-warning"></i> No linked diagnosis
                                </div>
                                <button class="btn-secondary" onclick="showDiagnosisDropdown('${order.id}')">
                                    <i class="ph ph-link"></i> Link Diagnosis
                                </button>
                            </div>
                        `;
                    }
                }

                // Build dosage display with frequency
                let dosageDisplay = '';
                if (order.dosage || order.frequency) {
                    const parts = [];
                    if (order.dosage) parts.push(order.dosage);
                    if (order.frequency) parts.push(order.frequency);
                    dosageDisplay = `
                        <div class="order-detail">
                            <span class="order-detail-label">Dosage:</span>
                            <span>${parts.join(' ')}</span>
                        </div>
                    `;
                }

                return `
                    <div class="order-card ${approvedClass} ${unmatchedClass}" data-type="${order.type}" data-id="${order.id}">
                        <div class="order-card-header">
                            <span class="order-type-badge ${order.type}">${order.type.charAt(0).toUpperCase() + order.type.slice(1)}</span>
                            <strong>${order.specialty || order.name}</strong>
                            ${verificationBadge}
                        </div>
                        <div class="order-card-body">
                            ${unmatchedAlert}
                            ${dosageDisplay}
                            ${order.instructions ? `
                                <div class="order-detail">
                                    <span class="order-detail-label">Instructions:</span>
                                    <span>${order.instructions}</span>
                                </div>
                            ` : ''}
                            ${order.code ? `
                                <div class="order-detail">
                                    <span class="order-detail-label">Code:</span>
                                    <span style="font-family: monospace;">${order.code}</span>
                                </div>
                            ` : ''}
                            ${diagnosisLinkSection}
                        </div>
                        <div class="order-card-actions">
                            <button class="btn-secondary" onclick="editOrder('${order.type}', '${order.id}')">
                                <i class="ph ph-pencil"></i> Edit
                            </button>
                            <button class="btn-secondary" onclick="approveOrder('${order.type}', '${order.id}')">
                                <i class="ph ph-check"></i> Approve
                            </button>
                            <button class="btn-secondary" onclick="rejectOrder('${order.type}', '${order.id}')">
                                <i class="ph ph-x"></i> Reject
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function approveEhrItem(category, id) {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const dataItem = item.extractedData[category]?.find(i => i.id === id);
            if (dataItem) {
                dataItem.approved = true;
                renderEhrData(item);
            }
        }

        function rejectEhrItem(category, id) {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const dataItem = item.extractedData[category]?.find(i => i.id === id);
            if (dataItem) {
                dataItem.approved = false;
                renderEhrData(item);
            }
        }

        function editCondition(id) {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const condition = item.extractedData.conditions?.find(c => c.id === id);
            if (!condition) return;

            // Populate modal with current values
            document.getElementById('editConditionId').value = id;
            document.getElementById('editConditionName').value = condition.name || '';
            document.getElementById('editConditionIcd10').value = condition.icd10 || '';
            document.getElementById('editConditionStatus').value = condition.status || 'active';

            // Show modal
            document.getElementById('editConditionModal').classList.add('visible');
        }

        function closeEditConditionModal() {
            document.getElementById('editConditionModal').classList.remove('visible');
        }

        function saveConditionEdit() {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const id = document.getElementById('editConditionId').value;
            const condition = item.extractedData.conditions?.find(c => c.id === id);
            if (!condition) return;

            // Update condition with new values
            condition.name = document.getElementById('editConditionName').value.trim();
            condition.icd10 = document.getElementById('editConditionIcd10').value.trim() || null;
            condition.status = document.getElementById('editConditionStatus').value;

            // Close modal and re-render
            closeEditConditionModal();
            renderEhrData(item);
        }

        // ============================================================================
        // Edit Order Modal Functions
        // ============================================================================
        function editOrder(type, id) {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const orderList = item.extractedData.orders[type + 's'];
            const order = orderList?.find(o => o.id === id);
            if (!order) return;

            // Populate hidden fields
            document.getElementById('editOrderId').value = id;
            document.getElementById('editOrderType').value = type;

            // Populate common fields (use specialty for consults)
            document.getElementById('editOrderName').value = order.specialty || order.name || '';

            // Show/hide type-specific fields
            const medFields = document.getElementById('editOrderMedicationFields');
            const consultFields = document.getElementById('editOrderConsultFields');

            if (type === 'medication') {
                medFields.style.display = 'block';
                consultFields.style.display = 'none';
                document.getElementById('editOrderDosage').value = order.dosage || '';
                document.getElementById('editOrderFrequency').value = order.frequency || '';
                document.getElementById('editOrderInstructions').value = order.instructions || '';
            } else if (type === 'consult') {
                medFields.style.display = 'none';
                consultFields.style.display = 'block';
                document.getElementById('editOrderReason').value = order.reason || '';
            } else {
                medFields.style.display = 'none';
                consultFields.style.display = 'none';
            }

            // Display linked diagnosis if present
            const diagDisplay = document.getElementById('editOrderLinkedDiagnosis');
            if (order.linked_diagnosis) {
                const diag = order.linked_diagnosis;
                diagDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        <i class="ph ph-link" style="color: var(--color-info);"></i>
                        <code style="font-family: monospace; font-weight: 500;">${diag.icd10 || ''}</code>
                        <span>${diag.display || ''}</span>
                        <span style="color: var(--color-text-muted); font-size: 0.75rem;">(${diag.method || 'auto'})</span>
                    </div>
                `;
            } else {
                diagDisplay.innerHTML = '<span style="color: var(--color-text-muted);">No diagnosis linked</span>';
            }

            // Show modal
            document.getElementById('editOrderModal').classList.add('visible');
        }

        function closeEditOrderModal() {
            document.getElementById('editOrderModal').classList.remove('visible');
        }

        function saveOrderEdit() {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const id = document.getElementById('editOrderId').value;
            const type = document.getElementById('editOrderType').value;

            const orderList = item.extractedData.orders[type + 's'];
            const order = orderList?.find(o => o.id === id);
            if (!order) return;

            // Update common fields (use specialty for consults, name for others)
            const nameValue = document.getElementById('editOrderName').value.trim();
            if (type === 'consult') {
                order.specialty = nameValue;
            } else {
                order.name = nameValue;
            }

            // Update type-specific fields
            if (type === 'medication') {
                order.dosage = document.getElementById('editOrderDosage').value.trim() || null;
                order.frequency = document.getElementById('editOrderFrequency').value || null;
                order.instructions = document.getElementById('editOrderInstructions').value.trim() || null;
            } else if (type === 'consult') {
                order.reason = document.getElementById('editOrderReason').value.trim() || null;
            }

            // Close modal and re-render
            closeEditOrderModal();
            renderOrders(item);
            showToast('Order updated', 'success');
        }

        // ============================================================================
        // Order-Diagnosis Linking (Dropdown)
        // ============================================================================
        let currentLinkingOrderId = null;

        function showDiagnosisDropdown(orderId) {
            currentLinkingOrderId = orderId;
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const conditions = item.extractedData.conditions || [];
            const modal = document.getElementById('diagnosisLinkModal');
            const conditionsList = document.getElementById('diagnosisLinkConditions');

            // Build condition options
            let optionsHtml = conditions.map(c => `
                <button class="diagnosis-option" onclick="linkOrderToDiagnosisById('${orderId}', '${c.id}')">
                    ${c.icd10 ? `<code class="icd10-code">${c.icd10}</code>` : '<code class="icd10-code empty">--</code>'}
                    <span class="condition-name">${c.name}</span>
                    ${c.status === 'resolved' ? '<span class="status-badge resolved">Resolved</span>' : ''}
                </button>
            `).join('');

            // Add "Create New Diagnosis" option
            optionsHtml += `
                <button class="diagnosis-option create-new" onclick="showCreateDiagnosisForm('${orderId}')">
                    <i class="ph ph-plus-circle"></i>
                    <span>Create New Diagnosis</span>
                </button>
            `;

            conditionsList.innerHTML = optionsHtml;

            // Show new diagnosis form (hidden by default)
            document.getElementById('newDiagnosisForm').style.display = 'none';
            document.getElementById('newDiagnosisName').value = '';
            document.getElementById('newDiagnosisIcd10').value = '';

            modal.classList.add('visible');
        }

        function closeDiagnosisLinkModal() {
            document.getElementById('diagnosisLinkModal').classList.remove('visible');
            currentLinkingOrderId = null;
        }

        function showCreateDiagnosisForm(orderId) {
            document.getElementById('newDiagnosisForm').style.display = 'block';
            document.getElementById('newDiagnosisName').focus();
        }

        function createAndLinkDiagnosis() {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item || !currentLinkingOrderId) return;

            const name = document.getElementById('newDiagnosisName').value.trim();
            const icd10 = document.getElementById('newDiagnosisIcd10').value.trim();

            if (!name) {
                showToast('Please enter a diagnosis name', 'error');
                return;
            }

            // Create new condition
            const newCondition = {
                id: `cond-${Date.now()}`,
                name: name,
                icd10: icd10 || null,
                status: 'active',
                severity: null,
                isChiefComplaint: false,
                approved: null
            };

            // Add to conditions list
            item.extractedData.conditions.push(newCondition);

            // Link the order to this new condition
            linkOrderToDiagnosis(currentLinkingOrderId, newCondition);

            closeDiagnosisLinkModal();
            renderEhrData(item);
        }

        function linkOrderToDiagnosisById(orderId, conditionId) {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const condition = item.extractedData.conditions?.find(c => c.id === conditionId);
            if (!condition) return;

            linkOrderToDiagnosis(orderId, condition);
            closeDiagnosisLinkModal();
        }

        function linkOrderToDiagnosis(orderId, condition) {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            // Search all order types
            const orders = item.extractedData.orders;
            const order = orders.medications?.find(o => o.id === orderId) ||
                          orders.labs?.find(o => o.id === orderId) ||
                          orders.consults?.find(o => o.id === orderId) ||
                          orders.procedures?.find(o => o.id === orderId);
            if (!order) return;

            // Link the order to the diagnosis
            order.linked_diagnosis = {
                icd10: condition.icd10 || '',
                display: condition.name,
                confidence: 1.0,
                method: 'manual'
            };

            // Re-render orders
            renderOrders(item);
            const orderName = order.specialty || order.name;
            showToast(`Linked ${orderName} to ${condition.name}`, 'success');
        }

        function unlinkOrderDiagnosis(orderId) {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            // Search all order types
            const orders = item.extractedData.orders;
            const order = orders.medications?.find(o => o.id === orderId) ||
                          orders.labs?.find(o => o.id === orderId) ||
                          orders.consults?.find(o => o.id === orderId) ||
                          orders.procedures?.find(o => o.id === orderId);
            if (!order) return;

            order.linked_diagnosis = null;
            renderOrders(item);
            const orderName = order.specialty || order.name;
            showToast(`Unlinked diagnosis from ${orderName}`, 'info');
        }

        function approveOrder(type, id) {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const orderList = item.extractedData.orders[type + 's'];
            const order = orderList?.find(o => o.id === id);
            if (order) {
                order.approved = true;
                renderOrders(item);
            }
        }

        function rejectOrder(type, id) {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const orderList = item.extractedData.orders[type + 's'];
            const order = orderList?.find(o => o.id === id);
            if (order) {
                order.approved = false;
                renderOrders(item);
            }
        }

        // ============================================================================
        // Approve All Functions
        // ============================================================================
        function approveAllEhrItems() {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const categories = ['vitals', 'conditions', 'medications', 'allergies', 'labResults', 'procedures', 'familyHistory'];
            let count = 0;

            categories.forEach(cat => {
                const items = item.extractedData[cat];
                if (items && Array.isArray(items)) {
                    items.forEach(dataItem => {
                        if (dataItem.approved !== true) {
                            dataItem.approved = true;
                            count++;
                        }
                    });
                }
            });

            renderEhrData(item);
            showToast(`Approved ${count} EHR items`, 'success');
        }

        function approveAllOrders() {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            const orderTypes = ['medications', 'labs', 'consults', 'procedures'];
            let count = 0;

            orderTypes.forEach(type => {
                const orders = item.extractedData.orders[type];
                if (orders && Array.isArray(orders)) {
                    orders.forEach(order => {
                        if (order.approved !== true) {
                            order.approved = true;
                            count++;
                        }
                    });
                }
            });

            renderOrders(item);
            showToast(`Approved ${count} orders`, 'success');
        }

        // ============================================================================
        // Add EHR Item Modal
        // ============================================================================
        const addEhrState = {
            inputMethod: 'voice',
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            stream: null,
            transcribedText: ''
        };

        function openAddEhrItemModal() {
            const modal = document.getElementById('addEhrItemModal');
            modal.classList.add('visible');
            updateAddEhrTextFields();
        }

        function closeAddEhrItemModal() {
            const modal = document.getElementById('addEhrItemModal');
            modal.classList.remove('visible');

            // Reset state
            if (addEhrState.isRecording) {
                stopAddEhrRecording();
            }
            addEhrState.transcribedText = '';
            document.getElementById('addEhrVoiceResult').style.display = 'none';
            document.getElementById('addEhrVoiceText').textContent = '';

            // Reset button state
            const recordBtn = document.getElementById('addEhrRecordBtn');
            recordBtn.classList.remove('recording', 'transcribing');
            recordBtn.innerHTML = '<i class="ph ph-microphone"></i>';

            const status = document.getElementById('addEhrVoiceStatus');
            status.innerHTML = '<i class="ph ph-microphone"></i><span>Click to start recording</span>';
        }

        function setAddEhrInputMethod(method) {
            addEhrState.inputMethod = method;

            // Update toggle buttons
            document.querySelectorAll('.input-method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });

            // Show/hide input sections
            document.getElementById('addEhrVoiceInput').style.display = method === 'voice' ? 'flex' : 'none';
            document.getElementById('addEhrTextInput').style.display = method === 'text' ? 'block' : 'none';

            if (method === 'text') {
                updateAddEhrTextFields();
            }
        }

        function setAddEhrItemType(type) {
            // Update hidden input
            document.getElementById('addEhrItemType').value = type;

            // Update pill buttons
            document.querySelectorAll('#addEhrItemTypePills .pill-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === type);
            });

            // Update text fields if in text mode
            if (addEhrState.inputMethod === 'text') {
                updateAddEhrTextFields();
            }
        }

        function updateAddEhrTextFields() {
            const type = document.getElementById('addEhrItemType').value;
            const container = document.getElementById('addEhrTextInput');

            const fieldConfigs = {
                conditions: [
                    { name: 'name', label: 'Condition Name', type: 'text', required: true, autocomplete: 'conditions' },
                    { name: 'icd10', label: 'ICD-10 Code', type: 'text', placeholder: 'e.g., E11.9' },
                    { name: 'status', label: 'Status', type: 'select', options: ['active', 'resolved', 'chronic'] }
                ],
                medications: [
                    { name: 'name', label: 'Medication Name', type: 'text', required: true, autocomplete: 'medications' },
                    { name: 'dosage', label: 'Dosage', type: 'text', placeholder: 'e.g., 500mg twice daily' },
                    { name: 'route', label: 'Route', type: 'select', options: ['oral', 'IV', 'IM', 'topical', 'inhaled', 'sublingual'] }
                ],
                allergies: [
                    { name: 'substance', label: 'Allergen', type: 'text', required: true, autocomplete: 'allergies' },
                    { name: 'reaction', label: 'Reaction', type: 'text', placeholder: 'e.g., rash, anaphylaxis' },
                    { name: 'severity', label: 'Severity', type: 'select', options: ['mild', 'moderate', 'severe'] }
                ],
                vitals: [
                    { name: 'name', label: 'Vital Sign', type: 'pills', options: [
                        { value: 'Blood Pressure', label: 'BP', icon: 'heartbeat', defaultUnit: 'mmHg' },
                        { value: 'Heart Rate', label: 'HR', icon: 'heartbeat', defaultUnit: 'bpm' },
                        { value: 'Temperature', label: 'Temp', icon: 'thermometer', defaultUnit: 'F' },
                        { value: 'Respiratory Rate', label: 'RR', icon: 'wind', defaultUnit: '/min' },
                        { value: 'O2 Saturation', label: 'SpO2', icon: 'drop', defaultUnit: '%' },
                        { value: 'Weight', label: 'Weight', icon: 'scales', defaultUnit: 'lbs' }
                    ]},
                    { name: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 120/80' },
                    { name: 'unit', label: 'Unit', type: 'text', placeholder: 'e.g., mmHg, bpm' }
                ],
                labResults: [
                    { name: 'name', label: 'Lab Test', type: 'text', required: true, autocomplete: 'labs' },
                    { name: 'value', label: 'Result', type: 'text', required: true },
                    { name: 'unit', label: 'Unit', type: 'text' },
                    { name: 'interpretation', label: 'Interpretation', type: 'select', options: ['normal', 'abnormal', 'high', 'low', 'critical'] }
                ],
                procedures: [
                    { name: 'name', label: 'Procedure Name', type: 'text', required: true, autocomplete: 'procedures' },
                    { name: 'status', label: 'Status', type: 'select', options: ['completed', 'planned', 'in-progress'] }
                ],
                familyHistory: [
                    { name: 'relationship', label: 'Relationship', type: 'pills', options: [
                        { value: 'mother', label: 'Mother', icon: 'user' },
                        { value: 'father', label: 'Father', icon: 'user' },
                        { value: 'sibling', label: 'Sibling', icon: 'users' },
                        { value: 'grandmother', label: 'Grandma', icon: 'user' },
                        { value: 'grandfather', label: 'Grandpa', icon: 'user' },
                        { value: 'aunt', label: 'Aunt', icon: 'user' },
                        { value: 'uncle', label: 'Uncle', icon: 'user' }
                    ]},
                    { name: 'condition', label: 'Condition', type: 'text', required: true, autocomplete: 'conditions' },
                    { name: 'ageOfOnset', label: 'Age of Onset', type: 'text', placeholder: 'e.g., 55' }
                ]
            };

            const fields = fieldConfigs[type] || [];
            container.innerHTML = fields.map(field => {
                if (field.type === 'pills') {
                    // Pill selector with icons
                    return `
                        <div class="form-group">
                            <label>${field.label}${field.required ? ' *' : ''}</label>
                            <div class="pill-selector" id="addEhr_${field.name}_pills">
                                ${field.options.map(opt => `
                                    <button type="button" class="pill-btn" data-value="${opt.value}" data-default-unit="${opt.defaultUnit || ''}"
                                            onclick="selectPillOption('${field.name}', '${opt.value}', '${opt.defaultUnit || ''}')">
                                        ${opt.icon ? `<i class="ph ph-${opt.icon}"></i>` : ''}
                                        ${opt.label}
                                    </button>
                                `).join('')}
                            </div>
                            <input type="hidden" id="addEhr_${field.name}" value="">
                        </div>
                    `;
                } else if (field.type === 'select') {
                    return `
                        <div class="form-group">
                            <label>${field.label}${field.required ? ' *' : ''}</label>
                            <select id="addEhr_${field.name}" ${field.required ? 'required' : ''}>
                                <option value="">Select...</option>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else {
                    return `
                        <div class="form-group">
                            <label>${field.label}${field.required ? ' *' : ''}</label>
                            <input type="text" id="addEhr_${field.name}"
                                   placeholder="${field.placeholder || ''}"
                                   ${field.required ? 'required' : ''}
                                   ${field.autocomplete ? `data-autocomplete="${field.autocomplete}"` : ''}>
                        </div>
                    `;
                }
            }).join('');

            // Initialize autocomplete on fields that have it
            setTimeout(() => {
                fields.forEach(field => {
                    if (field.autocomplete) {
                        createAutocomplete(`addEhr_${field.name}`, field.autocomplete);
                    }
                });
            }, 50);
        }

        function selectPillOption(fieldName, value, defaultUnit) {
            // Update hidden input
            const hiddenInput = document.getElementById(`addEhr_${fieldName}`);
            if (hiddenInput) hiddenInput.value = value;

            // Update pill button states
            const container = document.getElementById(`addEhr_${fieldName}_pills`);
            if (container) {
                container.querySelectorAll('.pill-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === value);
                });
            }

            // Auto-fill unit for vitals if applicable
            if (fieldName === 'name' && defaultUnit) {
                const unitInput = document.getElementById('addEhr_unit');
                if (unitInput && !unitInput.value) {
                    unitInput.value = defaultUnit;
                }
            }
        }

        // ============================================================================
        // Autocomplete Data Sources and Component
        // ============================================================================
        const AUTOCOMPLETE_SOURCES = {
            medications: [
                // Common medications from RxNorm database (subset)
                { name: 'Metformin', code: '6809', class: 'diabetes' },
                { name: 'Lisinopril', code: '29046', class: 'ace_inhibitor' },
                { name: 'Atorvastatin', code: '83367', class: 'statin' },
                { name: 'Amlodipine', code: '17767', class: 'ccb' },
                { name: 'Metoprolol', code: '6918', class: 'beta_blocker' },
                { name: 'Omeprazole', code: '7646', class: 'ppi' },
                { name: 'Losartan', code: '52175', class: 'arb' },
                { name: 'Gabapentin', code: '25480', class: 'anticonvulsant' },
                { name: 'Hydrochlorothiazide', code: '5487', class: 'diuretic' },
                { name: 'Sertraline', code: '36437', class: 'ssri' },
                { name: 'Amoxicillin', code: '723', class: 'antibiotic' },
                { name: 'Azithromycin', code: '18631', class: 'antibiotic' },
                { name: 'Ciprofloxacin', code: '2551', class: 'antibiotic' },
                { name: 'Prednisone', code: '8640', class: 'steroid' },
                { name: 'Albuterol', code: '435', class: 'bronchodilator' },
                { name: 'Levothyroxine', code: '10582', class: 'thyroid' },
                { name: 'Warfarin', code: '11289', class: 'anticoagulant' },
                { name: 'Apixaban', code: '1364430', class: 'anticoagulant' },
                { name: 'Furosemide', code: '4603', class: 'diuretic' },
                { name: 'Pantoprazole', code: '40790', class: 'ppi' },
                { name: 'Clopidogrel', code: '32968', class: 'antiplatelet' },
                { name: 'Escitalopram', code: '321988', class: 'ssri' },
                { name: 'Duloxetine', code: '72625', class: 'snri' },
                { name: 'Simvastatin', code: '36567', class: 'statin' },
                { name: 'Rosuvastatin', code: '301542', class: 'statin' },
                { name: 'Carvedilol', code: '20352', class: 'beta_blocker' },
                { name: 'Ibuprofen', code: '5640', class: 'nsaid' },
                { name: 'Naproxen', code: '7258', class: 'nsaid' },
                { name: 'Acetaminophen', code: '161', class: 'analgesic' },
                { name: 'Tramadol', code: '10689', class: 'opioid' },
            ],
            conditions: [
                // Common conditions from ICD-10 database (subset)
                { name: 'Hypertension', code: 'I10', class: 'cardiovascular' },
                { name: 'Type 2 Diabetes', code: 'E11.9', class: 'endocrine' },
                { name: 'Hyperlipidemia', code: 'E78.5', class: 'endocrine' },
                { name: 'GERD', code: 'K21.0', class: 'gastrointestinal' },
                { name: 'Coronary Artery Disease', code: 'I25.10', class: 'cardiovascular' },
                { name: 'Heart Failure', code: 'I50.9', class: 'cardiovascular' },
                { name: 'Atrial Fibrillation', code: 'I48.91', class: 'cardiovascular' },
                { name: 'COPD', code: 'J44.9', class: 'respiratory' },
                { name: 'Asthma', code: 'J45.909', class: 'respiratory' },
                { name: 'Depression', code: 'F32.9', class: 'psychiatric' },
                { name: 'Anxiety', code: 'F41.9', class: 'psychiatric' },
                { name: 'Chronic Kidney Disease', code: 'N18.9', class: 'renal' },
                { name: 'Hypothyroidism', code: 'E03.9', class: 'endocrine' },
                { name: 'Osteoarthritis', code: 'M19.90', class: 'musculoskeletal' },
                { name: 'Low Back Pain', code: 'M54.50', class: 'musculoskeletal' },
                { name: 'Pneumonia', code: 'J18.9', class: 'respiratory' },
                { name: 'Urinary Tract Infection', code: 'N39.0', class: 'renal' },
                { name: 'Anemia', code: 'D64.9', class: 'hematological' },
                { name: 'Obesity', code: 'E66.9', class: 'endocrine' },
                { name: 'Stroke', code: 'I63.9', class: 'neurological' },
            ],
            labs: [
                { name: 'Complete Blood Count (CBC)', code: '58410-2', class: 'hematology' },
                { name: 'Basic Metabolic Panel (BMP)', code: '51990-0', class: 'chemistry' },
                { name: 'Comprehensive Metabolic Panel (CMP)', code: '24323-8', class: 'chemistry' },
                { name: 'Lipid Panel', code: '24331-1', class: 'chemistry' },
                { name: 'Hemoglobin A1c', code: '4548-4', class: 'chemistry' },
                { name: 'TSH', code: '3016-3', class: 'endocrine' },
                { name: 'Free T4', code: '3024-7', class: 'endocrine' },
                { name: 'Urinalysis', code: '24357-6', class: 'urinalysis' },
                { name: 'Creatinine', code: '2160-0', class: 'chemistry' },
                { name: 'BUN', code: '3094-0', class: 'chemistry' },
                { name: 'Liver Function Panel', code: '24325-3', class: 'chemistry' },
                { name: 'PT/INR', code: '5902-2', class: 'coagulation' },
                { name: 'PTT', code: '3173-2', class: 'coagulation' },
                { name: 'Troponin', code: '10839-9', class: 'cardiac' },
                { name: 'BNP', code: '30934-4', class: 'cardiac' },
                { name: 'D-Dimer', code: '48066-5', class: 'coagulation' },
                { name: 'Blood Culture', code: '600-7', class: 'microbiology' },
                { name: 'Urine Culture', code: '630-4', class: 'microbiology' },
            ],
            consults: [
                { name: 'Cardiology', code: null, class: 'specialty' },
                { name: 'Pulmonology', code: null, class: 'specialty' },
                { name: 'Gastroenterology', code: null, class: 'specialty' },
                { name: 'Neurology', code: null, class: 'specialty' },
                { name: 'Nephrology', code: null, class: 'specialty' },
                { name: 'Endocrinology', code: null, class: 'specialty' },
                { name: 'Orthopedics', code: null, class: 'specialty' },
                { name: 'Rheumatology', code: null, class: 'specialty' },
                { name: 'Psychiatry', code: null, class: 'specialty' },
                { name: 'Infectious Disease', code: null, class: 'specialty' },
                { name: 'Oncology', code: null, class: 'specialty' },
                { name: 'Hematology', code: null, class: 'specialty' },
                { name: 'Surgery (General)', code: null, class: 'surgery' },
                { name: 'Vascular Surgery', code: null, class: 'surgery' },
                { name: 'Physical Therapy', code: null, class: 'rehabilitation' },
                { name: 'Occupational Therapy', code: null, class: 'rehabilitation' },
                { name: 'Dermatology', code: null, class: 'specialty' },
                { name: 'Ophthalmology', code: null, class: 'specialty' },
            ],
            procedures: [
                { name: 'Electrocardiogram (ECG/EKG)', code: '93000', class: 'diagnostic' },
                { name: 'Chest X-Ray', code: '71046', class: 'imaging' },
                { name: 'CT Chest', code: '71250', class: 'imaging' },
                { name: 'CT Abdomen/Pelvis', code: '74177', class: 'imaging' },
                { name: 'CT Head', code: '70450', class: 'imaging' },
                { name: 'MRI Brain', code: '70551', class: 'imaging' },
                { name: 'MRI Spine', code: '72141', class: 'imaging' },
                { name: 'Echocardiogram', code: '93306', class: 'diagnostic' },
                { name: 'Stress Test', code: '93015', class: 'diagnostic' },
                { name: 'Ultrasound Abdomen', code: '76700', class: 'imaging' },
                { name: 'Colonoscopy', code: '45378', class: 'procedure' },
                { name: 'Upper Endoscopy (EGD)', code: '43239', class: 'procedure' },
                { name: 'Lumbar Puncture', code: '62270', class: 'procedure' },
                { name: 'Bronchoscopy', code: '31622', class: 'procedure' },
                { name: 'Bone Density Scan (DEXA)', code: '77080', class: 'imaging' },
            ],
            allergies: [
                { name: 'Penicillin', code: null, class: 'medication' },
                { name: 'Sulfa drugs', code: null, class: 'medication' },
                { name: 'Aspirin', code: null, class: 'medication' },
                { name: 'NSAIDs', code: null, class: 'medication' },
                { name: 'Codeine', code: null, class: 'medication' },
                { name: 'Morphine', code: null, class: 'medication' },
                { name: 'Latex', code: null, class: 'environmental' },
                { name: 'Contrast dye', code: null, class: 'medication' },
                { name: 'Peanuts', code: null, class: 'food' },
                { name: 'Tree nuts', code: null, class: 'food' },
                { name: 'Shellfish', code: null, class: 'food' },
                { name: 'Eggs', code: null, class: 'food' },
                { name: 'Milk', code: null, class: 'food' },
                { name: 'Soy', code: null, class: 'food' },
                { name: 'Wheat', code: null, class: 'food' },
                { name: 'Bee stings', code: null, class: 'environmental' },
            ],
        };

        // Autocomplete component
        let activeAutocomplete = null;
        let highlightedIndex = -1;

        function createAutocomplete(inputId, dataType) {
            const input = document.getElementById(inputId);
            if (!input) return;

            // Wrap input in autocomplete wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'autocomplete-wrapper';
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);

            // Create dropdown list
            const list = document.createElement('div');
            list.className = 'autocomplete-list';
            list.id = `${inputId}_autocomplete`;
            wrapper.appendChild(list);

            // Input event handlers
            let debounceTimer;
            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = input.value.trim().toLowerCase();
                    if (query.length < 2) {
                        hideAutocomplete(list);
                        return;
                    }
                    showAutocomplete(input, list, dataType, query);
                }, 150);
            });

            input.addEventListener('keydown', (e) => {
                if (!list.classList.contains('visible')) return;

                const items = list.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, 0);
                    updateHighlight(items);
                } else if (e.key === 'Enter' && highlightedIndex >= 0) {
                    e.preventDefault();
                    selectAutocompleteItem(items[highlightedIndex], input, list);
                } else if (e.key === 'Escape') {
                    hideAutocomplete(list);
                }
            });

            input.addEventListener('blur', () => {
                // Delay to allow click on list item
                setTimeout(() => hideAutocomplete(list), 200);
            });

            input.addEventListener('focus', () => {
                const query = input.value.trim().toLowerCase();
                if (query.length >= 2) {
                    showAutocomplete(input, list, dataType, query);
                }
            });
        }

        function showAutocomplete(input, list, dataType, query) {
            const source = AUTOCOMPLETE_SOURCES[dataType] || [];
            const matches = source.filter(item =>
                item.name.toLowerCase().includes(query)
            ).slice(0, 10); // Limit to 10 results

            if (matches.length === 0) {
                list.innerHTML = '<div class="autocomplete-no-results">No matches found</div>';
            } else {
                list.innerHTML = matches.map((item, idx) => `
                    <div class="autocomplete-item" data-name="${item.name}" data-code="${item.code || ''}">
                        <span class="autocomplete-item-name">${item.name}</span>
                        ${item.code ? `<span class="autocomplete-item-code">${item.code}</span>` : ''}
                        ${item.class ? `<span class="autocomplete-item-class">${item.class}</span>` : ''}
                    </div>
                `).join('');

                // Add click handlers
                list.querySelectorAll('.autocomplete-item').forEach((el, idx) => {
                    el.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        selectAutocompleteItem(el, input, list);
                    });
                });
            }

            list.classList.add('visible');
            activeAutocomplete = list;
            highlightedIndex = -1;
        }

        function hideAutocomplete(list) {
            list.classList.remove('visible');
            if (activeAutocomplete === list) {
                activeAutocomplete = null;
            }
            highlightedIndex = -1;
        }

        function updateHighlight(items) {
            items.forEach((item, idx) => {
                item.classList.toggle('highlighted', idx === highlightedIndex);
            });
            if (highlightedIndex >= 0 && items[highlightedIndex]) {
                items[highlightedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function selectAutocompleteItem(item, input, list) {
            input.value = item.dataset.name;

            // Try to auto-fill code field if present
            const code = item.dataset.code;
            if (code) {
                // Look for common code field names
                const codeFieldIds = ['addEhr_icd10', 'addEhr_rxnorm', 'addEhr_loinc', 'addEhr_code'];
                for (const fieldId of codeFieldIds) {
                    const codeField = document.getElementById(fieldId);
                    if (codeField) {
                        codeField.value = code;
                        break;
                    }
                }
            }

            hideAutocomplete(list);
            input.focus();
        }

        // Initialize autocomplete on form fields when modal opens
        function initializeAutocomplete() {
            // These mappings define which fields get which autocomplete type
            const fieldMappings = {
                'addEhr_name': null, // Will be set based on item type
                'addEhr_substance': 'allergies',
                'addEhr_condition': 'conditions',
            };

            // Delayed initialization to ensure DOM is ready
            setTimeout(() => {
                Object.entries(fieldMappings).forEach(([fieldId, dataType]) => {
                    if (dataType) {
                        createAutocomplete(fieldId, dataType);
                    }
                });
            }, 100);
        }

        async function toggleAddEhrRecording() {
            if (addEhrState.isRecording) {
                await stopAddEhrRecording();
            } else {
                await startAddEhrRecording();
            }
        }

        async function startAddEhrRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                addEhrState.stream = stream;
                addEhrState.audioChunks = [];
                addEhrState.isRecording = true;

                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                addEhrState.mediaRecorder = mediaRecorder;

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        addEhrState.audioChunks.push(e.data);
                    }
                };

                mediaRecorder.start(100);

                // Update UI
                const recordBtn = document.getElementById('addEhrRecordBtn');
                recordBtn.classList.add('recording');
                recordBtn.innerHTML = '<i class="ph ph-stop"></i>';

                const status = document.getElementById('addEhrVoiceStatus');
                status.innerHTML = '<i class="ph ph-record" style="color: var(--color-error);"></i><span>Recording... Click to stop</span>';

                // Hide previous result
                document.getElementById('addEhrVoiceResult').style.display = 'none';

            } catch (error) {
                console.error('Failed to start recording:', error);
                showToast('Microphone access denied', 'error');
            }
        }

        async function stopAddEhrRecording() {
            if (!addEhrState.mediaRecorder) return;

            return new Promise((resolve) => {
                addEhrState.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(addEhrState.audioChunks, { type: 'audio/webm' });

                    // Cleanup stream
                    if (addEhrState.stream) {
                        addEhrState.stream.getTracks().forEach(track => track.stop());
                    }

                    addEhrState.isRecording = false;

                    // Update UI to transcribing
                    const recordBtn = document.getElementById('addEhrRecordBtn');
                    recordBtn.classList.remove('recording');
                    recordBtn.classList.add('transcribing');
                    recordBtn.innerHTML = '<i class="ph ph-spinner"></i>';

                    const status = document.getElementById('addEhrVoiceStatus');
                    status.innerHTML = '<i class="ph ph-spinner spinning"></i><span>Transcribing...</span>';

                    // Send to MedASR
                    try {
                        const transcript = await transcribeFieldAudio(audioBlob, 'add-ehr-item');
                        addEhrState.transcribedText = transcript;

                        // Show result
                        document.getElementById('addEhrVoiceText').textContent = transcript;
                        document.getElementById('addEhrVoiceResult').style.display = 'flex';

                        status.innerHTML = '<i class="ph ph-check-circle" style="color: var(--color-success);"></i><span>Transcription complete</span>';
                    } catch (error) {
                        console.error('Transcription failed:', error);
                        showToast(`Transcription failed: ${error.message}`, 'error');
                        status.innerHTML = '<i class="ph ph-x-circle" style="color: var(--color-error);"></i><span>Transcription failed</span>';
                    }

                    // Reset button
                    recordBtn.classList.remove('transcribing');
                    recordBtn.innerHTML = '<i class="ph ph-microphone"></i>';

                    resolve();
                };

                addEhrState.mediaRecorder.stop();
            });
        }

        function clearAddEhrVoiceResult() {
            addEhrState.transcribedText = '';
            document.getElementById('addEhrVoiceResult').style.display = 'none';
            document.getElementById('addEhrVoiceText').textContent = '';

            const status = document.getElementById('addEhrVoiceStatus');
            status.innerHTML = '<i class="ph ph-microphone"></i><span>Click to start recording</span>';
        }

        function submitAddEhrItem() {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) {
                showToast('No review item selected', 'error');
                return;
            }

            const type = document.getElementById('addEhrItemType').value;
            let newItem = null;

            if (addEhrState.inputMethod === 'voice') {
                // Use transcribed text to create item
                const text = addEhrState.transcribedText.trim();
                if (!text) {
                    showToast('Please record something first', 'error');
                    return;
                }

                // Create item from voice input (simple parsing)
                newItem = createItemFromVoice(type, text);
            } else {
                // Create item from form fields
                newItem = createItemFromForm(type);
            }

            if (!newItem) {
                showToast('Please fill in the required fields', 'error');
                return;
            }

            // Generate unique ID
            newItem.id = `${type.slice(0, 4)}-${Date.now()}`;
            newItem.approved = true;  // Auto-approve manually added items

            // Add to the appropriate array
            if (!item.extractedData[type]) {
                item.extractedData[type] = [];
            }
            item.extractedData[type].push(newItem);

            // Re-render and close modal
            renderEhrData(item);
            closeAddEhrItemModal();
            showToast(`Added ${type.replace(/([A-Z])/g, ' $1').toLowerCase().trim()}`, 'success');
        }

        function createItemFromVoice(type, text) {
            // Simple item creation from voice text
            // In a full implementation, this could use MedGemma for extraction
            const baseItem = { name: text };

            switch (type) {
                case 'conditions':
                    return { name: text, status: 'active', icd10: null, severity: null };
                case 'medications':
                    return { name: text, dosage: null, route: 'oral' };
                case 'allergies':
                    return { substance: text, reaction: null, severity: 'unknown' };
                case 'vitals':
                    // Try to parse "BP 120/80" or "temperature 98.6"
                    const vitalMatch = text.match(/^(blood pressure|bp|heart rate|hr|temp|temperature|weight|o2|spo2|resp)\s*[:\s]*(.+)$/i);
                    if (vitalMatch) {
                        const vitalTypes = {
                            'blood pressure': 'blood_pressure', 'bp': 'blood_pressure',
                            'heart rate': 'heart_rate', 'hr': 'heart_rate',
                            'temp': 'temperature', 'temperature': 'temperature',
                            'weight': 'weight', 'o2': 'oxygen_saturation', 'spo2': 'oxygen_saturation',
                            'resp': 'respiratory_rate'
                        };
                        return {
                            name: vitalTypes[vitalMatch[1].toLowerCase()] || vitalMatch[1],
                            type: vitalTypes[vitalMatch[1].toLowerCase()] || vitalMatch[1],
                            value: vitalMatch[2].trim(),
                            unit: null
                        };
                    }
                    return { name: text, type: 'other', value: text, unit: null };
                case 'labResults':
                    return { name: text, value: '', unit: null, interpretation: null };
                case 'procedures':
                    return { name: text, status: 'completed' };
                case 'familyHistory':
                    return { relationship: 'unknown', condition: text, ageOfOnset: null };
                default:
                    return { name: text };
            }
        }

        function createItemFromForm(type) {
            const getValue = (fieldName) => {
                const el = document.getElementById(`addEhr_${fieldName}`);
                return el ? el.value.trim() : '';
            };

            switch (type) {
                case 'conditions':
                    const condName = getValue('name');
                    if (!condName) return null;
                    return {
                        name: condName,
                        icd10: getValue('icd10') || null,
                        status: getValue('status') || 'active',
                        severity: null
                    };
                case 'medications':
                    const medName = getValue('name');
                    if (!medName) return null;
                    return {
                        name: medName,
                        dosage: getValue('dosage') || null,
                        route: getValue('route') || 'oral'
                    };
                case 'allergies':
                    const allergen = getValue('substance');
                    if (!allergen) return null;
                    return {
                        substance: allergen,
                        reaction: getValue('reaction') || null,
                        severity: getValue('severity') || 'unknown'
                    };
                case 'vitals':
                    const vitalName = getValue('name');
                    const vitalValue = getValue('value');
                    if (!vitalValue) return null;
                    const typeMap = {
                        'Blood Pressure': 'blood_pressure',
                        'Heart Rate': 'heart_rate',
                        'Temperature': 'temperature',
                        'Respiratory Rate': 'respiratory_rate',
                        'O2 Saturation': 'oxygen_saturation',
                        'Weight': 'weight'
                    };
                    return {
                        name: vitalName || 'Vital',
                        type: typeMap[vitalName] || vitalName?.toLowerCase().replace(/\s+/g, '_'),
                        value: vitalValue,
                        unit: getValue('unit') || null
                    };
                case 'labResults':
                    const labName = getValue('name');
                    const labValue = getValue('value');
                    if (!labName || !labValue) return null;
                    return {
                        name: labName,
                        value: labValue,
                        unit: getValue('unit') || null,
                        interpretation: getValue('interpretation') || null
                    };
                case 'procedures':
                    const procName = getValue('name');
                    if (!procName) return null;
                    return {
                        name: procName,
                        status: getValue('status') || 'completed'
                    };
                case 'familyHistory':
                    const condition = getValue('condition');
                    if (!condition) return null;
                    return {
                        relationship: getValue('relationship') || 'unknown',
                        condition: condition,
                        ageOfOnset: getValue('ageOfOnset') || null
                    };
                default:
                    return null;
            }
        }

        // ============================================================================
        // Add Order Modal
        // ============================================================================
        const addOrderState = {
            inputMethod: 'voice',
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            stream: null,
            transcribedText: ''
        };

        function openAddOrderModal() {
            const modal = document.getElementById('addOrderModal');
            modal.classList.add('visible');
            updateAddOrderTextFields();
        }

        function closeAddOrderModal() {
            const modal = document.getElementById('addOrderModal');
            modal.classList.remove('visible');

            // Reset state
            if (addOrderState.isRecording) {
                stopAddOrderRecording();
            }
            addOrderState.transcribedText = '';
            document.getElementById('addOrderVoiceResult').style.display = 'none';
            document.getElementById('addOrderVoiceText').textContent = '';

            // Reset button state
            const recordBtn = document.getElementById('addOrderRecordBtn');
            recordBtn.classList.remove('recording', 'transcribing');
            recordBtn.innerHTML = '<i class="ph ph-microphone"></i>';

            const status = document.getElementById('addOrderVoiceStatus');
            status.innerHTML = '<i class="ph ph-microphone"></i><span>Click to start recording</span>';
        }

        function setAddOrderInputMethod(method) {
            addOrderState.inputMethod = method;

            // Update toggle buttons in the order modal
            document.querySelectorAll('#addOrderModal .input-method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });

            // Show/hide input sections
            document.getElementById('addOrderVoiceInput').style.display = method === 'voice' ? 'flex' : 'none';
            document.getElementById('addOrderTextInput').style.display = method === 'text' ? 'block' : 'none';

            if (method === 'text') {
                updateAddOrderTextFields();
            }
        }

        function setAddOrderType(type) {
            // Update hidden input
            document.getElementById('addOrderType').value = type;

            // Update pill buttons
            document.querySelectorAll('#addOrderTypePills .pill-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === type);
            });

            // Update text fields if in text mode
            if (addOrderState.inputMethod === 'text') {
                updateAddOrderTextFields();
            }
        }

        function updateAddOrderTextFields() {
            const type = document.getElementById('addOrderType').value;
            const container = document.getElementById('addOrderTextInput');

            const fieldConfigs = {
                medications: [
                    { name: 'name', label: 'Medication Name', type: 'text', required: true, placeholder: 'e.g., Amoxicillin', autocomplete: 'medications' },
                    { name: 'dosage', label: 'Dosage', type: 'text', placeholder: 'e.g., 500mg three times daily' },
                    { name: 'route', label: 'Route', type: 'select', options: ['oral', 'IV', 'IM', 'topical', 'inhaled', 'sublingual', 'rectal'] },
                    { name: 'duration', label: 'Duration', type: 'text', placeholder: 'e.g., 10 days' },
                    { name: 'instructions', label: 'Instructions', type: 'text', placeholder: 'e.g., Take with food' }
                ],
                labs: [
                    { name: 'name', label: 'Lab Test', type: 'text', required: true, placeholder: 'e.g., CBC, BMP, Lipid Panel', autocomplete: 'labs' },
                    { name: 'priority', label: 'Priority', type: 'select', options: ['routine', 'urgent', 'stat'] },
                    { name: 'instructions', label: 'Special Instructions', type: 'text', placeholder: 'e.g., Fasting required' }
                ],
                consults: [
                    { name: 'name', label: 'Specialty / Service', type: 'text', required: true, placeholder: 'e.g., Cardiology, Physical Therapy', autocomplete: 'consults' },
                    { name: 'reason', label: 'Reason for Consult', type: 'text', placeholder: 'e.g., Evaluation of chest pain' },
                    { name: 'priority', label: 'Priority', type: 'select', options: ['routine', 'urgent', 'emergent'] }
                ],
                procedures: [
                    { name: 'name', label: 'Procedure Name', type: 'text', required: true, placeholder: 'e.g., Chest X-ray, ECG, MRI', autocomplete: 'procedures' },
                    { name: 'priority', label: 'Priority', type: 'select', options: ['routine', 'urgent', 'stat'] },
                    { name: 'instructions', label: 'Special Instructions', type: 'text', placeholder: 'e.g., With contrast' }
                ]
            };

            const fields = fieldConfigs[type] || [];
            container.innerHTML = fields.map(field => {
                if (field.type === 'select') {
                    return `
                        <div class="form-group">
                            <label>${field.label}${field.required ? ' *' : ''}</label>
                            <select id="addOrder_${field.name}" ${field.required ? 'required' : ''}>
                                <option value="">Select...</option>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else {
                    return `
                        <div class="form-group">
                            <label>${field.label}${field.required ? ' *' : ''}</label>
                            <input type="text" id="addOrder_${field.name}"
                                   placeholder="${field.placeholder || ''}"
                                   ${field.required ? 'required' : ''}
                                   ${field.autocomplete ? `data-autocomplete="${field.autocomplete}"` : ''}>
                        </div>
                    `;
                }
            }).join('');

            // Initialize autocomplete on fields that have it
            setTimeout(() => {
                fields.forEach(field => {
                    if (field.autocomplete) {
                        createAutocomplete(`addOrder_${field.name}`, field.autocomplete);
                    }
                });
            }, 50);
        }

        async function toggleAddOrderRecording() {
            if (addOrderState.isRecording) {
                await stopAddOrderRecording();
            } else {
                await startAddOrderRecording();
            }
        }

        async function startAddOrderRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                addOrderState.stream = stream;
                addOrderState.audioChunks = [];
                addOrderState.isRecording = true;

                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                addOrderState.mediaRecorder = mediaRecorder;

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        addOrderState.audioChunks.push(e.data);
                    }
                };

                mediaRecorder.start(100);

                // Update UI
                const recordBtn = document.getElementById('addOrderRecordBtn');
                recordBtn.classList.add('recording');
                recordBtn.innerHTML = '<i class="ph ph-stop"></i>';

                const status = document.getElementById('addOrderVoiceStatus');
                status.innerHTML = '<i class="ph ph-record" style="color: var(--color-error);"></i><span>Recording... Click to stop</span>';

                // Hide previous result
                document.getElementById('addOrderVoiceResult').style.display = 'none';

            } catch (error) {
                console.error('Failed to start recording:', error);
                showToast('Microphone access denied', 'error');
            }
        }

        async function stopAddOrderRecording() {
            if (!addOrderState.mediaRecorder) return;

            return new Promise((resolve) => {
                addOrderState.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(addOrderState.audioChunks, { type: 'audio/webm' });

                    // Cleanup stream
                    if (addOrderState.stream) {
                        addOrderState.stream.getTracks().forEach(track => track.stop());
                    }

                    addOrderState.isRecording = false;

                    // Update UI to transcribing
                    const recordBtn = document.getElementById('addOrderRecordBtn');
                    recordBtn.classList.remove('recording');
                    recordBtn.classList.add('transcribing');
                    recordBtn.innerHTML = '<i class="ph ph-spinner"></i>';

                    const status = document.getElementById('addOrderVoiceStatus');
                    status.innerHTML = '<i class="ph ph-spinner spinning"></i><span>Transcribing...</span>';

                    // Send to MedASR
                    try {
                        const transcript = await transcribeFieldAudio(audioBlob, 'add-order');
                        addOrderState.transcribedText = transcript;

                        // Show result
                        document.getElementById('addOrderVoiceText').textContent = transcript;
                        document.getElementById('addOrderVoiceResult').style.display = 'flex';

                        status.innerHTML = '<i class="ph ph-check-circle" style="color: var(--color-success);"></i><span>Transcription complete</span>';
                    } catch (error) {
                        console.error('Transcription failed:', error);
                        showToast(`Transcription failed: ${error.message}`, 'error');
                        status.innerHTML = '<i class="ph ph-x-circle" style="color: var(--color-error);"></i><span>Transcription failed</span>';
                    }

                    // Reset button
                    recordBtn.classList.remove('transcribing');
                    recordBtn.innerHTML = '<i class="ph ph-microphone"></i>';

                    resolve();
                };

                addOrderState.mediaRecorder.stop();
            });
        }

        function clearAddOrderVoiceResult() {
            addOrderState.transcribedText = '';
            document.getElementById('addOrderVoiceResult').style.display = 'none';
            document.getElementById('addOrderVoiceText').textContent = '';

            const status = document.getElementById('addOrderVoiceStatus');
            status.innerHTML = '<i class="ph ph-microphone"></i><span>Click to start recording</span>';
        }

        function submitAddOrder() {
            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) {
                showToast('No review item selected', 'error');
                return;
            }

            const type = document.getElementById('addOrderType').value;
            let newOrder = null;

            if (addOrderState.inputMethod === 'voice') {
                // Use transcribed text to create order
                const text = addOrderState.transcribedText.trim();
                if (!text) {
                    showToast('Please record something first', 'error');
                    return;
                }

                // Create order from voice input
                newOrder = createOrderFromVoice(type, text);
            } else {
                // Create order from form fields
                newOrder = createOrderFromForm(type);
            }

            if (!newOrder) {
                showToast('Please fill in the required fields', 'error');
                return;
            }

            // Generate unique ID
            newOrder.id = `ord-${type.slice(0, 3)}-${Date.now()}`;
            newOrder.approved = true;  // Auto-approve manually added orders

            // Add to the appropriate orders array
            if (!item.extractedData.orders[type]) {
                item.extractedData.orders[type] = [];
            }
            item.extractedData.orders[type].push(newOrder);

            // Re-render and close modal
            renderOrders(item);
            closeAddOrderModal();

            const typeLabels = {
                medications: 'medication order',
                labs: 'lab order',
                consults: 'consult',
                procedures: 'procedure order'
            };
            showToast(`Added ${typeLabels[type] || 'order'}`, 'success');
        }

        function createOrderFromVoice(type, text) {
            // Simple order creation from voice text
            switch (type) {
                case 'medications':
                    // Try to parse dosage from text like "Amoxicillin 500mg three times daily"
                    const medMatch = text.match(/^([a-zA-Z\-]+)\s*(\d+\s*m?g)?(.*)$/i);
                    if (medMatch) {
                        return {
                            name: medMatch[1],
                            dosage: ((medMatch[2] || '') + (medMatch[3] || '')).trim() || null,
                            route: 'oral',
                            duration: null,
                            instructions: null
                        };
                    }
                    return { name: text, dosage: null, route: 'oral', duration: null, instructions: null };

                case 'labs':
                    return { name: text, priority: 'routine', instructions: null };

                case 'consults':
                    // Try to parse "cardiology for chest pain"
                    const consultMatch = text.match(/^(.+?)\s+(?:for|to evaluate|regarding)\s+(.+)$/i);
                    if (consultMatch) {
                        return {
                            name: consultMatch[1].trim(),
                            reason: consultMatch[2].trim(),
                            priority: 'routine'
                        };
                    }
                    return { name: text, reason: null, priority: 'routine' };

                case 'procedures':
                    return { name: text, priority: 'routine', instructions: null };

                default:
                    return { name: text };
            }
        }

        function createOrderFromForm(type) {
            const getValue = (fieldName) => {
                const el = document.getElementById(`addOrder_${fieldName}`);
                return el ? el.value.trim() : '';
            };

            const name = getValue('name');
            if (!name) return null;

            switch (type) {
                case 'medications':
                    return {
                        name: name,
                        dosage: getValue('dosage') || null,
                        route: getValue('route') || 'oral',
                        duration: getValue('duration') || null,
                        instructions: getValue('instructions') || null
                    };

                case 'labs':
                    return {
                        name: name,
                        priority: getValue('priority') || 'routine',
                        instructions: getValue('instructions') || null
                    };

                case 'consults':
                    return {
                        name: name,
                        reason: getValue('reason') || null,
                        priority: getValue('priority') || 'routine'
                    };

                case 'procedures':
                    return {
                        name: name,
                        priority: getValue('priority') || 'routine',
                        instructions: getValue('instructions') || null
                    };

                default:
                    return { name: name };
            }
        }

        // ============================================================================
        // About Modal / Interactive Pipeline
        // ============================================================================
        const pipelineContent = {
            medasr: {
                title: 'MedASR: Local Speech Recognition',
                content: `
                    <p>The workflow begins with <strong>highly reliable MedASR</strong>, running locally to protect sensitive data.</p>
                    <div class="popup-grid">
                        <div class="popup-card">
                            <i class="ph ph-shield-check"></i>
                            <strong>Privacy Protected</strong>
                            <span>Voice biometrics stay local</span>
                        </div>
                        <div class="popup-card">
                            <i class="ph ph-lightning"></i>
                            <strong>Low Latency</strong>
                            <span>Real-time transcription</span>
                        </div>
                        <div class="popup-card">
                            <i class="ph ph-wifi-slash"></i>
                            <strong>Always Available</strong>
                            <span>Works offline</span>
                        </div>
                        <div class="popup-card">
                            <i class="ph ph-stethoscope"></i>
                            <strong>Medical Tuned</strong>
                            <span>58-82% better accuracy</span>
                        </div>
                    </div>
                `
            },
            medgemma: {
                title: 'MedGemma: Clinical Entity Extraction',
                content: `
                    <p>MedGemma structures clinical information, deployable <strong>on-prem or cloud</strong> based on your requirements.</p>
                    <div class="popup-grid">
                        <div class="popup-card">
                            <i class="ph ph-buildings"></i>
                            <strong>On-Premises</strong>
                            <span>Maximum privacy & data sovereignty</span>
                        </div>
                        <div class="popup-card">
                            <i class="ph ph-cloud"></i>
                            <strong>Cloud</strong>
                            <span>Elastic scaling & high availability</span>
                        </div>
                    </div>
                    <p style="margin-top: var(--spacing-sm);"><strong>Extracts:</strong> Conditions, medications, allergies, vitals, labs, family history, social history, orders</p>
                `
            },
            deterministic: {
                title: 'Deterministic Enhancement',
                content: `
                    <p>AI outputs are enhanced by <strong>proven deterministic methods</strong> for coding accuracy.</p>
                    <div class="popup-list">
                        <div class="popup-list-item">
                            <i class="ph ph-magnifying-glass"></i>
                            <span><strong>ICD-10 Lookup</strong> - Fuzzy matching against verified code database</span>
                        </div>
                        <div class="popup-list-item">
                            <i class="ph ph-brackets-square"></i>
                            <span><strong>Transcript Markers</strong> - Extract from [SUBJECTIVE], [PLAN] sections</span>
                        </div>
                        <div class="popup-list-item">
                            <i class="ph ph-check-circle"></i>
                            <span><strong>Validation</strong> - Filter placeholders, normalize values</span>
                        </div>
                    </div>
                    <p style="margin-top: var(--spacing-sm); color: var(--color-success); font-size: 0.75rem;">
                        <i class="ph ph-check-circle"></i> Fast, reliable, no API costs, works offline
                    </p>
                `
            },
            clinician: {
                title: 'Clinician Review & Correction',
                content: `
                    <p>Clinicians have <strong>full control</strong> to correct, enhance, and validate all extracted data.</p>
                    <div class="popup-list">
                        <div class="popup-list-item">
                            <i class="ph ph-microphone"></i>
                            <span><strong>Re-record</strong> - Voice-correct any field with MedASR</span>
                        </div>
                        <div class="popup-list-item">
                            <i class="ph ph-x-circle"></i>
                            <span><strong>Reject</strong> - Remove incorrect extractions</span>
                        </div>
                        <div class="popup-list-item">
                            <i class="ph ph-pencil"></i>
                            <span><strong>Edit</strong> - Inline editing of any content</span>
                        </div>
                        <div class="popup-list-item">
                            <i class="ph ph-plus-circle"></i>
                            <span><strong>Add</strong> - Manually add missed items</span>
                        </div>
                        <div class="popup-list-item">
                            <i class="ph ph-checks"></i>
                            <span><strong>Approve</strong> - Explicit approval before submission</span>
                        </div>
                    </div>
                `
            },
            fhir: {
                title: 'FHIR R4 Interoperability',
                content: `
                    <p>All data is bundled into <strong>FHIR R4 format</strong> for seamless integration with modern healthcare systems.</p>
                    <div class="popup-badges">
                        <div class="popup-badge">Patient</div>
                        <div class="popup-badge">Condition</div>
                        <div class="popup-badge">Observation</div>
                        <div class="popup-badge">MedicationRequest</div>
                        <div class="popup-badge">AllergyIntolerance</div>
                        <div class="popup-badge">Procedure</div>
                        <div class="popup-badge">ServiceRequest</div>
                        <div class="popup-badge">FamilyMemberHistory</div>
                    </div>
                    <p style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--color-text-secondary);">
                        <i class="ph ph-globe"></i> Compatible with Epic, Cerner, athenahealth, and other FHIR-enabled systems
                    </p>
                `
            }
        };

        function openAboutModal() {
            const modal = document.getElementById('aboutModal');
            modal.classList.add('visible');
            closePipelinePopup();
        }

        function closeAboutModal() {
            const modal = document.getElementById('aboutModal');
            modal.classList.remove('visible');
            closePipelinePopup();
        }

        // Ground Truth Modal
        let groundTruthData = null;

        async function openGroundTruthModal() {
            const modal = document.getElementById('groundTruthModal');
            modal.classList.add('visible');

            // Load ground truth data if not already loaded
            if (!groundTruthData) {
                await loadGroundTruthData();
            } else {
                renderGroundTruthList();
            }
        }

        function closeGroundTruthModal() {
            const modal = document.getElementById('groundTruthModal');
            modal.classList.remove('visible');
        }

        async function loadGroundTruthData() {
            const listEl = document.getElementById('groundTruthList');
            const statsEl = document.getElementById('groundTruthStats');

            try {
                const response = await fetch('../test/fixtures/ground-truth.json');
                if (!response.ok) {
                    throw new Error(`Failed to load ground truth: ${response.status}`);
                }
                groundTruthData = await response.json();
                renderGroundTruthList();
            } catch (error) {
                console.error('Error loading ground truth:', error);
                listEl.innerHTML = `
                    <div class="loading-spinner" style="color: var(--color-error);">
                        <i class="ph ph-warning"></i>
                        Failed to load ground truth data: ${error.message}
                    </div>
                `;
                statsEl.textContent = '';
            }
        }

        function renderGroundTruthList() {
            const listEl = document.getElementById('groundTruthList');
            const statsEl = document.getElementById('groundTruthStats');

            if (!groundTruthData || !groundTruthData.state || !groundTruthData.state.reviewPool) {
                listEl.innerHTML = '<div class="loading-spinner">No ground truth data available</div>';
                return;
            }

            const pool = groundTruthData.state.reviewPool;

            // Workflow icons
            const workflowIcons = {
                general: 'stethoscope',
                soap: 'note',
                hp: 'clipboard-text',
                emergency: 'siren',
                intake: 'user-plus',
                followup: 'arrow-counter-clockwise',
                procedure: 'scissors',
                discharge: 'sign-out',
                radiology: 'x-ray',
                lab_review: 'test-tube',
                respiratory: 'lungs',
                icu: 'heartbeat',
                cardiology: 'heart',
                neurology: 'brain',
                pediatrics: 'baby'
            };

            listEl.innerHTML = pool.map((item, index) => {
                const ed = item.extractedData || {};
                const condCount = (ed.conditions || []).length;
                const medCount = (ed.medications || []).length;
                const vitalCount = (ed.vitals || []).length;
                const orders = ed.orders || {};
                const orderCount = (orders.medications || []).length +
                                   (orders.labs || []).length +
                                   (orders.consults || []).length +
                                   (orders.procedures || []).length;

                const icon = workflowIcons[item.workflow] || 'file-text';

                return `
                    <div class="ground-truth-item" onclick="loadGroundTruthItem(${index})">
                        <div class="ground-truth-item-icon">
                            <i class="ph ph-${icon}"></i>
                        </div>
                        <div class="ground-truth-item-info">
                            <div class="ground-truth-item-title">${item.workflowName || item.workflow}</div>
                            <div class="ground-truth-item-meta">
                                <span><i class="ph ph-file"></i> ${item.filename}</span>
                            </div>
                        </div>
                        <div class="ground-truth-item-stats">
                            ${condCount ? `<span class="ground-truth-stat conditions">${condCount} cond</span>` : ''}
                            ${medCount ? `<span class="ground-truth-stat medications">${medCount} med</span>` : ''}
                            ${vitalCount ? `<span class="ground-truth-stat vitals">${vitalCount} vital</span>` : ''}
                            ${orderCount ? `<span class="ground-truth-stat orders">${orderCount} orders</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Calculate totals
            let totalCond = 0, totalMed = 0, totalVital = 0, totalOrders = 0;
            pool.forEach(item => {
                const ed = item.extractedData || {};
                totalCond += (ed.conditions || []).length;
                totalMed += (ed.medications || []).length;
                totalVital += (ed.vitals || []).length;
                const orders = ed.orders || {};
                totalOrders += (orders.medications || []).length +
                               (orders.labs || []).length +
                               (orders.consults || []).length +
                               (orders.procedures || []).length;
            });

            statsEl.textContent = `${pool.length} recordings | ${totalCond} conditions | ${totalMed} medications | ${totalVital} vitals | ${totalOrders} orders`;
        }

        function loadGroundTruthItem(index) {
            if (!groundTruthData || !groundTruthData.state || !groundTruthData.state.reviewPool) {
                showToast('Ground truth data not loaded', 'error');
                return;
            }

            const item = groundTruthData.state.reviewPool[index];
            if (!item) {
                showToast('Invalid ground truth item', 'error');
                return;
            }

            // Create a review pool item from ground truth
            const reviewItem = {
                id: item.id || `gt-${Date.now()}`,
                workflow: item.workflow,
                workflowName: item.workflowName,
                filename: `[Ground Truth] ${item.filename}`,
                audioBlob: null, // No audio in ground truth
                transcript: item.transcript || '',
                fhirBundle: null,
                metrics: item.metrics || { transcriptionMs: 0, extractionMs: 0 },
                status: 'done',
                extractedData: item.extractedData,
                approved: {}
            };

            // Add to review pool
            state.reviewPool.push(reviewItem);
            state.currentReviewIndex = state.reviewPool.length - 1;

            // Update UI
            updateReviewPoolUI();
            displayCurrentReview();

            closeGroundTruthModal();
            showToast(`Loaded ground truth: ${item.workflowName || item.workflow}`, 'success');
        }

        const pipelineNodes = ['medasr', 'medgemma', 'deterministic', 'clinician', 'fhir'];
        let currentPipelineNode = 0;

        function showPipelinePopup(nodeId) {
            const popup = document.getElementById('pipelinePopup');
            const titleEl = document.getElementById('popupTitle');
            const contentEl = document.getElementById('popupContent');
            const counterEl = document.getElementById('popupCounter');
            const content = pipelineContent[nodeId];

            if (!content) return;

            // Track current node index
            currentPipelineNode = pipelineNodes.indexOf(nodeId);

            // Update active node styling
            document.querySelectorAll('.pipeline-node').forEach(node => {
                node.classList.toggle('active', node.dataset.node === nodeId);
            });

            titleEl.textContent = content.title;
            contentEl.innerHTML = content.content;
            counterEl.textContent = `${currentPipelineNode + 1} / ${pipelineNodes.length}`;

            // Update nav button states
            document.getElementById('popupPrevBtn').disabled = currentPipelineNode === 0;
            document.getElementById('popupNextBtn').disabled = currentPipelineNode === pipelineNodes.length - 1;

            popup.classList.add('visible');
        }

        function closePipelinePopup() {
            const popup = document.getElementById('pipelinePopup');
            popup.classList.remove('visible');
            document.querySelectorAll('.pipeline-node').forEach(node => {
                node.classList.remove('active');
            });
        }

        function prevPipelineNode() {
            if (currentPipelineNode > 0) {
                showPipelinePopup(pipelineNodes[currentPipelineNode - 1]);
            }
        }

        function nextPipelineNode() {
            if (currentPipelineNode < pipelineNodes.length - 1) {
                showPipelinePopup(pipelineNodes[currentPipelineNode + 1]);
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const aboutModal = document.getElementById('aboutModal');
            const apiGuideModal = document.getElementById('apiGuideModal');

            // About modal - arrow keys for popup navigation, escape to close
            if (aboutModal.classList.contains('visible')) {
                const popup = document.getElementById('pipelinePopup');
                if (popup.classList.contains('visible')) {
                    if (e.key === 'ArrowRight' || e.key === ' ') {
                        e.preventDefault();
                        nextPipelineNode();
                    } else if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        prevPipelineNode();
                    } else if (e.key === 'Escape') {
                        closePipelinePopup();
                    }
                } else if (e.key === 'Escape') {
                    closeAboutModal();
                }
                return;
            }

            // API Guide modal navigation
            if (apiGuideModal.classList.contains('visible')) {
                if (e.key === 'ArrowRight' || e.key === ' ') {
                    e.preventDefault();
                    nextApiSlide();
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    prevApiSlide();
                } else if (e.key === 'Escape') {
                    closeApiGuideModal();
                }
                return;
            }
        });

        // ============================================================================
        // API Guide Modal / Slideshow
        // ============================================================================
        let currentApiSlide = 1;
        const totalApiSlides = 7;

        function openApiGuideModal() {
            const modal = document.getElementById('apiGuideModal');
            modal.classList.add('visible');
            currentApiSlide = 1;
            updateApiSlideshow();
            initApiSlideDots();
        }

        function closeApiGuideModal() {
            const modal = document.getElementById('apiGuideModal');
            modal.classList.remove('visible');
        }

        function initApiSlideDots() {
            const dotsContainer = document.getElementById('apiSlideDots');
            dotsContainer.innerHTML = '';
            for (let i = 1; i <= totalApiSlides; i++) {
                const dot = document.createElement('div');
                dot.className = `slide-dot ${i === currentApiSlide ? 'active' : ''}`;
                dot.onclick = () => goToApiSlide(i);
                dotsContainer.appendChild(dot);
            }
        }

        function updateApiSlideshow() {
            // Update slides
            document.querySelectorAll('.api-slide').forEach(slide => {
                slide.classList.remove('active');
                if (parseInt(slide.dataset.apiSlide) === currentApiSlide) {
                    slide.classList.add('active');
                }
            });

            // Update dots
            document.querySelectorAll('#apiSlideDots .slide-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index + 1 === currentApiSlide);
            });

            // Update counter
            document.getElementById('currentApiSlideNum').textContent = currentApiSlide;
            document.getElementById('totalApiSlideNum').textContent = totalApiSlides;

            // Update nav buttons
            document.getElementById('prevApiSlideBtn').disabled = currentApiSlide === 1;
            document.getElementById('nextApiSlideBtn').disabled = currentApiSlide === totalApiSlides;
        }

        function nextApiSlide() {
            if (currentApiSlide < totalApiSlides) {
                currentApiSlide++;
                updateApiSlideshow();
            }
        }

        function prevApiSlide() {
            if (currentApiSlide > 1) {
                currentApiSlide--;
                updateApiSlideshow();
            }
        }

        function goToApiSlide(slideNum) {
            currentApiSlide = slideNum;
            updateApiSlideshow();
        }

        // ============================================================================
        // Mock EHR
        // ============================================================================
        function loadMockEHR() {
            const stored = localStorage.getItem('mockEHR');
            if (stored) {
                state.mockEHR = JSON.parse(stored);
                renderMockEHR();
            }
        }

        function saveMockEHR() {
            localStorage.setItem('mockEHR', JSON.stringify(state.mockEHR));
        }

        // Convert item to expected JSON format for comparison
        function itemToExpectedFormat(item) {
            const data = item.extractedData || {};
            const baseFilename = item.filename?.replace(/\.(webm|wav|mp3|weba|m4a|ogg)$/i, '') || item.workflow;

            return {
                metadata: {
                    script_file: item.filename || `${item.workflow}.webm`,
                    workflow: item.workflow,
                    description: `Extracted from ${item.filename || 'recording'}`,
                    processed_at: new Date().toISOString(),
                    metrics: item.metrics || null
                },
                patient: data.patient ? {
                    name: data.patient.name || null,
                    age: data.patient.age || null,
                    gender: data.patient.gender || null,
                    date_of_birth: data.patient.dateOfBirth || null
                } : null,
                ehr_data: {
                    transcript: item.transcript || null,
                    chief_complaint: data.chiefComplaint || null,
                    conditions: (data.conditions || []).map(c => ({
                        name: c.name,
                        icd10: c.icd10 || null,
                        status: c.status || 'active',
                        severity: c.severity || null
                    })),
                    vitals: (data.vitals || []).map(v => ({
                        type: v.type || v.name,  // entities uses 'type', FHIR extraction uses 'name'
                        value: v.value,
                        unit: v.unit || null
                    })),
                    allergies: (data.allergies || []).map(a => ({
                        substance: a.substance,
                        reaction: a.reaction || null,
                        severity: a.severity || null
                    })),
                    medications: (data.medications || []).filter(m => !m.isNewOrder).map(m => ({
                        name: m.name,
                        dose: m.dose || null,
                        frequency: m.frequency || null,
                        route: m.route || null
                    })),
                    family_history: (data.familyHistory || []).map(fh => ({
                        relationship: fh.relationship,
                        condition: fh.condition,
                        age_of_onset: fh.ageOfOnset || null,
                        deceased: fh.deceased || null
                    })),
                    social_history: data.socialHistory ? {
                        tobacco: data.socialHistory.tobacco || null,
                        alcohol: data.socialHistory.alcohol || null,
                        drugs: data.socialHistory.drugs || null,
                        occupation: data.socialHistory.occupation || null,
                        living_situation: data.socialHistory.livingSituation || null
                    } : null,
                    lab_results: (data.labResults || []).map(l => ({
                        name: l.name,
                        value: l.value || null,
                        unit: (l.unit && l.unit !== 'null') ? l.unit : null,
                        interpretation: (l.interpretation && l.interpretation !== 'null') ? l.interpretation : null
                    }))
                },
                orders: {
                    transcript: item.transcript || null,
                    medication_orders: (data.orders?.medications || []).map(m => ({
                        name: m.name,
                        dose: m.dose || null,
                        frequency: m.frequency || null,
                        route: m.route || null,
                        duration: m.duration || null,
                        instructions: m.instructions || null
                    })),
                    lab_orders: (data.orders?.labs || []).map(l => ({
                        name: l.name,
                        loinc: l.loinc || null
                    })),
                    referral_orders: (data.orders?.consults || []).map(r => ({
                        specialty: r.specialty,
                        reason: r.reason || null
                    })),
                    procedure_orders: (data.orders?.procedures || []).map(p => ({
                        name: p.name
                    })),
                    imaging_orders: (data.orders?.imaging || []).map(i => ({
                        name: i.name
                    }))
                }
            };
        }

        function exportAllResults() {
            if (state.reviewPool.length === 0) {
                showToast('No results to export', 'warning');
                return;
            }

            const exportData = {
                exportedAt: new Date().toISOString(),
                totalItems: state.reviewPool.length,
                summary: {
                    successful: state.reviewPool.filter(i => i.status === 'done').length,
                    failed: state.reviewPool.filter(i => i.status === 'error').length,
                    workflows: [...new Set(state.reviewPool.map(i => i.workflow))]
                },
                results: state.reviewPool.map(item => itemToExpectedFormat(item))
            };

            // Create and download JSON file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voice-to-fhir-results-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast(`Exported ${state.reviewPool.length} results`, 'success');
        }

        function exportIndividualResults() {
            if (state.reviewPool.length === 0) {
                showToast('No results to export', 'warning');
                return;
            }

            // Export each result as a separate file
            const successfulItems = state.reviewPool.filter(i => i.status === 'done');

            if (successfulItems.length === 0) {
                showToast('No successful results to export', 'warning');
                return;
            }

            // Create a zip-like structure by downloading each file
            // For simplicity, we'll use a small delay between downloads
            let exported = 0;

            successfulItems.forEach((item, index) => {
                setTimeout(() => {
                    const exportData = itemToExpectedFormat(item);
                    const baseFilename = item.filename?.replace(/\.(webm|wav|mp3|weba|m4a|ogg)$/i, '') || item.workflow;

                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${baseFilename}.actual.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    exported++;
                    if (exported === successfulItems.length) {
                        showToast(`Exported ${exported} individual files`, 'success');
                    }
                }, index * 200); // 200ms delay between downloads
            });
        }

        function submitToMockEHR() {
            if (state.currentReviewIndex < 0) return;

            const item = state.reviewPool[state.currentReviewIndex];
            if (!item) return;

            // Create a record with only approved items
            const record = {
                id: generateId(),
                submittedAt: new Date().toISOString(),
                workflow: item.workflowName,
                transcript: item.transcript,
                fhirBundle: item.fhirBundle,
                approvedData: {
                    conditions: item.extractedData.conditions.filter(c => c.approved === true),
                    medications: item.extractedData.medications.filter(m => m.approved === true),
                    allergies: item.extractedData.allergies.filter(a => a.approved === true),
                    vitals: item.extractedData.vitals.filter(v => v.approved === true),
                    labResults: item.extractedData.labResults.filter(l => l.approved === true),
                    orders: {
                        medications: item.extractedData.orders.medications.filter(o => o.approved === true),
                        labs: item.extractedData.orders.labs.filter(o => o.approved === true),
                        consults: item.extractedData.orders.consults.filter(o => o.approved === true),
                        procedures: item.extractedData.orders.procedures.filter(o => o.approved === true)
                    }
                }
            };

            state.mockEHR.push(record);
            saveMockEHR();

            // Remove from review pool
            state.reviewPool.splice(state.currentReviewIndex, 1);
            state.currentReviewIndex = Math.max(0, state.currentReviewIndex - 1);

            if (state.reviewPool.length === 0) {
                state.currentReviewIndex = -1;
            }

            updateReviewPoolUI();
            renderCurrentReview();
            renderMockEHR();

            showToast('Submitted to Mock EHR', 'success');
        }

        function renderMockEHR() {
            elements.viewEhrBundleBtn.disabled = state.mockEHR.length === 0;

            if (state.mockEHR.length === 0) {
                elements.mockEhrList.innerHTML = `
                    <div class="mock-ehr-empty">
                        <i class="ph ph-hospital"></i>
                        <p>No records submitted</p>
                    </div>
                `;
                return;
            }

            elements.mockEhrList.innerHTML = state.mockEHR.map(record => {
                const time = new Date(record.submittedAt).toLocaleTimeString();
                const itemCount = Object.values(record.approvedData)
                    .flat()
                    .filter(i => i && typeof i === 'object' && !Array.isArray(i)).length +
                    Object.values(record.approvedData.orders).flat().length;

                return `
                    <div class="mock-ehr-item" data-id="${record.id}">
                        <div class="mock-ehr-item-header">
                            <span class="mock-ehr-item-workflow">${record.workflow}</span>
                            <span class="mock-ehr-item-time">${time}</span>
                        </div>
                        <div class="mock-ehr-item-stats">
                            ${itemCount} approved items
                        </div>
                    </div>
                `;
            }).join('');
        }

        function clearMockEHR() {
            if (confirm('Clear all Mock EHR records?')) {
                state.mockEHR = [];
                localStorage.removeItem('mockEHR');
                renderMockEHR();
                showToast('Mock EHR cleared', 'success');
            }
        }

        function viewEhrBundle() {
            if (state.mockEHR.length === 0) return;

            const bundles = state.mockEHR.map(r => r.fhirBundle);
            const json = JSON.stringify(bundles, null, 2);

            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                <head><title>FHIR Bundles</title></head>
                <body style="margin:0;padding:20px;font-family:monospace;background:#1a1a1a;color:#fff;">
                    <pre style="white-space:pre-wrap;">${json}</pre>
                </body>
                </html>
            `);
        }

        // ============================================================================
        // Event Listeners
        // ============================================================================
        function initEventListeners() {
            // Record button
            elements.recordBtn.addEventListener('click', () => {
                if (state.isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

            // File upload
            elements.uploadSection.addEventListener('click', () => {
                elements.fileInput.click();
            });

            elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    setCurrentAudio(file, file.name);
                }
                e.target.value = '';
            });

            // Batch upload
            const batchFileInput = document.getElementById('batchFileInput');
            const batchUploadBtn = document.getElementById('batchUploadBtn');

            batchUploadBtn.addEventListener('click', () => {
                batchFileInput.click();
            });

            batchFileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    batchAddToQueue(files);
                }
                e.target.value = '';
            });

            // Drag and drop
            elements.uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadSection.style.borderColor = 'var(--color-primary-blue)';
            });

            elements.uploadSection.addEventListener('dragleave', () => {
                elements.uploadSection.style.borderColor = '';
            });

            elements.uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadSection.style.borderColor = '';
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('audio/'));
                if (files.length > 1) {
                    // Multiple files - batch add to queue
                    batchAddToQueue(files);
                } else if (files.length === 1) {
                    // Single file - use existing behavior
                    setCurrentAudio(files[0], files[0].name);
                }
            });

            // Download audio
            elements.downloadAudioBtn.addEventListener('click', downloadCurrentAudio);

            // Clear audio
            elements.clearAudioBtn.addEventListener('click', clearCurrentAudio);

            // Workflow change
            elements.workflowSelect.addEventListener('change', updateAddToQueueButton);

            // Add to queue
            elements.addToQueueBtn.addEventListener('click', addToQueue);

            // Parallel toggle
            elements.parallelToggle.addEventListener('click', () => {
                state.parallelMode = !state.parallelMode;
                elements.parallelToggle.classList.toggle('active', state.parallelMode);
            });

            // Process queue
            elements.processQueueBtn.addEventListener('click', processQueue);

            // Clear queue
            elements.clearQueueBtn.addEventListener('click', clearQueue);

            // Review item select
            elements.reviewItemSelect.addEventListener('change', (e) => {
                state.currentReviewIndex = parseInt(e.target.value);
                renderCurrentReview();
                renderQueue(); // Update queue selection indicator
            });

            // Tab switching
            document.querySelectorAll('.review-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.review-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.review-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}Content`).classList.add('active');
                });
            });

            // Export results
            document.getElementById('exportResultsBtn').addEventListener('click', exportAllResults);
            document.getElementById('exportIndividualBtn').addEventListener('click', exportIndividualResults);

            // Submit to EHR
            elements.submitToEhrBtn.addEventListener('click', submitToMockEHR);

            // View bundle
            elements.viewEhrBundleBtn.addEventListener('click', viewEhrBundle);

            // Clear EHR
            elements.clearEhrBtn.addEventListener('click', clearMockEHR);

            // Play original audio button
            const transcriptAudioPlayer = document.getElementById('transcriptAudioPlayer');
            const playTranscriptAudioBtn = document.getElementById('playTranscriptAudio');

            playTranscriptAudioBtn.addEventListener('click', () => {
                if (transcriptAudioPlayer.paused) {
                    transcriptAudioPlayer.play();
                    playTranscriptAudioBtn.querySelector('i').className = 'ph ph-stop-circle';
                    playTranscriptAudioBtn.style.opacity = '1';
                } else {
                    transcriptAudioPlayer.pause();
                    transcriptAudioPlayer.currentTime = 0;
                    playTranscriptAudioBtn.querySelector('i').className = 'ph ph-speaker-high';
                    playTranscriptAudioBtn.style.opacity = '0.6';
                }
            });

            transcriptAudioPlayer.addEventListener('ended', () => {
                playTranscriptAudioBtn.querySelector('i').className = 'ph ph-speaker-high';
                playTranscriptAudioBtn.style.opacity = '0.6';
            });

            // EHR tab audio player
            const ehrAudioPlayer = document.getElementById('ehrTranscriptAudioPlayer');
            const playEhrAudioBtn = document.getElementById('playEhrTranscriptAudio');

            playEhrAudioBtn.addEventListener('click', () => {
                if (ehrAudioPlayer.paused) {
                    ehrAudioPlayer.play();
                    playEhrAudioBtn.querySelector('i').className = 'ph ph-stop-circle';
                    playEhrAudioBtn.style.opacity = '1';
                } else {
                    ehrAudioPlayer.pause();
                    ehrAudioPlayer.currentTime = 0;
                    playEhrAudioBtn.querySelector('i').className = 'ph ph-speaker-high';
                    playEhrAudioBtn.style.opacity = '0.6';
                }
            });

            ehrAudioPlayer.addEventListener('ended', () => {
                playEhrAudioBtn.querySelector('i').className = 'ph ph-speaker-high';
                playEhrAudioBtn.style.opacity = '0.6';
            });

            // Orders tab audio player
            const ordersAudioPlayer = document.getElementById('ordersTranscriptAudioPlayer');
            const playOrdersAudioBtn = document.getElementById('playOrdersTranscriptAudio');

            playOrdersAudioBtn.addEventListener('click', () => {
                if (ordersAudioPlayer.paused) {
                    ordersAudioPlayer.play();
                    playOrdersAudioBtn.querySelector('i').className = 'ph ph-stop-circle';
                    playOrdersAudioBtn.style.opacity = '1';
                } else {
                    ordersAudioPlayer.pause();
                    ordersAudioPlayer.currentTime = 0;
                    playOrdersAudioBtn.querySelector('i').className = 'ph ph-speaker-high';
                    playOrdersAudioBtn.style.opacity = '0.6';
                }
            });

            ordersAudioPlayer.addEventListener('ended', () => {
                playOrdersAudioBtn.querySelector('i').className = 'ph ph-speaker-high';
                playOrdersAudioBtn.style.opacity = '0.6';
            });

            // About modal
            document.getElementById('aboutBtn').addEventListener('click', openAboutModal);
            document.getElementById('aboutModal').addEventListener('click', (e) => {
                if (e.target.id === 'aboutModal') {
                    closeAboutModal();
                }
            });
            // Close pipeline popup when clicking outside it (but inside the modal)
            document.querySelector('.pipeline-container')?.addEventListener('click', (e) => {
                // Don't close if clicking on a node or inside the popup
                if (!e.target.closest('.pipeline-node') && !e.target.closest('.pipeline-popup')) {
                    closePipelinePopup();
                }
            });

            // Ground Truth modal
            document.getElementById('groundTruthBtn').addEventListener('click', openGroundTruthModal);
            document.getElementById('groundTruthModal').addEventListener('click', (e) => {
                if (e.target.id === 'groundTruthModal') {
                    closeGroundTruthModal();
                }
            });

            // Export/Import
            document.getElementById('exportBtn').addEventListener('click', exportState);
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('importFileInput').click();
            });
            document.getElementById('importFileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importState(file);
                    e.target.value = ''; // Reset so same file can be imported again
                }
            });

            // API Guide - now opens external page via onclick handler

            // Settings modal
            elements.settingsBtn.addEventListener('click', openSettingsModal);
            elements.closeSettingsBtn.addEventListener('click', closeSettingsModal);
            elements.settingsModal.addEventListener('click', (e) => {
                if (e.target === elements.settingsModal) {
                    closeSettingsModal();
                }
            });

            // Add EHR Item Modal
            const addEhrModal = document.getElementById('addEhrItemModal');
            addEhrModal.addEventListener('click', (e) => {
                if (e.target === addEhrModal) {
                    closeAddEhrItemModal();
                }
            });

            // Edit Condition Modal
            const editConditionModal = document.getElementById('editConditionModal');
            editConditionModal.addEventListener('click', (e) => {
                if (e.target === editConditionModal) {
                    closeEditConditionModal();
                }
            });

            // Item type change listener (now handled by pill buttons via setAddEhrItemType)

            // Add Order Modal
            const addOrderModal = document.getElementById('addOrderModal');
            addOrderModal.addEventListener('click', (e) => {
                if (e.target === addOrderModal) {
                    closeAddOrderModal();
                }
            });

            // Order type change listener
            document.getElementById('addOrderType').addEventListener('change', updateAddOrderTextFields);

            // Settings inputs
            elements.hfTokenInput.addEventListener('input', debounce(async () => {
                const token = elements.hfTokenInput.value.trim();
                if (token) {
                    elements.tokenStatus.className = 'token-status checking';
                    elements.tokenStatus.innerHTML = '<i class="ph ph-spinner spinning"></i> Validating...';
                    const result = await validateHfToken(token);
                    elements.tokenStatus.className = `token-status ${result.valid ? 'valid' : 'invalid'}`;
                    elements.tokenStatus.innerHTML = `<i class="ph ph-${result.valid ? 'check-circle' : 'x-circle'}"></i> ${result.message}`;
                } else {
                    elements.tokenStatus.innerHTML = '';
                }
            }, 500));

            elements.saveSettingsBtn.addEventListener('click', async () => {
                settings.hfToken = elements.hfTokenInput.value.trim();
                settings.apiUrl = elements.apiUrlInput.value.trim() || DEFAULT_API_URL;
                settings.transcriptionBackend = elements.transcriptionBackendSelect.value;
                settings.medgemmaEndpoint = elements.medgemmaEndpointInput.value.trim() || DEFAULT_MEDGEMMA_ENDPOINT;
                saveSettings();
                updateSettingsButtonState();
                closeSettingsModal();
                showToast('Settings saved', 'success');

                // Reconnect with new settings
                checkApiHealth().then(ready => {
                    if (ready) loadWorkflows();
                });

                // Check endpoint status
                if (settings.medgemmaEndpoint) {
                    const result = await checkEndpointStatus(settings.medgemmaEndpoint);
                    updateEndpointStatusUI(result);
                }
            });

            // Endpoint input - check status on blur
            elements.medgemmaEndpointInput.addEventListener('blur', async () => {
                const endpoint = elements.medgemmaEndpointInput.value.trim();
                if (endpoint && settings.hfToken) {
                    elements.endpointStatus.className = 'endpoint-status checking';
                    elements.endpointStatus.innerHTML = '<i class="ph ph-spinner spinning"></i> Checking...';
                    const result = await checkEndpointStatus(endpoint);
                    elements.endpointStatus.className = `endpoint-status ${result.status}`;
                    const icon = result.status === 'running' ? 'check-circle' :
                                result.status === 'paused' ? 'pause-circle' :
                                result.status === 'error' ? 'x-circle' : 'cloud-slash';
                    elements.endpointStatus.innerHTML = `<i class="ph ph-${icon}"></i> ${result.message}`;
                }
            });

            elements.clearSettingsBtn.addEventListener('click', () => {
                if (confirm('Clear all settings including HuggingFace token?')) {
                    clearSettings();
                    populateSettingsModal();
                    updateSettingsButtonState();
                    elements.headerEndpointStatus.style.display = 'none';
                    showToast('Settings cleared', 'success');
                }
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function openSettingsModal() {
            populateSettingsModal();
            elements.settingsModal.classList.add('visible');
        }

        function closeSettingsModal() {
            elements.settingsModal.classList.remove('visible');
        }

        async function populateSettingsModal() {
            elements.hfTokenInput.value = settings.hfToken;
            elements.apiUrlInput.value = settings.apiUrl;
            elements.transcriptionBackendSelect.value = settings.transcriptionBackend;
            elements.medgemmaEndpointInput.value = settings.medgemmaEndpoint;

            // Show token status if token exists
            if (settings.hfToken) {
                elements.tokenStatus.className = 'token-status valid';
                elements.tokenStatus.innerHTML = '<i class="ph ph-check-circle"></i> Token configured';
            } else {
                elements.tokenStatus.innerHTML = '';
            }

            // Check endpoint status if configured
            if (settings.medgemmaEndpoint && settings.hfToken) {
                elements.endpointStatus.className = 'endpoint-status checking';
                elements.endpointStatus.innerHTML = '<i class="ph ph-spinner spinning"></i> Checking...';
                const result = await checkEndpointStatus(settings.medgemmaEndpoint);
                elements.endpointStatus.className = `endpoint-status ${result.status}`;
                const icon = result.status === 'running' ? 'check-circle' :
                            result.status === 'paused' ? 'pause-circle' :
                            result.status === 'error' ? 'x-circle' : 'cloud-slash';
                elements.endpointStatus.innerHTML = `<i class="ph ph-${icon}"></i> ${result.message}`;
            } else if (settings.medgemmaEndpoint) {
                elements.endpointStatus.className = 'endpoint-status';
                elements.endpointStatus.innerHTML = '<i class="ph ph-info"></i> Add HF token to check status';
            } else {
                elements.endpointStatus.innerHTML = '';
            }
        }

        function updateSettingsButtonState() {
            if (settings.hfToken) {
                elements.settingsBtn.classList.add('configured');
                elements.settingsBtn.innerHTML = '<i class="ph ph-gear"></i> Configured';
            } else {
                elements.settingsBtn.classList.remove('configured');
                elements.settingsBtn.innerHTML = '<i class="ph ph-gear"></i> Settings';
            }
        }

        // ============================================================================
        // Initialization
        // ============================================================================
        async function init() {
            restoreCollapsedStates();
            initVisualizer();
            initEventListeners();
            loadMockEHR();
            updateSettingsButtonState();

            // Check API and load workflows
            const apiReady = await checkApiHealth();
            // Always try to load workflows, even if health check fails
            await loadWorkflows();

            // Check MedGemma endpoint status
            if (settings.medgemmaEndpoint && settings.hfToken) {
                const result = await checkEndpointStatus(settings.medgemmaEndpoint);
                updateEndpointStatusUI(result);
            }

            // Show settings prompt if no HF token configured
            if (!settings.hfToken) {
                setTimeout(() => {
                    showToast('Configure HuggingFace token in Settings for full functionality', 'info');
                }, 1500);
            }

            // Periodic health checks
            setInterval(checkApiHealth, 30000);

            // Periodic endpoint status check (every 60 seconds)
            setInterval(async () => {
                if (settings.medgemmaEndpoint && settings.hfToken) {
                    const result = await checkEndpointStatus(settings.medgemmaEndpoint);
                    updateEndpointStatusUI(result);
                }
            }, 60000);
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
